<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Notes - Notes-U</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/variables.css">
<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/app.css">
<link rel="stylesheet" href="../css/upload.css">
<style>
.upload-shell {
  max-width: 860px;
  margin: 50px auto 90px;
  padding: var(--space-8) var(--space-7) var(--space-7);
  background: linear-gradient(145deg,var(--color-surface),var(--color-surface-alt) 140%);
  border:1px solid var(--color-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  gap: var(--space-6);
  animation: fadeIn .6s var(--ease);
  position:relative;
  overflow:hidden;
}

.upload-shell::before {
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 24% 18%, rgba(255,255,255,0.45), transparent 60%),
    radial-gradient(circle at 80% 82%, rgba(255,255,255,0.30), transparent 68%);
  opacity:.4;
  pointer-events:none;
  mix-blend-mode:overlay;
}
body.dark .upload-shell::before {
  background:
    radial-gradient(circle at 30% 22%, rgba(255,255,255,0.10), transparent 60%),
    radial-gradient(circle at 74% 78%, rgba(255,255,255,0.08), transparent 70%);
  opacity:.75;
}

.upload-head {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.upload-head h1 {
  margin:0;
  font-size:1.95rem;
  letter-spacing:-.6px;
}
.upload-head p {
  margin:0;
  font-size:.9rem;
  line-height:1.45;
  color: var(--color-text-soft);
}

.form-grid {
  display:grid;
  gap: 24px 28px;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  align-items:start;
}

.inline-hint {
  font-size:.6rem;
  letter-spacing:.4px;
  color: var(--color-text-faint);
}

.action-row {
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

</style>
</head>
<body class="theming-prep">
<div class="upload-shell">
  <div class="upload-head">
    <h1>Upload Notes</h1>
    <p>Share knowledge by uploading study materials for your courses.</p>
  </div>

  <form id="uploadForm" novalidate>
    <div class="form-grid">
      <div class="field">
        <label class="n-label" for="academicYearSelect">Academic Year *</label>
        <select id="academicYearSelect" required>
          <option value="">Select Year</option>
          <option value="year1">Year 1</option>
          <option value="year2">Year 2</option>
        </select>
        <div class="form-error" id="academicYearSelectError"></div>
      </div>
      <div class="field">
        <label class="n-label" for="semesterSelect">Semester *</label>
        <select id="semesterSelect" required disabled>
          <option value="">Select Semester</option>
        </select>
        <div class="form-error" id="semesterSelectError"></div>
      </div>
      <div class="field">
        <label class="n-label" for="subjectSelect">Subject *</label>
        <select id="subjectSelect" required disabled>
          <option value="">Select Subject</option>
        </select>
        <div class="form-error" id="subjectSelectError"></div>
      </div>
      <div class="field">
        <label class="n-label" for="notesType">Type *</label>
        <select id="notesType" required>
          <option value="">Select Type</option>
          <option value="lecture_notes">Lecture Notes</option>
          <option value="tutorial_solutions">Tutorial Solutions</option>
          <option value="past_year_papers">Past Year Papers</option>
        </select>
        <div class="form-error" id="notesTypeError"></div>
      </div>
    </div>

    <div class="field">
      <label class="n-label" for="description">Description (Optional)</label>
      <textarea id="description" placeholder="Brief description..."></textarea>
    </div>

    <div class="field">
      <label class="n-label">File *</label>
      <input type="file" id="fileUpload" hidden accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.odt,.ods,.odp,.rtf">
      <div id="fileDrop" class="file-drop" tabindex="0" role="button" aria-label="Upload file area">
        <p style="margin:0 0 6px;font-size:.85rem;font-weight:600;">Drag & Drop or click to select a file</p>
        <small style="display:block;font-size:.65rem;letter-spacing:.4px;opacity:.75;">PDF, DOC(X), PPT(X), TXT, ODT/ODS/ODP, RTF (Max 25MB)</small>
        <div id="fileOk" class="file-pill" style="display:none;"></div>
      </div>
      <div class="form-error" id="fileUploadError"></div>
    </div>

    <div class="action-row">
      <button type="button" id="cancelBtn" class="btn secondary">Cancel</button>
      <button type="submit" class="btn" id="uploadBtn"><span class="btn-text">Upload</span></button>
    </div>
    <div id="uploadStatus" class="inline-status" aria-live="polite"></div>
  </form>
</div>

<a href="home.html" class="fab" aria-label="Back to Home">
  <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="1.9" fill="none">
    <path d="M12 5v14"/>
    <path d="M5 12h14"/>
  </svg>
  Home
</a>

<script type="module">
import { onAuth, createNote } from './firebase-init.js';

/* Theme init */
function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme);
  localStorage.setItem('theme', theme);
}
(function initTheme(){
  const stored = localStorage.getItem('theme');
  applyTheme(stored || (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  document.body.classList.remove('theming-prep');
})();

/* Back Guards */
function installBackGuards(){
  window.addEventListener('pageshow', e=>{
    if ((e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward') && !window.__currentUser) {
      location.replace('auth.html?login');
    }
  });
  history.replaceState({ protected:true }, '', location.href);
  window.addEventListener('popstate', ()=>{
    if(!window.__currentUser) location.replace('auth.html?login');
  });
}
installBackGuards();

onAuth(user=>{
  window.__currentUser = user || null;
  if(!user){
    location.replace('auth.html?login');
  }
});

/* Subjects Data */
const subjectsData = {
  year1:{
    semester1:[
      {code:'AMCS1013',name:'Problem Solving and Programming'},
      {code:'AMCS1113',name:'Computer Architecture'},
      {code:'AMIT1303',name:'Introduction to Interface Design'},
      {code:'AMMS1623',name:'Calculus and Algebra'},
      {code:'AJEL1713',name:'English for Tertiary Studies'},
      {code:'MPU2302',name:'Integrity and Anti-Corruption'},
      {code:'MPU2123',name:'Penghayatan Etika dan Peradaban'}
    ],
    semester2:[
      {code:'AMCS1043',name:'Database Development and Applications'},
      {code:'AMCS1034',name:'Software Development Fundamentals'},
      {code:'AMMS2613',name:'Probability and Statistics'}
    ],
    semester3:[
      {code:'AMIT2034',name:'Fundamentals of Computer Networks'},
      {code:'AMCS2204',name:'Object-Oriented Programming Techniques'},
      {code:'AMCS2093',name:'Operating Systems'},
      {code:'AMIS1013',name:'Systems Analysis and Design'},
      {code:'AMMS2603',name:'Discrete Mathematics'},
      {code:'AJEL1723',name:'Academic English'}
    ]
  },
  year2:{
    semester1:[
      {code:'AMCS2034',name:'Introduction to Data Structures and Algorithms'},
      {code:'AMCS2123',name:'Systems and Programming Concepts'},
      {code:'AMCS2104',name:'Fundamentals of Artificial Intelligence'},
      {code:'AMIT3353',name:'Mobile Application Development'},
      {code:'AMIS1012',name:'Ethics in Computing'}
    ],
    semester2:[
      {code:'AMCS2094',name:'Mini Project'},
      {code:'AMCS2103',name:'Parallel and Distributed Computing'},
      {code:'AMIS1003',name:'Introduction to Cybersecurity'}
    ],
    semester3:[
      {code:'AMIT320A',name:'Industrial Training'}
    ]
  }
};

/* Elements */
const academicYearSelect = document.getElementById('academicYearSelect');
const semesterSelect = document.getElementById('semesterSelect');
const subjectSelect = document.getElementById('subjectSelect');
const notesTypeSelect = document.getElementById('notesType');
const descriptionInput = document.getElementById('description');
const fileUpload = document.getElementById('fileUpload');
const fileDrop = document.getElementById('fileDrop');
const fileOk = document.getElementById('fileOk');
const uploadForm = document.getElementById('uploadForm');
const uploadBtn = document.getElementById('uploadBtn');
const cancelBtn = document.getElementById('cancelBtn');
const uploadStatus = document.getElementById('uploadStatus');

const requiredFields = [
  { id:'academicYearSelect', msg:'Select an academic year.' },
  { id:'semesterSelect', msg:'Select a semester.' },
  { id:'subjectSelect', msg:'Select a subject.' },
  { id:'notesType', msg:'Select a notes type.' },
  { id:'fileUpload', msg:'A file is required.' }
];

function showError(id,msg){
  const el = document.getElementById(id+'Error');
  if(!el) return;
  el.textContent = msg || '';
}

function validate(scrollFirst=false){
  let ok = true;
  let firstBad = null;
  for(const f of requiredFields){
    if(f.id==='fileUpload'){
      if(fileUpload.files.length===0){
        showError(f.id, f.msg);
        ok=false;
        if(!firstBad) firstBad = fileDrop;
      } else showError(f.id,'');
    } else {
      const val = document.getElementById(f.id).value;
      if(!val){
        showError(f.id, f.msg);
        ok=false;
        if(!firstBad) firstBad=document.getElementById(f.id);
      } else showError(f.id,'');
    }
  }
  uploadBtn.disabled = !ok;
  if(scrollFirst && firstBad){
    firstBad.scrollIntoView({ behavior:'smooth', block:'center' });
  }
  return ok;
}

function populateSemesters(){
  semesterSelect.innerHTML = '<option value="">Select Semester</option>';
  subjectSelect.innerHTML = '<option value="">Select Subject</option>';
  semesterSelect.disabled = true;
  subjectSelect.disabled = true;
  const y = academicYearSelect.value;
  if(y && subjectsData[y]){
    Object.keys(subjectsData[y]).forEach(sem=>{
      const opt = document.createElement('option');
      opt.value = sem;
      opt.textContent = sem.replace('semester','Semester ');
      semesterSelect.appendChild(opt);
    });
    semesterSelect.disabled = false;
  }
  validate();
}

function populateSubjects(){
  subjectSelect.innerHTML = '<option value="">Select Subject</option>';
  subjectSelect.disabled = true;
  const y = academicYearSelect.value;
  const s = semesterSelect.value;
  if(y && s && subjectsData[y] && subjectsData[y][s]){
    subjectsData[y][s].forEach(sub=>{
      const opt = document.createElement('option');
      opt.value = sub.code;
      opt.textContent = `${sub.code} - ${sub.name}`;
      subjectSelect.appendChild(opt);
    });
    subjectSelect.disabled = false;
  }
  validate();
}

function updateFileUI(file){
  if(file){
    fileOk.style.display = 'inline-flex';
    fileOk.textContent = `${file.name}  â€¢  ${(file.size/1024/1024).toFixed(2)} MB`;
  } else {
    fileOk.style.display = 'none';
    fileOk.textContent = '';
  }
  validate();
}

fileDrop.addEventListener('click', ()=> fileUpload.click());
fileDrop.addEventListener('keydown', e=>{
  if(e.key==='Enter' || e.key===' '){
    e.preventDefault();
    fileUpload.click();
  }
});
fileDrop.addEventListener('dragover', e=>{
  e.preventDefault();
  fileDrop.classList.add('dragover');
});
fileDrop.addEventListener('dragleave', ()=> fileDrop.classList.remove('dragover'));
fileDrop.addEventListener('drop', e=>{
  e.preventDefault();
  fileDrop.classList.remove('dragover');
  if(e.dataTransfer.files.length){
    fileUpload.files = e.dataTransfer.files;
    updateFileUI(fileUpload.files[0]);
  }
});
fileUpload.addEventListener('change', ()=> updateFileUI(fileUpload.files[0]||null));

academicYearSelect.addEventListener('change', populateSemesters);
semesterSelect.addEventListener('change', populateSubjects);
notesTypeSelect.addEventListener('change', ()=> validate());
descriptionInput.addEventListener('input', ()=> {});

document.addEventListener('DOMContentLoaded', ()=>{
  populateSemesters();
  populateSubjects();
  validate();
});

cancelBtn.addEventListener('click', ()=>{
  if(confirm('Cancel upload and return to home?')){
    location.replace('home.html');
  }
});

uploadForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!validate(true)) {
    uploadStatus.textContent = 'Fix the highlighted fields.';
    uploadStatus.className = 'inline-status err';
    return;
  }
  if(!fileUpload.files.length){
    showError('fileUpload','A file is required.');
    return;
  }
  const file = fileUpload.files[0];
  if(file.size > 25*1024*1024){
    showError('fileUpload','File exceeds 25MB limit.');
    return;
  }
  uploadBtn.disabled = true;
  const prevText = uploadBtn.querySelector('.btn-text').textContent;
  uploadBtn.querySelector('.btn-text').textContent = 'Uploading...';
  uploadStatus.textContent = 'Uploading...';
  uploadStatus.className = 'inline-status';
  const title = file.name.replace(/\.[^.]+$/, '') || file.name;
  try {
    await createNote({
      academic_year: academicYearSelect.value,
      semester: semesterSelect.value,
      subject_code: subjectSelect.value,
      notes_type: notesTypeSelect.value,
      description: descriptionInput.value.trim(),
      file,
      title
    });
    uploadStatus.textContent = 'Upload successful. Redirecting...';
    uploadStatus.className = 'inline-status ok';
    setTimeout(()=> location.replace('home.html'), 600);
  } catch(err){
    uploadStatus.textContent = err.message || 'Upload failed.';
    uploadStatus.className = 'inline-status err';
    uploadBtn.disabled = false;
    uploadBtn.querySelector('.btn-text').textContent = prevText;
  }
});
</script>
</body>
</html>