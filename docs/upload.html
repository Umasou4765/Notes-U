<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Notes - Notes-U</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="upload-page">
  <div class="container">
    <h1>Upload Your Notes</h1>
    <p class="sub">Share knowledge by uploading study materials for your courses.</p>
    <form id="uploadForm" novalidate>
      <div class="group">
        <label for="academicYearSelect" class="n-label">Academic Year</label>
        <select id="academicYearSelect" required>
          <option value="">Select Year</option>
          <option value="year1">Year 1</option>
          <option value="year2">Year 2</option>
        </select>
        <p id="academicYearSelectError" class="error-message"></p>
      </div>
      <div class="group">
        <label for="semesterSelect" class="n-label">Semester</label>
        <select id="semesterSelect" required disabled>
          <option value="">Select Semester</option>
        </select>
        <p id="semesterSelectError" class="error-message"></p>
      </div>
      <div class="group">
        <label for="subjectSelect" class="n-label">Subject</label>
        <select id="subjectSelect" required disabled>
          <option value="">Select Subject</option>
        </select>
        <p id="subjectSelectError" class="error-message"></p>
      </div>
      <div class="group">
        <label for="notesType" class="n-label">Type of Notes</label>
        <select id="notesType" required>
          <option value="">Select a type</option>
          <option value="lecture_notes">Lecture Notes</option>
          <option value="tutorial_solutions">Tutorial Solutions</option>
          <option value="past_year_papers">Past Year Papers</option>
        </select>
        <p id="notesTypeError" class="error-message"></p>
      </div>
      <div class="group">
        <label for="description" class="n-label">Description (Optional)</label>
        <textarea id="description" placeholder="Brief description..."></textarea>
      </div>
      <div class="group">
        <label class="n-label">Upload File</label>
        <input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.odt,.ods,.odp,.rtf" hidden>
        <div id="fileDrop" class="file-drop" tabindex="0" role="button" aria-label="Upload file area">
          <p><strong>Drag & Drop</strong> or click to select a file</p>
            <small>Accepted: PDF, DOC, DOCX, TXT, PPT, PPTX, ODT, ODS, ODP, RTF (Max 25MB)</small>
            <div id="fileOk" class="file-ok"></div>
        </div>
        <p id="fileUploadError" class="error-message"></p>
      </div>
      <div class="actions">
        <button type="submit" class="submit-btn">Upload Notes</button>
      </div>
    </form>
  </div>
  <script type="module">
    import { onAuth, createNote } from './firebase-init.js';
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      function apply(t){
        document.body.classList.remove('light','dark');
        document.body.classList.add(t);
        localStorage.setItem('theme', t);
      }
      if(stored) apply(stored); else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
      });
    })();
    onAuth(user=>{
      if(!user) location.href='auth.html?mode=login';
    });
    const subjectsData = {
      year1:{
        semester1:[
          {code:'AMCS1013',name:'Problem Solving and Programming'},
          {code:'AMCS1113',name:'Computer Architecture'},
          {code:'AMIT1303',name:'Introduction to Interface Design'},
          {code:'AMMS1623',name:'Calculus and Algebra'},
          {code:'AJEL1713',name:'English for Tertiary Studies'},
          {code:'MPU2302',name:'Integrity and Anti-Corruption'},
          {code:'MPU2123',name:'Penghayatan Etika dan Peradaban'}
        ],
        semester2:[
          {code:'AMCS1043',name:'Database Development and Applications'},
          {code:'AMCS1034',name:'Software Development Fundamentals'},
          {code:'AMMS2613',name:'Probability and Statistics'}
        ],
        semester3:[
          {code:'AMIT2034',name:'Fundamentals of Computer Networks'},
          {code:'AMCS2204',name:'Object-Oriented Programming Techniques'},
          {code:'AMCS2093',name:'Operating Systems'},
          {code:'AMIS1013',name:'Systems Analysis and Design'},
          {code:'AMMS2603',name:'Discrete Mathematics'},
          {code:'AJEL1723',name:'Academic English'}
        ]
      },
      year2:{
        semester1:[
          {code:'AMCS2034',name:'Introduction to Data Structures and Algorithms'},
          {code:'AMCS2123',name:'Systems and Programming Concepts'},
          {code:'AMCS2104',name:'Fundamentals of Artificial Intelligence'},
          {code:'AMIT3353',name:'Mobile Application Development'},
          {code:'AMIS1012',name:'Ethics in Computing'}
        ],
        semester2:[
          {code:'AMCS2094',name:'Mini Project'},
          {code:'AMCS2103',name:'Parallel and Distributed Computing'},
          {code:'AMIS1003',name:'Introduction to Cybersecurity'}
        ],
        semester3:[
          {code:'AMIT320A',name:'Industrial Training'}
        ]
      }
    };
    // Elements
    const form = document.getElementById('uploadForm');
    const academicYearSelect = document.getElementById('academicYearSelect');
    const semesterSelect = document.getElementById('semesterSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const notesTypeSelect = document.getElementById('notesType');
    const descriptionInput = document.getElementById('description');
    const fileUpload = document.getElementById('fileUpload');
    const fileDrop = document.getElementById('fileDrop');
    const fileOk = document.getElementById('fileOk');
    const submitBtn = form.querySelector('.submit-btn');
    const requiredFields = [
      { id:'academicYearSelect', msg:'Please select an academic year.' },
      { id:'semesterSelect', msg:'Please select a semester.' },
      { id:'subjectSelect', msg:'Please select a subject.' },
      { id:'notesType', msg:'Please select a type of notes.' },
      { id:'fileUpload', msg:'Please upload a valid document file.' }
    ];
    function showError(id,msg){
      const el = document.getElementById(id+'Error');
      if(el){ el.textContent=msg; el.style.display = msg ? 'block':'none'; }
    }
    function hideError(id){ showError(id,''); }
    function validate(){
      let ok = true;
      requiredFields.forEach(f=>{
        if(f.id==='fileUpload'){
          if(fileUpload.files.length===0){ showError(f.id,f.msg); ok=false; } else hideError(f.id);
        } else {
          const v = document.getElementById(f.id).value;
          if(!v){ showError(f.id,f.msg); ok=false; } else hideError(f.id);
        }
      });
      submitBtn.disabled = !ok;
      return ok;
    }
    function populateSemesters(){
      semesterSelect.innerHTML='<option value="">Select Semester</option>';
      subjectSelect.innerHTML='<option value="">Select Subject</option>';
      semesterSelect.disabled=true; subjectSelect.disabled=true;
      const y = academicYearSelect.value;
      if(y && subjectsData[y]){
        Object.keys(subjectsData[y]).forEach(sem=>{
          const o=document.createElement('option');
            o.value=sem; o.textContent=sem.replace('semester','Semester ');
            semesterSelect.appendChild(o);
        });
        semesterSelect.disabled=false;
      }
      validate();
    }
    function populateSubjects(){
      subjectSelect.innerHTML='<option value="">Select Subject</option>';
      subjectSelect.disabled=true;
      const y = academicYearSelect.value;
      const s = semesterSelect.value;
      if(y && s && subjectsData[y] && subjectsData[y][s]){
        subjectsData[y][s].forEach(sub=>{
          const o=document.createElement('option');
          o.value=sub.code;
          o.textContent=sub.code+' - '+sub.name;
          subjectSelect.appendChild(o);
        });
        subjectSelect.disabled=false;
      }
      validate();
    }
    function updateFileUI(file){
      if(file){
        fileOk.style.display='block';
        fileOk.textContent = file.name + ' (' + (file.size/1024/1024).toFixed(2) + ' MB)';
      } else {
        fileOk.style.display='none';
        fileOk.textContent='';
      }
      validate();
    }
    // Drag + Drop
    fileDrop.addEventListener('click', ()=> fileUpload.click());
    fileDrop.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===' ') { e.preventDefault(); fileUpload.click(); }
    });
    fileUpload.addEventListener('change', ()=> updateFileUI(fileUpload.files[0]||null));
    fileDrop.addEventListener('dragover', e=>{
      e.preventDefault(); fileDrop.classList.add('dragover');
    });
    fileDrop.addEventListener('dragleave', ()=> fileDrop.classList.remove('dragover'));
    fileDrop.addEventListener('drop', e=>{
      e.preventDefault(); fileDrop.classList.remove('dragover');
      if(e.dataTransfer.files.length){
        fileUpload.files = e.dataTransfer.files;
        updateFileUI(fileUpload.files[0]);
      }
    });
    academicYearSelect.addEventListener('change', populateSemesters);
    semesterSelect.addEventListener('change', populateSubjects);
    notesTypeSelect.addEventListener('change', validate);
    descriptionInput.addEventListener('input', ()=>{});
    document.addEventListener('DOMContentLoaded', ()=>{
      populateSemesters();
      populateSubjects();
      validate();
    });
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!validate()) { alert('Please fix errors'); return; }
      if(!fileUpload.files.length){ alert('Select a file'); return; }
      const file = fileUpload.files[0];
      if(file.size > 25*1024*1024){
        showError('fileUpload','File exceeds 25MB limit.');
        return;
      }
      submitBtn.disabled=true;
      submitBtn.textContent='Uploading...';
      const title = file.name.replace(/\.[^.]+$/, '') || file.name;
      try {
        await createNote({
          academic_year: academicYearSelect.value,
          semester: semesterSelect.value,
          subject_code: subjectSelect.value,
          notes_type: notesTypeSelect.value,
          description: descriptionInput.value.trim(),
          file,
          title
        });
        alert('Upload successful');
        location.href='home.html';
      } catch(err){
        alert(err.message || 'Upload failed');
        submitBtn.disabled=false;
        submitBtn.textContent='Upload Notes';
      }
    });
  </script>
</body>
</html>