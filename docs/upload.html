<!DOCTYPE html>
<!-- File: docs/upload.html
     Description: Upload page allowing authenticated users to upload notes (max 25MB).
     Notes: Keep comments and labels in English only.
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>Upload Notes - Notes-U</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/app.css?v=2.0">
</head>
<body class="upload-layout">

  <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle theme">
    <svg class="moon" viewBox="0 0 24 24"><path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/></svg>
    <svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/></svg>
  </button>

  <div class="card-container upload-box">
    <h1>Upload Your Notes</h1>
    <p style="color:var(--text-soft); margin-top:0; margin-bottom:30px;">
      Share knowledge by uploading study materials for your courses.
    </p>

    <form id="uploadForm" novalidate>
      <div class="form-grid">
        <div>
          <label class="field-label">Academic Year *</label>
          <select id="academicYearSelect" required>
            <option value="">Select Year</option>
            <option value="year1">Year 1</option>
            <option value="year2">Year 2</option>
          </select>
        </div>

        <div>
          <label class="field-label">Semester *</label>
          <select id="semesterSelect" required disabled>
            <option value="">Select Semester</option>
          </select>
        </div>

        <div>
          <label class="field-label">Subject *</label>
          <select id="subjectSelect" required disabled>
            <option value="">Select Subject</option>
          </select>
        </div>

        <div>
          <label class="field-label">Type of Notes *</label>
          <select id="notesType" required>
            <option value="">Select type</option>
            <option value="lecture_notes">Lecture Notes</option>
            <option value="tutorial_solutions">Tutorial Solutions</option>
            <option value="past_year_papers">Past Year Papers</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom: 24px;">
        <label class="field-label">Description (Optional)</label>
        <textarea id="description" placeholder="Brief description..." rows="4"></textarea>
      </div>

      <div style="margin-bottom: 30px;">
        <label class="field-label">File *</label>
        <input type="file" id="fileUpload" hidden accept=".pdf,.doc,.docx,.txt,.ppt,.pptx">
        <div id="fileDrop" class="file-drop-area" tabindex="0" role="button">
          <p style="margin:0; font-weight:500;">Click or Drag & Drop to upload</p>
          <small style="color:var(--text-soft)">Max 25MB (PDF, DOC, PPT)</small>
          <div id="fileOk" style="margin-top:10px; color:var(--success); font-weight:600; display:none;"></div>
        </div>
        <p id="fileUploadError" class="error-msg"></p>
      </div>

      <div style="display:flex; flex-direction:column; gap:10px;">
        <button type="submit" class="btn-primary">Upload Notes</button>
        <progress id="uploadProgress" value="0" max="100" style="width:100%; display:none; height:4px;"></progress>
        <a href="home.html" style="text-align:center; font-size:0.9rem; color:var(--text-soft); text-decoration:none; margin-top:10px;">Cancel</a>
      </div>
    </form>
  </div>

  <script type="module" src="./js/upload.js?v=2.0"></script>
</body>
</html>
* { box-sizing:border-box; }
body {
  margin:0;
  font-family:'Inter',system-ui,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  min-height:100vh;
  display:flex;
  padding:48px clamp(14px,4vw,42px) 80px;
  justify-content:center;
  transition:background .6s,color .45s;
}

.container {
  width:100%;
  max-width:760px;
  background:linear-gradient(145deg,var(--surface),var(--surface-alt) 150%);
  border:1px solid var(--border);
  border-radius:28px;
  padding:50px clamp(20px,5vw,54px) 46px;
  box-shadow:var(--shadow);
  position:relative;
  overflow:hidden;
  animation:cardIn .7s cubic-bezier(.4,0,.2,1);
  backdrop-filter:blur(6px);
  display:flex;
  flex-direction:column;
}
@keyframes cardIn {
  0% { opacity:0; transform:translateY(38px) scale(.96); filter:blur(6px); }
  60% { filter:blur(0); }
  100% { opacity:1; transform:none; filter:none; }
}

h1 {
  margin:0 0 10px;
  font-size:2.05rem;
  font-weight:700;
  letter-spacing:-.5px;
  line-height:1.15;
}
p.sub {
  margin:0 0 34px;
  font-size:.98rem;
  color:var(--text-soft);
  line-height:1.55;
  max-width:640px;
}

form {
  display:flex;
  flex-direction:column;
  gap:26px;
}

/* Group layout with responsive two-up arrangement for selects */
.form-grid {
  display:grid;
  gap:24px 26px;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
}

.field {
  display:flex;
  flex-direction:column;
  gap:8px;
  position:relative;
}

label.n-label {
  font-size:.68rem;
  font-weight:600;
  letter-spacing:.55px;
  text-transform:uppercase;
  color:var(--text-faint);
  display:flex;
  align-items:center;
  gap:6px;
}

.required-indicator {
  color:var(--accent);
  font-size:.8rem;
  font-weight:700;
  line-height:1;
  position:relative;
  top:-1px;
}

.helper {
  font-size:.63rem;
  letter-spacing:.35px;
  color:var(--text-faint);
  line-height:1.25;
  margin-top:-2px;
}

/* Modern Select Wrapper */
.modern-select {
  position:relative;
}

.modern-select select {
  width:100%;
  padding:14px 46px 13px 15px;
  font:inherit;
  font-size:.9rem;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--select-bg);
  color:var(--text);
  appearance:none;
  -webkit-appearance:none;
  line-height:1.25;
  transition:border-color .35s, background .4s, box-shadow .35s;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  cursor:pointer;
}
.modern-select select:hover:not(:disabled) {
  background:var(--select-bg-hover);
}
.modern-select select:focus {
  outline:none;
  border-color:var(--focus);
  box-shadow:var(--focus-ring);
}
.modern-select select:disabled {
  cursor:not-allowed;
  opacity:.55;
  background:var(--select-bg-disabled);
}

.modern-select .chevron {
  position:absolute;
  right:14px;
  top:50%;
  width:22px;
  height:22px;
  transform:translateY(-50%);
  pointer-events:none;
  opacity:.6;
  stroke:currentColor;
  stroke-width:2;
  transition:opacity .35s;
}
.modern-select select:focus + .chevron {
  opacity:.9;
}

/* Textarea */
textarea {
  width:100%;
  padding:14px 16px 14px 15px;
  font:inherit;
  font-size:.9rem;
  line-height:1.4;
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--select-bg);
  color:var(--text);
  resize:vertical;
  min-height:120px;
  transition:border-color .35s, background .4s, box-shadow .35s;
}
textarea:hover { background:var(--select-bg-hover); }
textarea:focus {
  outline:none;
  border-color:var(--focus);
  box-shadow:var(--focus-ring);
}

/* File Drop */
.file-section {
  display:flex;
  flex-direction:column;
  gap:14px;
}

.file-drop {
  border:1px dashed var(--border-strong);
  border-radius:20px;
  padding:36px 28px 32px;
  text-align:center;
  background:var(--file-bg);
  position:relative;
  cursor:pointer;
  transition:border-color .35s, background .45s, box-shadow .45s;
  box-shadow:var(--shadow-sm);
  overflow:hidden;
}
body.dark .file-drop { background:var(--file-bg-dark); }
.file-drop:hover {
  border-color:var(--focus);
  background:linear-gradient(145deg,var(--select-bg),var(--surface-alt) 140%);
}
.file-drop.dragover {
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(13,110,253,0.20), var(--shadow-sm);
}
.file-drop p {
  margin:0 0 6px;
  font-size:.85rem;
  font-weight:500;
}
.file-drop small {
  display:block;
  font-size:.62rem;
  letter-spacing:.4px;
  opacity:.7;
  line-height:1.35;
}

.file-ok {
  display:none;
  margin-top:14px;
  font-size:.7rem;
  font-weight:600;
  letter-spacing:.5px;
  background:var(--accent);
  color:#fff;
  padding:8px 12px 7px;
  border-radius:12px;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
  box-shadow:0 6px 18px -6px rgba(0,70,160,0.55);
}

.error-message {
  display:none;
  font-size:.62rem;
  letter-spacing:.4px;
  font-weight:500;
  color:var(--danger);
  background:var(--danger-bg);
  padding:7px 10px 7px;
  border-radius:10px;
  line-height:1.25;
  position:relative;
  animation:fadeIn .35s ease;
}
.error-message::before {
  content:"!";
  position:absolute;
  left:8px;
  top:50%;
  transform:translateY(-50%);
  font-size:.55rem;
  width:16px;
  height:16px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--danger);
  color:#fff;
  font-weight:700;
  letter-spacing:.2px;
}
.error-message.inline-icon {
  padding-left:30px;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(-4px); }
  to { opacity:1; transform:none; }
}

.actions {
  margin-top:10px;
}

.btn {
  width:100%;
  padding:16px 22px;
  border:none;
  border-radius:18px;
  font:inherit;
  font-size:1rem;
  font-weight:600;
  letter-spacing:.4px;
  color:#fff;
  cursor:pointer;
  background:var(--gradient-accent);
  box-shadow:0 10px 30px -12px rgba(0,80,180,0.55), 0 6px 16px -10px rgba(0,70,160,0.45);
  transition:background .35s, transform .55s cubic-bezier(.4,0,.2,1), box-shadow .55s;
}
.btn:hover:not(:disabled){
  transform:translateY(-3px);
  box-shadow:0 14px 38px -14px rgba(0,80,180,0.65),0 8px 22px -12px rgba(0,70,160,0.55);
}
.btn:active:not(:disabled){
  transform:translateY(0) scale(.96);
}
.btn:disabled {
  opacity:.6;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}

/* Focus outline for keyboard nav */
select:focus-visible,
button:focus-visible,
.file-drop:focus-visible {
  outline:2px solid var(--focus);
  outline-offset:2px;
}

.divider {
  height:1px;
  width:100%;
  background:var(--border);
  opacity:.5;
  margin:6px 0 -4px;
  border-radius:1px;
}

/* Responsive tweaks */
@media (max-width:660px){
  .container {
    border-radius:24px;
    padding:40px 28px 42px;
  }
  p.sub { margin-bottom:28px; }
  .form-grid { gap:20px 18px; }
  .btn { font-size:.95rem; }
}

/* (Optional) Combobox styles section kept minimal if you enable the advanced subject picker */
.combobox {
  position:relative;
}
.combobox button.cb-trigger {
  width:100%;
  text-align:left;
  padding:14px 46px 13px 15px;
  background:var(--select-bg);
  border:1px solid var(--border);
  border-radius:14px;
  font:inherit;
  font-size:.9rem;
  cursor:pointer;
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  color:var(--text);
  transition:border-color .35s, background .4s, box-shadow .35s;
}
.combobox button.cb-trigger:hover { background:var(--select-bg-hover); }
.combobox button.cb-trigger:focus {
  outline:none;
  border-color:var(--focus);
  box-shadow:var(--focus-ring);
}
.combobox button.cb-trigger[aria-expanded="true"] {
  border-color:var(--focus);
}
.cb-panel {
  position:absolute;
  left:0; right:0;
  top:calc(100% + 6px);
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:10px 10px 12px;
  z-index:60;
  display:none;
  animation:fadeIn .25s ease;
  max-height:300px;
  overflow:auto;
}
body.dark .cb-panel { background:var(--surface-alt); }
.cb-panel.open { display:block; }
.cb-search {
  position:relative;
  margin:0 0 10px;
}
.cb-search input {
  width:100%;
  padding:10px 34px 10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  font:inherit;
  font-size:.75rem;
  background:var(--select-bg);
  color:var(--text);
  transition:border-color .3s, background .35s;
}
.cb-search input:focus {
  outline:none;
  border-color:var(--focus);
  box-shadow:0 0 0 3px rgba(13,110,253,.25);
}
.cb-options {
  list-style:none;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  gap:2px;
}
.cb-options li button {
  width:100%;
  text-align:left;
  background:transparent;
  border:0;
  padding:8px 10px 8px 12px;
  font:inherit;
  font-size:.7rem;
  display:flex;
  flex-direction:column;
  gap:2px;
  border-radius:10px;
  cursor:pointer;
  color:var(--text-soft);
  transition:background .25s,color .25s;
  letter-spacing:.25px;
}
.cb-options li button .code {
  font-weight:600;
  font-size:.65rem;
  letter-spacing:.55px;
  text-transform:uppercase;
  opacity:.7;
}
.cb-options li button:hover,
.cb-options li button[aria-selected="true"],
.cb-options li button:focus {
  outline:none;
  background:var(--select-bg-hover);
  color:var(--text);
}
.cb-empty {
  padding:16px 10px;
  font-size:.65rem;
  text-align:center;
  color:var(--text-faint);
  opacity:.8;
}

/* Utility hidden (for accessible inline selects) */
.visually-hidden {
  position:absolute;
  left:-9999px;
  top:auto;
  width:1px;
  height:1px;
  overflow:hidden;
  clip:rect(1px,1px,1px,1px);
  white-space:nowrap;
}
</style>
</head>
<body>
  <div class="app-container">
    <h1>Upload Your Notes</h1>
    <p class="sub">Share knowledge by uploading study materials for your courses.</p>

    <form id="uploadForm" novalidate>
      <div class="form-grid">
        <!-- Academic Year -->
        <div class="field">
          <label for="academicYearSelect" class="n-label">
            Academic Year <span class="required-indicator">*</span>
          </label>
          <div class="modern-select">
            <select id="academicYearSelect" required aria-describedby="academicYearSelectError">
              <option value="">Select Year</option>
              <option value="year1">Year 1</option>
              <option value="year2">Year 2</option>
            </select>
            <svg class="chevron" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <p id="academicYearSelectError" class="error-message inline-icon"></p>
        </div>

        <!-- Semester -->
        <div class="field">
          <label for="semesterSelect" class="n-label">
            Semester <span class="required-indicator">*</span>
          </label>
            <div class="modern-select">
              <select id="semesterSelect" required disabled aria-describedby="semesterSelectError">
                <option value="">Select Semester</option>
              </select>
              <svg class="chevron" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          <p id="semesterSelectError" class="error-message inline-icon"></p>
        </div>

        <!-- Subject (native select by default) -->
        <div class="field">
          <label for="subjectSelect" class="n-label">
            Subject <span class="required-indicator">*</span>
          </label>
          <div class="modern-select">
            <select id="subjectSelect" required disabled aria-describedby="subjectSelectError">
              <option value="">Select Subject</option>
            </select>
            <svg class="chevron" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <p id="subjectSelectError" class="error-message inline-icon"></p>
        </div>

        <!-- Type -->
        <div class="field">
          <label for="notesType" class="n-label">
            Type of Notes <span class="required-indicator">*</span>
          </label>
          <div class="modern-select">
            <select id="notesType" required aria-describedby="notesTypeError">
              <option value="">Select a type</option>
              <option value="lecture_notes">Lecture Notes</option>
              <option value="tutorial_solutions">Tutorial Solutions</option>
              <option value="past_year_papers">Past Year Papers</option>
            </select>
            <svg class="chevron" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <p id="notesTypeError" class="error-message inline-icon"></p>
        </div>
      </div>

      <!-- Description -->
      <div class="field">
        <label for="description" class="n-label">Description (Optional)</label>
        <textarea id="description" placeholder="Brief description..."></textarea>
      </div>

      <!-- File Upload -->
      <div class="file-section">
        <label class="n-label" for="fileUpload">Upload File <span class="required-indicator">*</span></label>
        <input type="file" id="fileUpload" hidden accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.odt,.ods,.odp,.rtf">
        <div id="fileDrop" class="file-drop" tabindex="0" role="button" aria-label="Upload file area">
          <p><strong>Drag & Drop</strong> or click to select a file</p>
          <small>PDF, DOC, PPT, TXT, ODT/ODS/ODP, RTF (Max 25MB)</small>
          <div id="fileOk" class="file-ok"></div>
        </div>
        <p id="fileUploadError" class="error-message inline-icon"></p>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <div class="actions">
        <button type="submit" class="btn">
          Upload Notes
        </button>
        <progress id="uploadProgress" value="0" max="100" style="display:none;width:100%;margin-top:12px"></progress>
      </div>
    </form>
  </div>

<script type="module" src="./js/upload.js">

  // THEME (reuse existing approach; leave stable)
  (function initTheme(){
    const stored = localStorage.getItem('theme');
    function apply(t){
      document.body.classList.remove('light','dark');
      document.body.classList.add(t);
      localStorage.setItem('theme', t);
    }
    if(stored) apply(stored);
    else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
      if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
    });
  })();

  // AUTH
  onAuth(user=>{
    if(!user) location.href='auth.html?mode=login';
  });

  // Subject data
  const subjectsData = {
    year1:{
      semester1:[
        {code:'AMCS1013',name:'Problem Solving and Programming'},
        {code:'AMCS1113',name:'Computer Architecture'},
        {code:'AMIT1303',name:'Introduction to Interface Design'},
        {code:'AMMS1623',name:'Calculus and Algebra'},
        {code:'AJEL1713',name:'English for Tertiary Studies'},
        {code:'MPU2302',name:'Integrity and Anti-Corruption'},
        {code:'MPU2123',name:'Penghayatan Etika dan Peradaban'}
      ],
      semester2:[
        {code:'AMCS1043',name:'Database Development and Applications'},
        {code:'AMCS1034',name:'Software Development Fundamentals'},
        {code:'AMMS2613',name:'Probability and Statistics'}
      ],
      semester3:[
        {code:'AMIT2034',name:'Fundamentals of Computer Networks'},
        {code:'AMCS2204',name:'Object-Oriented Programming Techniques'},
        {code:'AMCS2093',name:'Operating Systems'},
        {code:'AMIS1013',name:'Systems Analysis and Design'},
        {code:'AMMS2603',name:'Discrete Mathematics'},
        {code:'AJEL1723',name:'Academic English'}
      ]
    },
    year2:{
      semester1:[
        {code:'AMCS2034',name:'Introduction to Data Structures and Algorithms'},
        {code:'AMCS2123',name:'Systems and Programming Concepts'},
        {code:'AMCS2104',name:'Fundamentals of Artificial Intelligence'},
        {code:'AMIT3353',name:'Mobile Application Development'},
        {code:'AMIS1012',name:'Ethics in Computing'}
      ],
      semester2:[
        {code:'AMCS2094',name:'Mini Project'},
        {code:'AMCS2103',name:'Parallel and Distributed Computing'},
        {code:'AMIS1003',name:'Introduction to Cybersecurity'}
      ],
      semester3:[
        {code:'AMIT320A',name:'Industrial Training'}
      ]
    }
  };

  // Elements
  const form = document.getElementById('uploadForm');
  const academicYearSelect = document.getElementById('academicYearSelect');
  const semesterSelect = document.getElementById('semesterSelect');
  const subjectSelect = document.getElementById('subjectSelect');
  const notesTypeSelect = document.getElementById('notesType');
  const descriptionInput = document.getElementById('description');
  const fileUpload = document.getElementById('fileUpload');
  const fileDrop = document.getElementById('fileDrop');
  const fileOk = document.getElementById('fileOk');
  const submitBtn = form.querySelector('.btn');

  const requiredFields = [
    { id:'academicYearSelect', msg:'Please select an academic year.' },
    { id:'semesterSelect', msg:'Please select a semester.' },
    { id:'subjectSelect', msg:'Please select a subject.' },
    { id:'notesType', msg:'Please select a type of notes.' },
    { id:'fileUpload', msg:'Please upload a valid document file.' }
  ];

  function showError(id,msg){
    const el = document.getElementById(id+'Error');
    if(!el) return;
    if(msg){
      el.textContent = msg;
      el.style.display = 'block';
    } else {
      el.textContent = '';
      el.style.display = 'none';
    }
  }
  function hideError(id){ showError(id,''); }

  function validate(scrollFirst=false){
    let ok = true;
    let firstInvalid = null;
    requiredFields.forEach(f=>{
      if(f.id==='fileUpload'){
        if(fileUpload.files.length===0){
          showError(f.id,f.msg); ok=false; if(!firstInvalid) firstInvalid = fileDrop;
        } else hideError(f.id);
      } else {
        const v = document.getElementById(f.id).value;
        if(!v){
          showError(f.id,f.msg); ok=false; if(!firstInvalid) firstInvalid = document.getElementById(f.id);
        } else hideError(f.id);
      }
    });
    submitBtn.disabled = !ok;
    if(scrollFirst && firstInvalid){
      firstInvalid.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    return ok;
  }

  function populateSemesters(){
    semesterSelect.innerHTML='<option value="">Select Semester</option>';
    subjectSelect.innerHTML='<option value="">Select Subject</option>';
    semesterSelect.disabled = true;
    subjectSelect.disabled = true;
    const y = academicYearSelect.value;
    if(y && subjectsData[y]){
      Object.keys(subjectsData[y]).forEach(sem=>{
        const opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = sem.replace('semester','Semester ');
        semesterSelect.appendChild(opt);
      });
      semesterSelect.disabled = false;
    }
    validate();
  }

  function populateSubjects(){
    subjectSelect.innerHTML='<option value="">Select Subject</option>';
    subjectSelect.disabled = true;
    const y = academicYearSelect.value;
    const s = semesterSelect.value;
    if(y && s && subjectsData[y] && subjectsData[y][s]){
      subjectsData[y][s].forEach(sub=>{
        const opt = document.createElement('option');
        opt.value = sub.code;
        opt.textContent = `${sub.code} - ${sub.name}`;
        subjectSelect.appendChild(opt);
      });
      subjectSelect.disabled = false;
    }
    validate();
  }

  function updateFileUI(file){
    if(file){
      fileOk.style.display='block';
      fileOk.textContent = file.name + ' (' + (file.size/1024/1024).toFixed(2) + ' MB)';
    } else {
      fileOk.style.display='none';
      fileOk.textContent='';
    }
    validate();
  }


  // Drag & Drop
  fileDrop.addEventListener('click', ()=> fileUpload.click());
  fileDrop.addEventListener('keydown', e=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      fileUpload.click();
    }
  });
  fileUpload.addEventListener('change', ()=> updateFileUI(fileUpload.files[0]||null));
  fileDrop.addEventListener('dragover', e=>{
    e.preventDefault();
    fileDrop.classList.add('dragover');
  });
  fileDrop.addEventListener('dragleave', ()=> fileDrop.classList.remove('dragover'));
  fileDrop.addEventListener('drop', e=>{
    e.preventDefault();
    fileDrop.classList.remove('dragover');
    if(e.dataTransfer.files.length){
      fileUpload.files = e.dataTransfer.files;
      updateFileUI(fileUpload.files[0]);
    }
  });

  academicYearSelect.addEventListener('change', populateSemesters);
  semesterSelect.addEventListener('change', populateSubjects);
  notesTypeSelect.addEventListener('change', ()=> validate());
  descriptionInput.addEventListener('input', ()=> { /* optional */ });

  document.addEventListener('DOMContentLoaded', ()=>{
    populateSemesters();
    populateSubjects();
    validate();
  });

  form.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!validate(true)){
      showToast('Please fix the highlighted fields.', 'error');
      return;
    }
    if(!fileUpload.files.length){
      showError('fileUpload','Please upload a valid document file.');
      return;
    }
    const file = fileUpload.files[0];
    if(file.size > 25*1024*1024){
      showError('fileUpload','File exceeds 25MB limit.');
      return;
    }
    submitBtn.disabled = true;
    const prevText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading...';
    const title = file.name.replace(/\.[^.]+$/, '') || file.name;
    try {
      await createNote({
        academic_year: academicYearSelect.value,
        semester: semesterSelect.value,
        subject_code: subjectSelect.value,
        notes_type: notesTypeSelect.value,
        description: descriptionInput.value.trim(),
        file,
        title
      });
      showToast('Upload successful','success');
      setTimeout(()=> location.href='home.html',700);
    } catch(err){
      showToast(err.message || 'Upload failed', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = prevText;
    }
  });

</script>
</body>
</html>


