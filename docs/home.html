<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="color-scheme" content="light dark">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Notes-U</title>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f8f8f8; --text:#333; --label:#666;
  --container:#fff; --border:rgba(0,0,0,0.14);
  --accent:#0d6efd; --accent-hover:#0b5ed7;
  --shadow:0 2px 4px rgba(0,0,0,0.08);
  --shadow-strong:0 4px 14px rgba(0,0,0,0.12);
  --focus-ring:0 0 0 3px rgba(13,110,253,.35);
  --danger:#d23d3d;
  --success:#1f9d55;
  --card-hover-bg:rgba(0,0,0,0.035);
  --overlay-bg:rgba(0,0,0,.45);
  --transition:.28s cubic-bezier(.4,0,.2,1);
  --thumb-bg:#eef3ff;
  --thumb-text:#0d3d80;
  --upload-gradient:linear-gradient(135deg,#0d6efd,#0b5ed7 120%);
  --logout-bg:linear-gradient(145deg,var(--bg),var(--card-hover-bg));
}
body.dark {
  --bg:#1a1a1a; --text:#f2f2f2; --label:#b0b0b0;
  --container:#222; --border:rgba(255,255,255,0.12);
  --shadow:0 2px 4px rgba(0,0,0,0.6);
  --shadow-strong:0 4px 14px rgba(0,0,0,0.7);
  --card-hover-bg:rgba(255,255,255,0.06);
  --overlay-bg:rgba(0,0,0,.65);
  --thumb-bg:#273140;
  --thumb-text:#b9d7ff;
  --logout-bg:linear-gradient(145deg,#222,#2c2c2c);
}
* { box-sizing:border-box; }
body {
  font-family:'Inter',system-ui,Arial,sans-serif;
  margin:0; background:var(--bg); color:var(--text);
  display:flex; flex-direction:column; min-height:100vh;
  transition:background .35s,color .35s;
}

/* Header */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 18px 10px 14px; background:var(--container);
  box-shadow:var(--shadow); position:sticky; top:0; z-index:70;
  border-bottom:1px solid var(--border);
  gap:12px;
}
.brand { display:flex; align-items:center; gap:10px; user-select:none; }
.logo {
  font-size:1.4rem; font-weight:700; color:inherit;
  display:flex; align-items:center; justify-content:center;
  width:42px; height:42px; border:2px solid currentColor; border-radius:12px;
}
.site-title { font-size:1.15rem; font-weight:700; letter-spacing:-.5px; }

/* Mobile menu button */
.menu-btn {
  display:none;
  background:transparent;
  border:1px solid var(--border);
  width:44px; height:44px; border-radius:14px;
  align-items:center; justify-content:center;
  cursor:pointer;
  color:var(--text);
  position:relative;
  transition:background .25s,border-color .25s;
}
.menu-btn:focus-visible { outline:none; box-shadow:var(--focus-ring); }
.menu-btn:hover { background:var(--card-hover-bg); }
.menu-btn svg { width:22px; height:22px; stroke:currentColor; stroke-width:2; fill:none; }

/* Header actions */
.header-actions { display:flex; gap:10px; align-items:center; }

/* Action buttons */
.icon-btn{
  --btn-bg:var(--accent);
  --btn-bg-hover:var(--accent-hover);
  background:var(--btn-bg);
  color:#fff; border:none; cursor:pointer;
  padding:10px 16px; font-size:.74rem; font-weight:600;
  border-radius:14px; display:inline-flex; gap:6px; align-items:center;
  text-decoration:none; letter-spacing:.45px;
  box-shadow:0 6px 18px -8px rgba(0,90,200,0.55), 0 2px 8px -4px rgba(0,70,160,0.4);
  transition:background .28s, transform .4s, box-shadow .4s;
  line-height:1;
  position:relative;
}
.icon-btn svg { width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; }
.icon-btn:hover { transform:translateY(-2px); box-shadow:0 10px 26px -10px rgba(0,70,170,0.6), 0 4px 16px -6px rgba(0,70,160,0.45); }
.icon-btn:active { transform:translateY(0) scale(.95); }
.icon-btn:focus-visible { outline:none; box-shadow:var(--focus-ring); }

.icon-btn.logout {
  background:var(--logout-bg);
  color:var(--text);
  border:1px solid var(--border);
  box-shadow:none;
  font-weight:600;
}
.icon-btn.logout:hover { background:var(--card-hover-bg); transform:none; box-shadow:none; }
.icon-btn.upload {
  background:var(--upload-gradient);
  font-weight:700;
  letter-spacing:.55px;
}

/* View toggle group */
.view-toggle {
  display:flex; gap:6px; align-items:center;
  background:var(--container);
  padding:4px;
  border-radius:14px;
  border:1px solid var(--border);
  box-shadow:0 2px 6px rgba(0,0,0,.04);
}
.view-btn {
  background:transparent;
  border:0;
  cursor:pointer;
  font-size:.66rem;
  font-weight:600;
  letter-spacing:.45px;
  padding:8px 10px;
  line-height:1;
  border-radius:10px;
  color:var(--label);
  display:inline-flex;
  align-items:center;
  gap:6px;
  position:relative;
  transition:color .25s, background .25s, transform .35s;
  min-width:46px;
}
.view-btn svg { width:16px; height:16px; stroke:currentColor; stroke-width:1.8; fill:none; }
.view-btn[aria-pressed="true"] {
  background:var(--accent);
  color:#fff;
  box-shadow:0 4px 12px -4px rgba(0,90,200,.45);
}
.view-btn:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }

/* Layout */
main {
  flex-grow:1; display:grid; grid-template-columns:290px 1fr; gap:26px;
  padding:24px 26px 56px;
  max-width:1440px; width:100%; margin:0 auto; box-sizing:border-box;
  position:relative;
}

/* Desktop Sidebar */
aside.sidebar {
  background:var(--container); border-radius:18px; padding:20px 18px 22px;
  box-shadow:var(--shadow); border:1px solid var(--border); min-height:0;
  display:flex; flex-direction:column;
  position:relative;
  max-height:calc(100vh - 120px);
  overflow:hidden;
  transition:transform .4s var(--transition), opacity .35s var(--transition);
}
.sidebar-scroll {
  overflow-y:auto; margin-top:4px; padding-right:4px; scrollbar-width:thin;
}
.sidebar-scroll::-webkit-scrollbar { width:8px; }
.sidebar-scroll::-webkit-scrollbar-track { background:transparent; }
.sidebar-scroll::-webkit-scrollbar-thumb {
  background:var(--card-hover-bg);
  border-radius:20px;
}
aside.sidebar h2 {
  margin:0 0 10px;
  font-size:.72rem; letter-spacing:.85px; font-weight:700;
  text-transform:uppercase; opacity:.65;
}

nav.sidebar-nav { flex:1 1 auto; }
ul.category-list { list-style:none; margin:0; padding:0; }
ul.category-list li { margin-bottom:2px; }
ul.category-list a {
  display:block; padding:9px 11px; text-decoration:none;
  color:var(--label); border-radius:10px; font-size:.7rem;
  transition:background .2s,color .2s;
  font-weight:500;
}
ul.category-list a[aria-current="true"],
ul.category-list a:hover {
  background:var(--card-hover-bg); color:var(--text);
}
.category-semester-separator {
  font-size:.55rem; font-weight:700; letter-spacing:.85px;
  text-transform:uppercase; margin:12px 0 4px; opacity:.5; padding-left:4px;
}

/* Mobile Drawer */
.sidebar-drawer {
  position:fixed;
  top:0; left:0; bottom:0;
  width:300px;
  max-width:86vw;
  transform:translateX(-105%);
  background:var(--container);
  border-right:1px solid var(--border);
  box-shadow:0 0 32px -4px rgba(0,0,0,.45);
  z-index:240;
  display:flex;
  flex-direction:column;
  padding:20px 18px 24px;
  transition:transform .5s var(--transition);
  touch-action:none;
  overscroll-behavior:contain;
}
.sidebar-drawer.open { transform:translateX(0); }
.drawer-overlay {
  position:fixed; inset:0; background:var(--overlay-bg);
  backdrop-filter:saturate(140%) blur(2px);
  opacity:0; pointer-events:none;
  transition:opacity .35s var(--transition);
  z-index:200;
}
.drawer-overlay.visible { opacity:1; pointer-events:auto; }
.drawer-header{
  display:flex; justify-content:space-between; align-items:center; gap:8px; margin:0 0 8px;
}
.drawer-title{
  margin:0; font-size:.75rem; font-weight:700; letter-spacing:.9px; text-transform:uppercase; opacity:.65;
}
.close-drawer-btn, .floating-close-btn {
  background:transparent; border:1px solid var(--border); width:42px; height:42px;
  border-radius:14px; cursor:pointer; display:flex; align-items:center; justify-content:center;
  color:var(--text); transition:background .25s, transform .4s;
}
.close-drawer-btn:hover,
.floating-close-btn:hover { background:var(--card-hover-bg); }
.close-drawer-btn:focus-visible,
.floating-close-btn:focus-visible { outline:none; box-shadow:var(--focus-ring); }
.floating-close-btn {
  position:fixed; top:10px; right:10px; z-index:260;
  backdrop-filter:blur(6px) saturate(140%);
  -webkit-backdrop-filter:blur(6px) saturate(140%);
  background:var(--container);
  display:none;
}
.sidebar-drawer.open + .floating-close-btn { display:flex; }

/* Content */
section.content-area {
  background:var(--container); border-radius:22px; padding:26px 24px 38px;
  box-shadow:var(--shadow); border:1px solid var(--border); min-height:0;
  display:flex; flex-direction:column;
  position:relative;
  overflow:hidden;
}
section.content-area h1 {
  margin:0 0 14px;
  font-size:1.45rem;
  letter-spacing:-.6px;
  font-weight:700;
}

/* Filters / top bar */
.filters-wrap {
  display:flex; flex-wrap:wrap; gap:14px; align-items:center; margin:0 0 18px;
}
.search-wrap { position:relative; flex:1 1 260px; min-width:240px; }
.search-wrap input[type="search"] {
  width:100%; padding:12px 14px 12px 44px; font-size:.8rem;
  border:1px solid var(--border); border-radius:14px; background:transparent; color:inherit;
  transition:border-color .25s, background .3s;
}
.search-wrap input[type="search"]:focus {
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(13,110,253,.25);
  background:var(--card-hover-bg);
}
.search-wrap svg {
  position:absolute; left:14px; top:50%; transform:translateY(-50%); width:20px; height:20px; opacity:.55;
}

.results-summary {
  font-size:.6rem; letter-spacing:.5px; margin:0 0 14px;
  color:var(--label);
}

/* Notes */
.notes-host { min-height:140px; position:relative; }
.note-grid {
  --col-min:250px;
  display:grid; gap:18px;
  grid-template-columns:repeat(auto-fill,minmax(var(--col-min),1fr));
}
.note-list { display:flex; flex-direction:column; gap:12px; }
body.view-list .note-card { border-left:4px solid var(--accent); padding-left:16px; }

.note-card {
  background:transparent; border:1px solid var(--border); border-radius:16px;
  padding:16px 18px 14px; display:flex; flex-direction:column;
  gap:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.04);
  transition:transform .22s, box-shadow .22s, background .35s;
  position:relative;
  min-height:120px;
}
.note-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-strong); background:var(--card-hover-bg); }
.note-card h3 {
  margin:0; font-size:.9rem; line-height:1.25; flex:1 1 auto; word-break:break-word; letter-spacing:.2px;
}
.note-card p { margin:4px 0 8px; font-size:.68rem; line-height:1.35; color:var(--label); }

.tags {
  display:flex; flex-wrap:wrap; gap:6px; margin-top:auto;
}
.category-tag {
  font-size:.52rem; font-weight:600; letter-spacing:.6px;
  padding:5px 8px 4px;
  border-radius:10px;
  background:var(--card-hover-bg);
  color:var(--label);
  line-height:1;
  user-select:none;
}

.note-actions {
  display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;
}
.note-actions a {
  font-size:.58rem; font-weight:600; letter-spacing:.45px;
  background:transparent; border:1px solid var(--border);
  padding:6px 10px; border-radius:10px; cursor:pointer;
  color:var(--label); text-decoration:none; display:inline-flex; align-items:center; gap:4px;
  transition:background .25s,color .25s,border-color .25s;
}
.note-actions a:hover { background:var(--card-hover-bg); color:var(--text); }

/* Empty state / error */
.note-card.inline-info {
  align-items:flex-start;
}

/* Skeleton */
.skeleton { position:relative; overflow:hidden; background:var(--card-hover-bg); border:1px solid var(--border); border-radius:16px; height:120px; }
.skeleton::after {
  content:"";
  position:absolute; inset:0;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
  animation:shimmer 1.15s infinite;
  mix-blend-mode:overlay;
  opacity:.7;
}
body.dark .skeleton::after { background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); }
@keyframes shimmer {
  0%{transform:translateX(-100%);}
  100%{transform:translateX(100%);}
}

footer {
  text-align:center; font-size:.62rem; padding:20px 10px 34px; opacity:.6;
  border-top:1px solid var(--border); margin-top:auto;
}

/* Floating Upload FAB (mobile) */
.fab-upload {
  position:fixed;
  right:16px;
  bottom:18px;
  width:62px;
  height:62px;
  border-radius:24px;
  background:var(--upload-gradient);
  box-shadow:0 10px 28px -8px rgba(0,90,200,.55), 0 6px 18px -6px rgba(0,70,160,.5);
  display:none;
  align-items:center;
  justify-content:center;
  color:#fff;
  text-decoration:none;
  font-size:.65rem;
  font-weight:700;
  letter-spacing:.5px;
  gap:4px;
  flex-direction:column;
  z-index:150;
  transition:transform .45s var(--transition), box-shadow .45s, background .4s;
}
.fab-upload svg { width:26px; height:26px; stroke:#fff; stroke-width:2; fill:none; }
.fab-upload:hover { transform:translateY(-4px); box-shadow:0 16px 34px -12px rgba(0,90,200,.65), 0 8px 22px -10px rgba(0,70,160,.55); }
.fab-upload:active { transform:translateY(-1px) scale(.94); }

/* Mobile enhancements */
@media (max-width:930px){
  main { grid-template-columns:1fr; }
  aside.sidebar { display:none; }
  .menu-btn { display:flex; }
}

@media (max-width:700px){
  .brand .logo { display:none; } /* Remove U logo for space */
  header { padding:8px 10px; gap:10px; }
  .site-title { font-size:1rem; letter-spacing:-.4px; }
  .header-actions .icon-btn { display:none; } /* hide top bar upload/logout in mobile */
  .fab-upload { display:flex; }
  .filters-wrap { gap:10px; }
  .search-wrap { flex:1 1 100%; min-width:0; }
  .view-toggle {
    padding:4px 5px;
    border-radius:18px;
    gap:4px;
    background:var(--card-hover-bg);
    border:1px solid var(--border);
  }
  .view-btn {
    padding:10px 12px;
    border-radius:12px;
    font-size:0;
  }
  .view-btn svg { width:20px; height:20px; }
  .view-btn[aria-pressed="true"]{
    transform:translateY(-2px);
  }
  section.content-area { padding:22px 18px 80px; } /* extra space for FAB */
}

@media (max-width:520px){
  .search-wrap input[type="search"] {
    border-radius:18px;
    padding:13px 16px 13px 48px;
  }
  .filters-wrap { margin-bottom:12px; }
  .view-toggle { order:3; }
}

@media (prefers-reduced-motion:reduce){
  * { animation:none !important; transition:none !important; }
}

/* Visually hidden helper */
.visually-hidden {
  position:absolute;
  left:-9999px;
  top:auto;
  width:1px;
  height:1px;
  overflow:hidden;
  clip:rect(1px,1px,1px,1px);
  white-space:nowrap;
}
</style>
</head>
<body class="view-grid">
<header role="banner">
  <button id="menuBtn" class="menu-btn" aria-label="Open subjects">
    <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
  </button>
  <div class="brand" aria-label="Notes-U">
    <div class="logo" aria-hidden="true">U</div>
    <span class="site-title">Notes-U</span>
  </div>
  <div class="header-actions">
    <a href="upload.html" class="icon-btn upload" id="upload-note-btn" aria-label="Upload Note">
      <svg viewBox="0 0 24 24"><path d="M12 16V4m0 0l-5 5m5-5 5 5"/><path d="M4 20h16"/></svg>
      <span>Upload</span>
    </a>
    <button class="icon-btn logout" id="logout-btn" aria-label="Log out">
      <svg viewBox="0 0 24 24">
        <path d="M15 3h-6a2 2 0 00-2 2v3"/>
        <path d="M9 21h6a2 2 0 002-2v-3"/>
        <path d="M16 12H8"/>
        <path d="M11 9l-3 3 3 3"/>
      </svg>
      <span>Logout</span>
    </button>
  </div>
</header>

<!-- Mobile Drawer (cloned categories) -->
<nav id="mobileDrawer" class="sidebar-drawer" aria-label="Subject categories drawer">
  <div class="drawer-header">
    <h2 class="drawer-title">Subjects</h2>
    <button id="closeDrawerBtn" class="close-drawer-btn" aria-label="Close subjects">
      <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2" fill="none"><path d="M6 6l12 12M18 6L6 18"/></svg>
    </button>
  </div>
  <div class="sidebar-scroll">
    <ul class="category-list" id="categoryListMobile" tabindex="-1"></ul>
  </div>
</nav>
<button id="drawerCloseFloating" class="floating-close-btn" aria-label="Close subjects">
  <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2" fill="none"><path d="M6 6l12 12M18 6L6 18"/></svg>
</button>
<div id="drawerOverlay" class="drawer-overlay" aria-hidden="true"></div>

<main role="main">
  <!-- Desktop Sidebar -->
  <aside class="sidebar" aria-label="Filters" id="desktopSidebar">
    <h2>Subjects</h2>
    <div class="sidebar-scroll">
      <nav class="sidebar-nav" aria-label="Subject categories">
        <ul class="category-list" id="categoryList">
          <li><a href="#" data-category="all" aria-current="true">All Notes</a></li>
          <li class="category-semester-separator">Year 1 Semester 1</li>
          <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
          <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
          <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
          <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
          <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
          <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
          <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
          <li class="category-semester-separator">Year 1 Semester 2</li>
          <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
          <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
          <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
          <li class="category-semester-separator">Year 1 Semester 3</li>
          <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
          <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
          <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
          <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
          <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
          <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
          <li class="category-semester-separator">Year 2 Semester 1</li>
          <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
          <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
          <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
          <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
          <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
          <li class="category-semester-separator">Year 2 Semester 2</li>
          <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
          <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
          <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
          <li class="category-semester-separator">Year 2 Semester 3</li>
          <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content -->
  <section class="content-area" aria-live="polite">
    <h1>My Notes</h1>
    <div class="filters-wrap">
      <div class="search-wrap">
        <input id="searchInput" type="search" placeholder="Search notes..." aria-label="Search notes">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
          <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/>
        </svg>
      </div>
      <div class="view-toggle" id="viewToggle" role="group" aria-label="View mode">
        <button class="view-btn" data-view="grid" aria-pressed="true" aria-label="Grid view">
          <svg viewBox="0 0 24 24"><path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/></svg>
          <span class="label-text" style="display:none;">Grid</span>
        </button>
        <button class="view-btn" data-view="list" aria-pressed="false" aria-label="List view">
          <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          <span class="label-text" style="display:none;">List</span>
        </button>
      </div>
    </div>
    <div class="results-summary" id="resultsSummary"></div>
    <div class="notes-host">
      <div id="notes-container" class="note-grid" aria-live="polite"></div>
    </div>
  </section>
</main>

<!-- Mobile FAB Upload -->
<a href="upload.html" id="fabUpload" class="fab-upload" aria-label="Upload Note">
  <svg viewBox="0 0 24 24"><path d="M12 16V4m0 0l-5 5m5-5 5 5"/><path d="M4 20h16"/></svg>
  <span>Upload</span>
</a>

<footer>&copy; <span id="yearSpan"></span> Notes-U. All rights reserved.</footer>

<script type="module">
import { fetchNotes, getUser, logout } from '../js/api.js';

/* Year */
document.getElementById('yearSpan').textContent = new Date().getFullYear();

/* View Toggle */
const viewToggle = document.getElementById('viewToggle');
viewToggle.addEventListener('click', e=>{
  const btn = e.target.closest('.view-btn');
  if(!btn) return;
  const mode = btn.dataset.view;
  document.body.classList.toggle('view-list', mode==='list');
  document.body.classList.toggle('view-grid', mode==='grid');
  viewToggle.querySelectorAll('.view-btn').forEach(b=>{
    b.setAttribute('aria-pressed', b===btn ? 'true':'false');
  });
});

/* Logout retained for desktop / programmatic (mobile logout could be added to drawer if desired) */
const logoutButton = document.getElementById('logout-btn');
logoutButton?.addEventListener('click', async () => {
  try {
    await logout();
    window.location.href = 'auth.html?mode=login';
  } catch {
    alert('Failed to log out.');
  }
});

/* Auth guard */
async function verifyUser(){
  try {
    await getUser();
  } catch {
    location.href='auth.html?mode=login';
  }
}

/* Notes loading & filtering */
const categoryLists = [
  document.getElementById('categoryList'),
  document.getElementById('categoryListMobile')
];
const notesContainer = document.getElementById('notes-container');
const searchInput = document.getElementById('searchInput');
const resultsSummary = document.getElementById('resultsSummary');
let allNotesData = [];
let activeCategory = 'all';

function cloneCategoriesToMobile(){
  const desktop = categoryLists[0];
  const mobile = categoryLists[1];
  if(!desktop || !mobile) return;
  mobile.innerHTML = desktop.innerHTML;
}
cloneCategoriesToMobile();

function escapeHtml(str){
  return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function renderNotes(list){
  notesContainer.innerHTML = '';
  if(list.length === 0){
    notesContainer.innerHTML = `
      <div class="note-card inline-info" data-category="placeholder-note">
        <h3>No Notes Found</h3>
        <p>Try a different search or upload new notes.</p>
        <div class="note-actions">
          <a href="upload.html">Upload Now</a>
        </div>
      </div>`;
    resultsSummary.textContent = '0 results';
    return;
  }
  list.forEach(note=>{
    const card = document.createElement('div');
    card.className='note-card';
    card.dataset.category = note.subject_code;
    const notesTypeDisplay = note.notes_type
      ? note.notes_type.replace(/_/g,' ').replace(/\\b\\w/g,c=>c.toUpperCase())
      : 'Note';
    card.innerHTML = `
      <h3>${escapeHtml(note.title)}</h3>
      <p>${escapeHtml(note.description || 'No description provided.')}</p>
      <div class="tags">
        <span class="category-tag">${escapeHtml(note.academic_year.replace('year','Year '))}</span>
        <span class="category-tag">${escapeHtml(note.semester.replace('semester','Semester '))}</span>
        <span class="category-tag">${escapeHtml(note.subject_code)}</span>
        <span class="category-tag">${escapeHtml(notesTypeDisplay)}</span>
      </div>
      <div class="note-actions">
        <a href="${note.file_url}" target="_blank" rel="noopener">View / Download</a>
      </div>
    `;
    notesContainer.appendChild(card);
  });
  resultsSummary.textContent = list.length + (list.length===1?' result':' results');
}

function renderFiltered(){
  const term = (searchInput.value||'').toLowerCase();
  const filtered = allNotesData.filter(n=>{
    const matchCategory = activeCategory==='all' || n.subject_code === activeCategory;
    const hay = `${n.title} ${n.description||''} ${n.subject_code}`.toLowerCase();
    const matchSearch = !term || hay.includes(term);
    return matchCategory && matchSearch;
  });
  renderNotes(filtered);
}

async function loadNotes(){
  try {
    allNotesData = await fetchNotes();
    renderFiltered();
  } catch(err){
    notesContainer.innerHTML = `
      <div class="note-card inline-info">
        <h3>Error Loading Notes</h3>
        <p>${escapeHtml(err.message || 'There was a problem loading your notes.')}</p>
        <div class="note-actions">
          <a href="#" onclick="location.reload();return false;">Reload Page</a>
        </div>
      </div>`;
    resultsSummary.textContent='';
  }
}

/* Category link handling (desktop + mobile) */
function bindCategoryClicks(listEl){
  listEl?.querySelectorAll('a').forEach(link=>{
    link.addEventListener('click', e=>{
      e.preventDefault();
      listEl.querySelectorAll('a').forEach(l=> l.removeAttribute('aria-current'));
      link.setAttribute('aria-current','true');
      activeCategory = link.dataset.category || 'all';
      // sync other list
      categoryLists.forEach(cl=>{
        if(cl !== listEl){
          cl.querySelectorAll('a').forEach(l=> l.removeAttribute('aria-current'));
          const match = cl.querySelector(`a[data-category="${activeCategory}"]`);
          const allMatch = activeCategory==='all' && cl.querySelector('a[data-category="all"]');
            (match || allMatch)?.setAttribute('aria-current','true');
        }
      });
      renderFiltered();
      if(window.innerWidth <= 930){
        closeDrawer(true);
      }
    });
  });
}
categoryLists.forEach(bindCategoryClicks);

searchInput.addEventListener('input', renderFiltered);

/* Drawer + gesture */
const drawer = document.getElementById('mobileDrawer');
const overlay = document.getElementById('drawerOverlay');
const menuBtn = document.getElementById('menuBtn');
const closeDrawerBtn = document.getElementById('closeDrawerBtn');
const floatingClose = document.getElementById('drawerCloseFloating');

function openDrawer(){
  drawer.classList.add('open');
  overlay.classList.add('visible');
  drawer.setAttribute('aria-hidden','false');
  floatingClose.classList.add('active');
  floatingClose.style.display='flex';
}
function closeDrawer(focusMenu){
  drawer.classList.remove('open');
  overlay.classList.remove('visible');
  drawer.setAttribute('aria-hidden','true');
  floatingClose.classList.remove('active');
  floatingClose.style.display='none';
  if(focusMenu) menuBtn.focus({preventScroll:true});
}

menuBtn.addEventListener('click', ()=> openDrawer());
closeDrawerBtn.addEventListener('click', ()=> closeDrawer(true));
floatingClose.addEventListener('click', ()=> closeDrawer(true));
overlay.addEventListener('click', ()=> closeDrawer(true));

let startX=null, currentX=null, dragging=false, drawerWasOpen=false;
const EDGE=28;

function onTouchStart(e){
  if(e.touches.length!==1) return;
  const x = e.touches[0].clientX;
  drawerWasOpen = drawer.classList.contains('open');
  if(!drawerWasOpen && x > EDGE) return; // only start from edge if closed
  if(drawerWasOpen && x > drawer.offsetWidth) return; // allow swipe close if touch inside drawer
  startX = x;
  currentX = x;
  dragging = true;
  drawer.style.transition='none';
}

function onTouchMove(e){
  if(!dragging) return;
  currentX = e.touches[0].clientX;
  const dx = currentX - startX;
  if(!drawerWasOpen){
    // drag to open (dx positive)
    const translate = Math.min(0, -drawer.offsetWidth + Math.max(dx,0));
    drawer.style.transform = `translateX(${translate}px)`;
    if(dx > 10) overlay.classList.add('visible');
  } else {
    // drag to close (dx negative)
    const translate = Math.min(0, Math.max(dx, -drawer.offsetWidth));
    drawer.style.transform = `translateX(${translate}px)`;
    if(dx < -10){
      overlay.style.opacity = Math.max(0, 1 - Math.abs(dx)/drawer.offsetWidth);
    }
  }
}

function onTouchEnd(){
  if(!dragging){ return; }
  drawer.style.transition='';
  const dx = currentX - startX;
  if(!drawerWasOpen){
    if(dx > 80){
      drawer.style.transform='';
      openDrawer();
    } else {
      drawer.style.transform='';
      closeDrawer(false);
    }
  } else {
    if(dx < -80){
      closeDrawer(false);
      drawer.style.transform='';
      overlay.style.opacity='';
    } else {
      drawer.style.transform='';
      overlay.style.opacity='';
      openDrawer();
    }
  }
  dragging=false;
  startX=null;
}

window.addEventListener('touchstart', onTouchStart, {passive:true});
window.addEventListener('touchmove', onTouchMove, {passive:true});
window.addEventListener('touchend', onTouchEnd, {passive:true});

/* Init */
verifyUser().then(loadNotes);
</script>
</body>
</html>