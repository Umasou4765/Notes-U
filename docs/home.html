<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="color-scheme" content="light dark">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Notes-U</title>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f8f8f8; --text:#333; --label:#666;
  --container:#fff; --border:rgba(0,0,0,0.14);
  --accent:#0d6efd; --accent-hover:#0b5ed7;
  --shadow:0 2px 4px rgba(0,0,0,0.08);
  --shadow-strong:0 4px 14px rgba(0,0,0,0.12);
  --focus-ring:0 0 0 3px rgba(13,110,253,.35);
  --danger:#d23d3d;
  --warn:#e0a800;
  --success:#1f9d55;
  --card-hover-bg:rgba(0,0,0,0.035);
  --transition:.25s ease;
  --dialog-backdrop:rgba(0,0,0,0.35);
}
body.dark {
  --bg:#1a1a1a; --text:#f2f2f2; --label:#b0b0b0;
  --container:#222; --border:rgba(255,255,255,0.12);
  --shadow:0 2px 4px rgba(0,0,0,0.6);
  --shadow-strong:0 4px 14px rgba(0,0,0,0.7);
  --card-hover-bg:rgba(255,255,255,0.06);
  --dialog-backdrop:rgba(0,0,0,0.55);
}
* { box-sizing:border-box; }
body {
  font-family:'Inter',system-ui,Arial,sans-serif;
  margin:0; background:var(--bg); color:var(--text);
  display:flex; flex-direction:column; min-height:100vh;
  transition:background .3s,color .3s;
}
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 28px; background:var(--container);
  box-shadow:var(--shadow); position:sticky; top:0; z-index:20;
  border-bottom:1px solid var(--border);
}
.brand { display:flex; align-items:center; gap:12px; user-select:none; }
.logo {
  font-size:1.7rem; font-weight:700; color:inherit;
  display:flex; align-items:center; justify-content:center;
  width:46px; height:46px; border:2px solid currentColor; border-radius:12px;
}
.site-title { font-size:1.25rem; font-weight:700; letter-spacing:-.5px; }
.header-actions { display:flex; gap:12px; align-items:center; }

.icon-btn, .icon-btn:visited, .clear-filters {
  --btn-bg:var(--accent);
  --btn-bg-hover:var(--accent-hover);
  background:var(--btn-bg);
  color:#fff; border:none; cursor:pointer;
  padding:10px 16px; font-size:.8rem; font-weight:600;
  border-radius:10px; display:inline-flex; gap:8px; align-items:center;
  text-decoration:none; letter-spacing:.4px;
  box-shadow:0 4px 14px -6px rgba(0,90,200,0.45), 0 2px 7px -4px rgba(0,70,160,0.4);
  transition:background .25s, transform .35s, box-shadow .35s;
}
.clear-filters { gap:6px; }
.icon-btn svg { width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; }
.icon-btn:hover, .clear-filters:hover { transform:translateY(-2px); box-shadow:0 8px 24px -10px rgba(0,70,170,0.55), 0 4px 14px -6px rgba(0,70,160,0.4); }
.icon-btn:active, .clear-filters:active { transform:translateY(0) scale(.95); }
.icon-btn:focus-visible, .clear-filters:focus-visible { outline:none; box-shadow:var(--focus-ring); }

.icon-btn.logout {
  --btn-bg:transparent;
  --btn-bg-hover:rgba(0,0,0,0.07);
  color:var(--text);
  background:var(--btn-bg);
  border:1px solid var(--border);
  box-shadow:none;
}
.icon-btn.logout:hover { background:var(--btn-bg-hover); box-shadow:none; }
body.dark .icon-btn.logout:hover { --btn-bg-hover:rgba(255,255,255,0.12); }

.view-toggle { display:flex; gap:6px; align-items:center; }
.view-btn {
  background:transparent;
  border:1px solid var(--border);
  padding:7px 12px;
  border-radius:8px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  font-size:.68rem;
  letter-spacing:.4px;
  font-weight:600;
  color:var(--label);
  transition:background var(--transition),color var(--transition),border-color var(--transition);
}
.view-btn[aria-pressed="true"] {
  background:var(--card-hover-bg);
  color:var(--text);
  border-color:var(--accent);
}
.view-btn:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }

main {
  flex-grow:1; display:grid; grid-template-columns:290px 1fr; gap:26px;
  padding:28px; max-width:1400px; width:100%; margin:0 auto; box-sizing:border-box;
}
aside.sidebar, .content-area {
  background:var(--container); border-radius:14px; padding:22px;
  box-shadow:var(--shadow); border:1px solid var(--border); min-height:0;
  display:flex; flex-direction:column;
}
nav.sidebar-nav { flex:1 1 auto; overflow-y:auto; }
h2 { margin:0 0 18px; font-size:1.1rem; text-transform:uppercase; letter-spacing:.7px; font-weight:600; opacity:.85;}
ul.category-list { list-style:none; margin:0; padding:0; }
ul.category-list li { margin-bottom:2px; }
ul.category-list a {
  display:block; padding:7px 10px; text-decoration:none;
  color:var(--label); border-radius:8px; font-size:.78rem;
  transition:background .18s,color .18s;
}
ul.category-list a[aria-current="true"],
ul.category-list a:hover {
  background:rgba(0,0,0,0.07); color:var(--text);
}
body.dark ul.category-list a:hover,
body.dark ul.category-list a[aria-current="true"] {
  background:rgba(255,255,255,0.12);
}
.category-semester-separator {
  font-size:.58rem; font-weight:700; letter-spacing:.9px;
  text-transform:uppercase; margin:10px 0 4px; opacity:.55; padding-left:4px;
}

.filters-bar {
  display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px;
}
.filters-bar .search-wrap { position:relative; flex:1 1 260px; }
.filters-bar input[type="search"] {
  width:100%; padding:10px 14px 10px 40px; font-size:.85rem;
  border:1px solid var(--border); border-radius:8px; background:transparent; color:inherit;
  transition:border-color .25s;
}
.filters-bar input[type="search"]:focus { outline:2px solid var(--accent); outline-offset:2px; }
.filters-bar svg.search-icon {
  position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.55;
}
select.sort-select {
  padding:10px 12px; font:inherit; font-size:.8rem;
  border:1px solid var(--border); background:transparent; color:inherit;
  border-radius:8px; min-width:140px;
  transition:border-color .25s;
}
select.sort-select:focus { outline:2px solid var(--accent); outline-offset:2px; }

.results-summary {
  font-size:.68rem; letter-spacing:.45px; margin:4px 0 16px;
  color:var(--label);
}

.note-grid {
  --col-min:260px;
  display:grid; gap:18px;
  grid-template-columns:repeat(auto-fill,minmax(var(--col-min),1fr));
}
.note-list {
  display:flex; flex-direction:column; gap:12px;
}
body.view-list .note-card { /* list style accent */
  border-left:4px solid var(--accent);
  padding-left:14px;
}
.note-card {
  background:transparent; border:1px solid var(--border); border-radius:12px;
  padding:14px 16px 12px; display:flex; flex-direction:column;
  box-shadow:0 2px 6px rgba(0,0,0,0.04); transition:transform .18s, box-shadow .18s, background .3s;
  position:relative;
}
.note-card:hover { transform:translateY(-2px); box-shadow:var(--shadow-strong); background:var(--card-hover-bg); }
.note-header {
  display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
}
.note-header h3 {
  margin:0; font-size:.95rem; line-height:1.25; flex:1 1 auto; word-break:break-word;
}
.pin-btn {
  background:transparent; border:none; cursor:pointer;
  font-size:1.05rem; line-height:1; padding:4px 6px;
  color:var(--label);
  border-radius:6px;
  transition:background .2s,color .2s;
}
.pin-btn:hover,
.pin-btn:focus-visible {
  background:var(--card-hover-bg);
  color:var(--accent);
  outline:none;
}
.pin-btn[aria-pressed="true"] { color:var(--accent); }
.note-card p { margin:6px 0 10px; font-size:.73rem; line-height:1.35; color:var(--label); }

.meta-line {
  font-size:.55rem; letter-spacing:.5px; opacity:.65; margin-top:auto;
  display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;
}
.note-actions {
  display:flex; flex-wrap:wrap; gap:10px; margin-top:2px;
}
.note-actions button,
.note-actions a.action-link {
  font-size:.58rem; font-weight:600; letter-spacing:.5px;
  background:transparent; border:1px solid var(--border);
  padding:6px 10px; border-radius:8px; cursor:pointer;
  color:var(--label); text-decoration:none; display:inline-flex; align-items:center; gap:4px;
  transition:background .2s,color .2s,border-color .25s;
}
.note-actions button:hover,
.note-actions a.action-link:hover {
  background:var(--card-hover-bg);
  color:var(--text);
}
.note-actions button:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }

mark {
  background:#ffeb88;
  color:inherit;
  padding:0 2px;
  border-radius:3px;
}
body.dark mark { background:#665500; }

.section-heading {
  font-size:.72rem; text-transform:uppercase; letter-spacing:.8px;
  font-weight:700; margin:22px 0 8px;
  opacity:.75;
}

.skeleton {
  position:relative;
  overflow:hidden;
  background:var(--card-hover-bg);
  border:1px solid var(--border);
  border-radius:12px;
  height:120px;
}
.skeleton::after {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
  animation:shimmer 1.2s infinite;
  mix-blend-mode:overlay;
  opacity:.65;
}
body.dark .skeleton::after {
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
}
@keyframes shimmer {
  0%{transform:translateX(-100%);}
  100%{transform:translateX(100%);}
}

footer {
  text-align:center; font-size:.7rem; padding:18px; opacity:.7;
  border-top:1px solid var(--border); margin-top:auto;
}
@media (max-width:960px){
  main { grid-template-columns:1fr; }
  aside.sidebar { order:2; }
  .content-area { order:1; }
}
@media (max-width:660px){
  .filters-bar { flex-direction:column; align-items:stretch; }
  .filters-bar .search-wrap, select.sort-select, .clear-filters { width:100%; }
  .view-toggle { justify-content:flex-start; }
  .note-actions button,
  .note-actions a.action-link { font-size:.6rem; }
}

/* Dialog styling (fix white in dark mode) */
dialog {
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px 22px 18px;
  background:var(--container);
  color:var(--text);
  box-shadow:0 18px 50px -12px rgba(0,0,0,.35);
  max-width:480px;
}
dialog::backdrop {
  background:var(--dialog-backdrop);
  backdrop-filter:blur(2px);
}
dialog form input, dialog form textarea, dialog form select {
  width:100%;
  font:inherit;
  background:transparent;
  color:inherit;
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px 10px;
  resize:vertical;
}
dialog form input:focus,
dialog form textarea:focus,
dialog form select:focus {
  outline:2px solid var(--accent);
  outline-offset:2px;
}
.dialog-buttons button {
  cursor:pointer;
}

/* Visually hidden helper */
.visually-hidden {
  position:absolute;
  left:-9999px;
  top:auto;
  width:1px;
  height:1px;
  overflow:hidden;
  clip:rect(1px,1px,1px,1px);
  white-space:nowrap;
}
</style>
</head>
<body class="view-grid">
<header role="banner">
  <div class="brand" aria-label="Notes-U">
    <div class="logo" aria-hidden="true">U</div>
    <span class="site-title">Notes-U</span>
  </div>
  <div class="header-actions">
    <div class="view-toggle" role="group" aria-label="View mode">
      <button id="gridViewBtn" class="view-btn" aria-pressed="true">Grid</button>
      <button id="listViewBtn" class="view-btn" aria-pressed="false">List</button>
    </div>
    <a href="upload.html" class="icon-btn" id="upload-note-btn" aria-label="Upload Note">
      <svg viewBox="0 0 24 24"><path d="M12 16V4m0 0l-5 5m5-5l5 5"/><path d="M4 20h16"/></svg>
      <span>Upload</span>
    </a>
    <button class="icon-btn logout" id="logout-btn" aria-label="Log out">
      <svg viewBox="0 0 24 24">
        <path d="M15 3h-6a2 2 0 00-2 2v3"/>
        <path d="M9 21h6a2 2 0 002-2v-3"/>
        <path d="M16 12H8"/>
        <path d="M11 9l-3 3 3 3"/>
      </svg>
      <span>Log Out</span>
    </button>
  </div>
</header>

<main role="main">
  <aside class="sidebar" aria-label="Filters">
    <h2>Subjects</h2>
    <nav class="sidebar-nav" aria-label="Subject categories">
      <ul class="category-list" id="categoryList">
        <li><a href="#" data-category="all" aria-current="true">All Notes</a></li>
        <li class="category-semester-separator">Year 1 Semester 1</li>
        <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
        <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
        <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
        <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
        <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
        <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
        <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
        <li class="category-semester-separator">Year 1 Semester 2</li>
        <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
        <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
        <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
        <li class="category-semester-separator">Year 1 Semester 3</li>
        <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
        <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
        <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
        <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
        <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
        <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
        <li class="category-semester-separator">Year 2 Semester 1</li>
        <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
        <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
        <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
        <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
        <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
        <li class="category-semester-separator">Year 2 Semester 2</li>
        <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
        <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
        <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
        <li class="category-semester-separator">Year 2 Semester 3</li>
        <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
      </ul>
    </nav>
  </aside>

  <section class="content-area" aria-labelledby="notesHeading">
    <h1 id="notesHeading" style="margin:0 0 10px;font-size:1.55rem;letter-spacing:-.5px;">Your Notes & Resources</h1>

    <div class="filters-bar">
      <div class="search-wrap">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.8-4.8m0 0A7.2 7.2 0 105.4 5.4a7.2 7.2 0 0010.8 10.8z"/>
        </svg>
        <input id="searchInput" type="search" placeholder="Search title or description..." autocomplete="off" aria-label="Search notes">
      </div>
      <select id="sortSelect" class="sort-select" aria-label="Sort notes">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="title">Title A–Z</option>
      </select>
      <button id="clearFiltersBtn" class="clear-filters" type="button" aria-label="Clear filters">
        <!-- simple icon -->
        ✕ <span style="font-weight:600;">Clear</span>
      </button>
    </div>

    <div id="resultsSummary" class="results-summary" aria-live="polite"></div>

    <div id="notes-container" aria-live="polite"></div>

    <div id="actionAnnouncer" class="visually-hidden" aria-live="polite"></div>
  </section>
</main>

<footer>&copy; 2025 Notes-U. All rights reserved.</footer>

<!-- Edit Dialog -->
<dialog id="editDialog">
  <form method="dialog" id="editForm" novalidate>
    <h3 style="margin-top:0;font-size:1rem;">Edit Note</h3>
    <input type="hidden" id="editNoteId">
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:6px;">
      <label style="font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;display:flex;flex-direction:column;gap:4px;">
        Title
        <input id="editTitle" required>
      </label>
      <label style="font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;display:flex;flex-direction:column;gap:4px;">
        Description
        <textarea id="editDescription" rows="4"></textarea>
      </label>
      <!-- Keep type selectable (even if hidden in cards) -->
      <label style="font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;display:flex;flex-direction:column;gap:4px;">
        Type
        <select id="editType">
          <option value="lecture_notes">Lecture Notes</option>
          <option value="tutorial_solutions">Tutorial Solutions</option>
          <option value="past_year_papers">Past Year Papers</option>
        </select>
      </label>
    </div>
    <div class="dialog-buttons" style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button type="submit" value="save" style="background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;">Save</button>
      <button type="button" id="editCancelBtn" style="background:transparent;border:1px solid var(--border);padding:8px 14px;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;">Cancel</button>
    </div>
    <p id="editStatus" style="font-size:.6rem;letter-spacing:.4px;margin:8px 0 0;color:var(--label);min-height:1em;"></p>
  </form>
</dialog>

<!-- Delete Confirm Dialog -->
<dialog id="deleteDialog">
  <form method="dialog" id="deleteForm" novalidate>
    <h3 style="margin-top:0;font-size:1rem;">Delete Note</h3>
    <input type="hidden" id="deleteNoteId">
    <p style="font-size:.8rem;line-height:1.4;">Are you sure you want to permanently delete this note?</p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:18px;">
      <button type="submit" value="confirm" style="background:var(--danger);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;">Delete</button>
      <button type="button" id="deleteCancelBtn" style="background:transparent;border:1px solid var(--border);padding:8px 14px;border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;">Cancel</button>
    </div>
  </form>
</dialog>

<script type="module">
import { onAuth, logout, fetchMyNotes, updateNote, deleteNote, togglePin } from './firebase-init.js';

/* THEME INIT */
(function initTheme(){
  const stored = localStorage.getItem('theme');
  function apply(t){
    document.body.classList.remove('light','dark');
    document.body.classList.add(t);
    localStorage.setItem('theme', t);
  }
  if(stored) apply(stored);
  else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
    if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
  });
  window.addEventListener('storage', e=>{
    if(e.key==='theme' && e.newValue) apply(e.newValue);
  });
})();

/* ELEMENTS */
const logoutButton   = document.getElementById('logout-btn');
const notesContainer = document.getElementById('notes-container');
const searchInput    = document.getElementById('searchInput');
const sortSelect     = document.getElementById('sortSelect');
const categoryList   = document.getElementById('categoryList');
const clearFiltersBtn= document.getElementById('clearFiltersBtn');
const resultsSummary = document.getElementById('resultsSummary');
const gridViewBtn    = document.getElementById('gridViewBtn');
const listViewBtn    = document.getElementById('listViewBtn');
const actionAnnouncer= document.getElementById('actionAnnouncer');
const editDialog     = document.getElementById('editDialog');
const editForm       = document.getElementById('editForm');
const editNoteId     = document.getElementById('editNoteId');
const editTitle      = document.getElementById('editTitle');
const editDescription= document.getElementById('editDescription');
const editType       = document.getElementById('editType');
const editStatus     = document.getElementById('editStatus');
const editCancelBtn  = document.getElementById('editCancelBtn');
const deleteDialog   = document.getElementById('deleteDialog');
const deleteForm     = document.getElementById('deleteForm');
const deleteNoteId   = document.getElementById('deleteNoteId');
const deleteCancelBtn= document.getElementById('deleteCancelBtn');

/* STATE */
const state = {
  rawNotes: [],
  filtered: [],
  category: localStorage.getItem('notes.category') || 'all',
  search: localStorage.getItem('notes.search') || '',
  sort: localStorage.getItem('notes.sort') || 'newest',
  view: localStorage.getItem('notes.view') || 'grid'
};

/* UTILITIES */
function escapeHtml(str=''){
  return str.replace(/[&<>"']/g, c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}
function formatDate(ts){
  if(!ts) return '';
  const d = new Date(ts);
  return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
}
function formatSize(bytes){
  if(!(bytes>=0)) return '';
  if(bytes < 1024) return bytes + ' B';
  if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB';
  return (bytes/1024/1024).toFixed(2)+' MB';
}
function highlight(text, term){
  if(!term) return escapeHtml(text);
  const esc = escapeHtml(text);
  try{
    const re = new RegExp('('+term.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+')','ig');
    return esc.replace(re,'<mark>$1</mark>');
  }catch{ return esc; }
}
function announce(msg){
  actionAnnouncer.textContent = msg;
  setTimeout(()=>{ if(actionAnnouncer.textContent===msg) actionAnnouncer.textContent=''; }, 4000);
}
function persist(){
  localStorage.setItem('notes.category', state.category);
  localStorage.setItem('notes.search', state.search);
  localStorage.setItem('notes.sort', state.sort);
  localStorage.setItem('notes.view', state.view);
}

/* SKELETON */
function renderSkeleton(){
  const count = state.view==='list'?4:6;
  notesContainer.innerHTML='';
  const wrapper = document.createElement('div');
  wrapper.className = state.view==='list' ? 'note-list' : 'note-grid';
  for(let i=0;i<count;i++){
    const s = document.createElement('div');
    s.className='skeleton';
    wrapper.appendChild(s);
  }
  notesContainer.appendChild(wrapper);
}

/* RENDER */
function renderNotes(){
  notesContainer.innerHTML='';
  const pinned = state.filtered.filter(n=> n.pinned);
  const unpinned= state.filtered.filter(n=> !n.pinned);

  if(pinned.length){
    const h = document.createElement('div');
    h.className='section-heading';
    h.textContent='Pinned';
    notesContainer.appendChild(h);
    notesContainer.appendChild(renderNoteGroup(pinned));
  }
  if(unpinned.length){
    if(pinned.length){
      const h2 = document.createElement('div');
      h2.className='section-heading';
      h2.textContent='All Notes';
      notesContainer.appendChild(h2);
    }
    notesContainer.appendChild(renderNoteGroup(unpinned));
  }
  if(!pinned.length && !unpinned.length){
    notesContainer.innerHTML=`
      <div class="note-card">
        <div class="note-header"><h3>No Notes Found</h3></div>
        <p>No notes match your filters. Try clearing filters or upload a new note.</p>
        <div class="note-actions">
          <a class="action-link" href="upload.html">Upload Now</a>
        </div>
        <div class="meta-line"><span>—</span><span>—</span></div>
      </div>`;
  }
  updateSummary();
}

function renderNoteGroup(list){
  const wrap = document.createElement('div');
  wrap.className = state.view==='list' ? 'note-list' : 'note-grid';
  for(const n of list){
    const title = n.title || '(Untitled)';
    const titleHTML = highlight(title, state.search);
    const descHTML  = highlight(n.description || 'No description provided.', state.search);
    const dateStr = formatDate(n.createdAt);
    const sizeStr = formatSize(n.file_size);
    const card = document.createElement('article');
    card.className='note-card';
    card.dataset.id = n.id;
    card.dataset.category = n.subject_code;

    card.innerHTML=`
      <div class="note-header">
        <h3>${titleHTML}</h3>
        <button class="pin-btn" data-action="pin" data-id="${n.id}" aria-pressed="${n.pinned?'true':'false'}" aria-label="${n.pinned?'Unpin':'Pin'} note">
          ${n.pinned ? '★' : '☆'}
        </button>
      </div>
      <p>${descHTML}</p>
      <div class="note-actions">
        <a class="action-link" href="${n.file_url}" target="_blank" rel="noopener noreferrer" data-action="open" data-id="${n.id}">Open</a>
        <button data-action="edit" data-id="${n.id}">Edit</button>
        <button data-action="delete" data-id="${n.id}">Delete</button>
      </div>
      <div class="meta-line">
        <span>${dateStr}</span>
        <span>${sizeStr}</span>
      </div>
    `;
    wrap.appendChild(card);
  }
  return wrap;
}

function updateSummary(){
  const total = state.rawNotes.length;
  const shown = state.filtered.length;
  const pinnedCount = state.filtered.filter(n=>n.pinned).length;
  const catLabel = state.category === 'all' ? 'All' : state.category;
  resultsSummary.textContent =
    `${shown} of ${total} notes · Category: ${catLabel} · Sort: ${state.sort} · View: ${state.view}${pinnedCount?` · Pinned: ${pinnedCount}`:''}${state.search ? ' · Search: '+state.search : ''}`;
}

/* FILTER PIPELINE */
function applyFilters(){
  let list = [...state.rawNotes];
  if(state.category !== 'all'){
    list = list.filter(n=> n.subject_code === state.category);
  }
  const term = state.search.toLowerCase();
  if(term){
    list = list.filter(n=>{
      const hay = `${n.title||''} ${n.description||''}`.toLowerCase();
      return hay.includes(term);
    });
  }
  switch(state.sort){
    case 'oldest': list.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)); break;
    case 'title': list.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); break;
    case 'newest':
    default: list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }
  state.filtered = list;
  renderNotes();
}

/* CATEGORY EVENTS */
categoryList.addEventListener('click', e=>{
  const a = e.target.closest('a[data-category]');
  if(!a) return;
  e.preventDefault();
  [...categoryList.querySelectorAll('a[data-category]')].forEach(el=> el.removeAttribute('aria-current'));
  a.setAttribute('aria-current','true');
  state.category = a.dataset.category;
  persist();
  applyFilters();
});
if(state.category !== 'all'){
  const el = categoryList.querySelector(`a[data-category="${state.category}"]`);
  if(el){
    categoryList.querySelectorAll('a[data-category]').forEach(a=>a.removeAttribute('aria-current'));
    el.setAttribute('aria-current','true');
  }
}

/* SEARCH */
let searchTimer=null;
searchInput.value = state.search;
searchInput.addEventListener('input', e=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{
    state.search = e.target.value.trim();
    persist();
    applyFilters();
  }, 200);
});

/* SORT */
sortSelect.value = state.sort;
sortSelect.addEventListener('change', e=>{
  state.sort = e.target.value;
  persist();
  applyFilters();
});

/* CLEAR FILTERS */
clearFiltersBtn.addEventListener('click', ()=>{
  state.category='all';
  state.search='';
  state.sort='newest';
  searchInput.value='';
  sortSelect.value='newest';
  categoryList.querySelectorAll('a[data-category]').forEach(a=>a.removeAttribute('aria-current'));
  const allLink = categoryList.querySelector('a[data-category="all"]');
  if(allLink) allLink.setAttribute('aria-current','true');
  persist();
  applyFilters();
  announce('Filters cleared');
});

/* VIEW TOGGLE */
function updateViewButtons(){
  gridViewBtn.setAttribute('aria-pressed', state.view==='grid');
  listViewBtn.setAttribute('aria-pressed', state.view==='list');
  document.body.classList.toggle('view-grid', state.view==='grid');
  document.body.classList.toggle('view-list', state.view==='list');
}
gridViewBtn.addEventListener('click', ()=>{
  if(state.view==='grid') return;
  state.view='grid'; persist(); updateViewButtons(); applyFilters();
});
listViewBtn.addEventListener('click', ()=>{
  if(state.view==='list') return;
  state.view='list'; persist(); updateViewButtons(); applyFilters();
});
updateViewButtons();

/* LOGOUT */
logoutButton.addEventListener('click', async ()=>{
  try { await logout(); localStorage.setItem('recentLogout','1'); }
  finally { location.replace('auth.html?mode=login'); }
});

/* BFCache GUARD */
window.addEventListener('pageshow', e=>{
  if(e.persisted && localStorage.getItem('recentLogout')==='1'){
    location.replace('auth.html?mode=login');
  }
});

/* NOTE ACTIONS */
notesContainer.addEventListener('click', async e=>{
  const btn = e.target.closest('[data-action]');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  if(!id) return;

  if(action === 'pin'){
    const note = state.rawNotes.find(n=>n.id===id);
    if(!note) return;
    const newVal = !note.pinned;
    btn.disabled=true;
    try {
      await togglePin(id,newVal);
      note.pinned=newVal;
      applyFilters();
      announce(newVal?'Note pinned':'Note unpinned');
      const refocus = notesContainer.querySelector(`button[data-action="pin"][data-id="${id}"]`);
      refocus?.focus();
    } catch(err){
      announce('Pin update failed');
    } finally { btn.disabled=false; }
  }
  if(action === 'edit'){
    openEdit(id);
  }
  if(action === 'delete'){
    openDelete(id);
  }
});

/* EDIT */
function openEdit(id){
  const note = state.rawNotes.find(n=>n.id===id);
  if(!note) return;
  editNoteId.value=id;
  editTitle.value=note.title||'';
  editDescription.value=note.description||'';
  editType.value=note.notes_type||'lecture_notes';
  editStatus.textContent='';
  if(!editDialog.open) editDialog.showModal();
  setTimeout(()=>editTitle.focus(),50);
}
editCancelBtn.addEventListener('click', ()=> editDialog.close());
editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = editNoteId.value;
  if(!id) return;
  editStatus.textContent='Saving...';
  try {
    await updateNote(id,{
      title: editTitle.value.trim(),
      description: editDescription.value.trim(),
      notes_type: editType.value
    });
    const note = state.rawNotes.find(n=>n.id===id);
    if(note){
      note.title = editTitle.value.trim();
      note.description = editDescription.value.trim();
      note.notes_type = editType.value;
    }
    applyFilters();
    announce('Note updated');
    editStatus.textContent='Saved';
    setTimeout(()=> editDialog.close(),400);
  } catch(err){
    editStatus.textContent=err.message||'Save failed';
  }
});

/* DELETE */
function openDelete(id){
  deleteNoteId.value=id;
  if(!deleteDialog.open) deleteDialog.showModal();
}
deleteCancelBtn.addEventListener('click', ()=> deleteDialog.close());
deleteForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const id = deleteNoteId.value;
  if(!id) return;
  try {
    await deleteNote(id);
    state.rawNotes = state.rawNotes.filter(n=>n.id!==id);
    applyFilters();
    announce('Note deleted');
    deleteDialog.close();
  } catch(err){
    announce('Delete failed');
    deleteDialog.close();
  }
});

/* DATA LOADING */
async function loadNotes(){
  renderSkeleton();
  try {
    state.rawNotes = await fetchMyNotes();
    applyFilters();
  } catch(err){
    notesContainer.innerHTML=`
      <div class="note-card">
        <div class="note-header"><h3>Error</h3></div>
        <p>${escapeHtml(err.message||'Failed to load notes')}</p>
        <div class="note-actions">
          <button data-reload="1">Reload</button>
        </div>
        <div class="meta-line"><span>—</span><span>—</span></div>
      </div>`;
    notesContainer.querySelector('[data-reload]')?.addEventListener('click', ()=> loadNotes());
    resultsSummary.textContent='Could not load notes.';
  }
}

onAuth(user=>{
  if(!user){
    if(location.pathname.endsWith('home.html')){
      location.replace('auth.html?mode=login');
    }
    return;
  }
  if(localStorage.getItem('recentLogout')==='1'){
    localStorage.removeItem('recentLogout');
  }
  if(state.search) searchInput.value=state.search;
  sortSelect.value=state.sort;
  updateViewButtons();
  applyFilters(); 
  loadNotes();
});
</script>
</body>
</html>
