<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Notes-U</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f8f8f8; --text:#333; --label:#666;
      --container:#fff; --border:rgba(0,0,0,0.14);
      --accent:#0d6efd; --accent-hover:#0b5ed7;
      --shadow:0 2px 4px rgba(0,0,0,0.08);
      --shadow-strong:0 4px 14px rgba(0,0,0,0.12);
      --focus-ring:0 0 0 3px rgba(13,110,253,.35);
    }
    body.dark {
      --bg:#1a1a1a; --text:#f2f2f2; --label:#b0b0b0;
      --container:#222; --border:rgba(255,255,255,0.12);
      --shadow:0 2px 4px rgba(0,0,0,0.6);
      --shadow-strong:0 4px 14px rgba(0,0,0,0.7);
    }
    body {
      font-family:'Inter',system-ui,Arial,sans-serif;
      margin:0; background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; min-height:100vh;
      transition:background .3s,color .3s;
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 28px; background:var(--container);
      box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
      border-bottom:1px solid var(--border);
    }
    /* Logo is now static (not a link) */
    .logo {
      font-size:1.7rem; font-weight:700; color:inherit;
      display:flex; align-items:center; justify-content:center;
      width:46px; height:46px; border:2px solid currentColor; border-radius:12px;
      user-select:none;
    }
    .logo[tabindex="-1"] { outline:none; }
    .header-actions { display:flex; gap:12px; }

    .icon-btn, .icon-btn:visited {
      --btn-bg:var(--accent);
      --btn-bg-hover:var(--accent-hover);
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px 10px 14px;
      border:none;
      border-radius:10px;
      background:linear-gradient(135deg,var(--btn-bg),var(--btn-bg-hover) 115%);
      color:#fff;
      font-size:.85rem;
      font-weight:600;
      text-decoration:none;
      cursor:pointer;
      line-height:1.1;
      box-shadow:0 4px 14px -6px rgba(0,60,140,0.45), 0 2px 8px -4px rgba(0,60,140,0.30);
      transition:background .35s, transform .35s, box-shadow .4s;
      position:relative;
    }
    .icon-btn svg {
      width:18px; height:18px;
      stroke:currentColor;
      stroke-width:1.8;
      fill:none;
      flex-shrink:0;
    }
    .icon-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 24px -10px rgba(0,70,170,0.55), 0 4px 14px -6px rgba(0,70,160,0.4);
    }
    .icon-btn:active {
      transform:translateY(0) scale(.95);
    }
    .icon-btn:focus-visible {
      outline:none;
      box-shadow:var(--focus-ring);
    }
    /* Secondary / logout style */
    .icon-btn.logout {
      --btn-bg:transparent;
      --btn-bg-hover:rgba(0,0,0,0.07);
      color:var(--text);
      background:var(--btn-bg);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .icon-btn.logout:hover {
      background:var(--btn-bg-hover);
      box-shadow:none;
    }
    body.dark .icon-btn.logout:hover {
      --btn-bg-hover:rgba(255,255,255,0.12);
    }
    body.dark .icon-btn.logout {
      background:transparent;
    }

    main {
      flex-grow:1; display:grid; grid-template-columns:300px 1fr; gap:26px;
      padding:28px; max-width:1400px; width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    aside.sidebar, .content-area {
      background:var(--container); border-radius:14px; padding:22px;
      box-shadow:var(--shadow); border:1px solid var(--border);
      min-height:0;
    }
    .sidebar { overflow-y:auto; }
    h2 { margin:0 0 18px; font-size:1.45rem; }
    ul.category-list { list-style:none; margin:0; padding:0; }
    ul.category-list li { margin-bottom:4px; }
    ul.category-list a {
      display:block; padding:8px 10px; text-decoration:none;
      color:var(--label); border-radius:8px; font-size:.85rem;
      transition:background .2s,color .2s;
    }
    ul.category-list a:hover, ul.category-list a.active {
      background:rgba(0,0,0,0.07); color:var(--text);
    }
    body.dark ul.category-list a:hover,
    body.dark ul.category-list a.active {
      background:rgba(255,255,255,0.12);
    }
    .category-semester-separator {
      font-size:.7rem; font-weight:600; letter-spacing:.8px;
      text-transform:uppercase; margin:10px 0 6px; opacity:.6;
      padding-left:4px;
    }
    .search-bar { position:relative; margin-bottom:18px; }
    .search-bar input {
      width:100%; padding:10px 14px 10px 38px; font-size:.9rem;
      border:1px solid var(--border); border-radius:8px;
      background:transparent; color:inherit; box-sizing:border-box;
    }
    .search-bar input:focus { outline:3px solid rgba(13,110,253,.5); outline-offset:1px; }
    .search-bar svg { position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.6; }
    .note-grid {
      display:grid; gap:18px;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    }
    .note-card {
      background:transparent; border:1px solid var(--border); border-radius:12px;
      padding:16px 16px 14px; display:flex; flex-direction:column;
      box-shadow:0 2px 6px rgba(0,0,0,0.04); transition:transform .18s, box-shadow .18s;
    }
    .note-card:hover {
      transform:translateY(-3px); box-shadow:var(--shadow-strong);
    }
    .note-card h3 { margin:0 0 8px; font-size:1.05rem; line-height:1.3; }
    .note-card p { margin:0 0 12px; font-size:.8rem; line-height:1.4; color:var(--label); }
    .category-tag {
      display:inline-block; font-size:.65rem; padding:5px 8px; background:rgba(0,0,0,0.07);
      border-radius:20px; margin:0 6px 6px 0;
    }
    body.dark .category-tag { background:rgba(255,255,255,0.12); }
    .note-actions a {
      font-size:.75rem; color:var(--accent); text-decoration:none; font-weight:600;
    }
    .note-actions a:hover { text-decoration:underline; }
    footer {
      text-align:center; font-size:.75rem; padding:18px; opacity:.7;
      border-top:1px solid var(--border); margin-top:auto;
    }
    @media (max-width:960px){
      main { grid-template-columns:1fr; }
      aside.sidebar { order:2; }
      .content-area { order:1; }
    }
  </style>
</head>
<body>
  <header>
    <!-- Logo now static (no navigation) -->
    <div class="logo" aria-label="Notes-U Logo" tabindex="-1">U</div>
    <div class="header-actions">
      <a href="upload.html" class="icon-btn" id="upload-note-btn" aria-label="Upload Note">
        <svg viewBox="0 0 24 24">
          <path d="M12 16V4m0 0l-5 5m5-5l5 5"/>
          <path d="M4 20h16"/>
        </svg>
        <span>Upload</span>
      </a>
      <button class="icon-btn logout" id="logout-btn" aria-label="Log out">
        <svg viewBox="0 0 24 24">
          <path d="M15 3h-6a2 2 0 00-2 2v3"/>
          <path d="M9 21h6a2 2 0 002-2v-3"/>
          <path d="M16 12H8"/>
          <path d="M11 9l-3 3 3 3"/>
        </svg>
        <span>Log Out</span>
      </button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <h2>Academic Categories</h2>
      <ul class="category-list" id="categoryList">
        <li><a href="#" class="active" data-category="all">All Notes</a></li>
        <li class="category-semester-separator">Year 1 Semester 1</li>
        <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
        <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
        <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
        <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
        <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
        <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
        <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
        <li class="category-semester-separator">Year 1 Semester 2</li>
        <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
        <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
        <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
        <li class="category-semester-separator">Year 1 Semester 3</li>
        <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
        <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
        <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
        <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
        <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
        <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
        <li class="category-semester-separator">Year 2 Semester 1</li>
        <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
        <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
        <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
        <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
        <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
        <li class="category-semester-separator">Year 2 Semester 2</li>
        <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
        <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
        <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
        <li class="category-semester-separator">Year 2 Semester 3</li>
        <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
      </ul>
    </aside>

    <section class="content-area">
      <h2>Your Notes & Resources</h2>
      <div class="search-bar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.8-4.8m0 0A7.2 7.2 0 105.4 5.4a7.2 7.2 0 0010.8 10.8z"/>
        </svg>
        <input id="searchInput" placeholder="Search notes by title, description, or subject...">
      </div>
      <div id="notes-container" class="note-grid">
        <div class="note-card" data-category="placeholder-note">
          <h3>No Notes Found</h3>
          <p>It looks like there are no notes yet. Upload something to get started.</p>
          <div class="tags">
            <span class="category-tag">Info</span>
            <span class="category-tag">Empty</span>
          </div>
          <div class="note-actions">
            <a href="upload.html">Upload Now</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>&copy; 2025 Notes-U. All rights reserved.</footer>

  <script type="module">
    import { onAuth, logout, fetchMyNotes } from './firebase-init.js';

    // Theme (keep consistent with other pages)
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      function apply(t){
        document.body.classList.remove('light','dark');
        document.body.classList.add(t);
        localStorage.setItem('theme', t);
      }
      if(stored) apply(stored);
      else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
      });
      window.addEventListener('storage', e=>{
        if(e.key==='theme' && e.newValue) apply(e.newValue);
      });
    })();

    const logoutButton   = document.getElementById('logout-btn');
    const notesContainer = document.getElementById('notes-container');
    const searchInput    = document.getElementById('searchInput');
    const categoryList   = document.getElementById('categoryList');

    let allNotesData = [];
    let currentCategory = 'all';
    let searchTerm = '';

    // Stronger logout behavior: replace history so back won't reload home effectively
    logoutButton.addEventListener('click', async ()=>{
      try { await logout(); } catch(_) {}
      // Replace current entry and add popstate guard
      location.replace('auth.html?mode=login');
    });

    // Extra popstate guard (in case of cached back navigation)
    window.addEventListener('pageshow', e=>{
      if(e.persisted){ // from bfcache
        // onAuth below will redirect if no user
      }
    });

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function renderNotes(list){
      notesContainer.innerHTML = '';
      if(!list.length){
        notesContainer.innerHTML = `
          <div class="note-card" data-category="placeholder-note">
            <h3>No Notes Found</h3>
            <p>No notes match your filters. Try another category or clear your search.</p>
            <div class="note-actions"><a href="upload.html">Upload Now</a></div>
          </div>`;
        return;
      }
      for(const note of list){
        const prettyType = (note.notes_type||'')
          .replace(/_/g,' ')
          .replace(/\b\w/g,m=>m.toUpperCase());
        const card = document.createElement('div');
        card.className='note-card';
        card.dataset.category = note.subject_code;
        card.innerHTML = `
          <h3>${escapeHtml(note.title)}</h3>
          <p>${escapeHtml(note.description || 'No description provided.')}</p>
          <div>
            <span class="category-tag">${escapeHtml(note.academic_year.replace('year','Year '))}</span>
            <span class="category-tag">${escapeHtml(note.semester.replace('semester','Semester '))}</span>
            <span class="category-tag">${escapeHtml(note.subject_code)}</span>
            <span class="category-tag">${escapeHtml(prettyType)}</span>
          </div>
          <div class="note-actions" style="margin-top:6px;">
            <a href="${note.file_url}" target="_blank" rel="noopener noreferrer">View / Download</a>
          </div>
        `;
        notesContainer.appendChild(card);
      }
    }

    function applyFilters(){
      const filtered = allNotesData.filter(n=>{
        const matchCat = currentCategory==='all' || n.subject_code===currentCategory;
        const hay = (n.title+' '+(n.description||'')+' '+n.subject_code).toLowerCase();
        const matchSearch = !searchTerm || hay.includes(searchTerm);
        return matchCat && matchSearch;
      });
      renderNotes(filtered);
    }

    categoryList.addEventListener('click', e=>{
      const a = e.target.closest('a[data-category]');
      if(!a) return;
      e.preventDefault();
      [...categoryList.querySelectorAll('a')].forEach(el=>el.classList.remove('active'));
      a.classList.add('active');
      currentCategory = a.dataset.category;
      applyFilters();
    });

    searchInput.addEventListener('input', e=>{
      searchTerm = e.target.value.trim().toLowerCase();
      applyFilters();
    });

    async function loadNotes(){
      notesContainer.innerHTML = `
        <div class="note-card">
          <h3>Loading...</h3>
          <p>Fetching your notes...</p>
        </div>`;
      try {
        allNotesData = await fetchMyNotes();
        applyFilters();
      } catch(err){
        notesContainer.innerHTML = `
          <div class="note-card">
            <h3>Error</h3>
            <p>${escapeHtml(err.message || 'Failed to load notes')}</p>
            <div class="note-actions"><a href="#" id="reloadLink">Reload</a></div>
          </div>`;
        const reload = document.getElementById('reloadLink');
        if(reload) reload.addEventListener('click', re=>{
          re.preventDefault(); loadNotes();
        });
      }
    }

    onAuth(user=>{
      if(!user){
        location.replace('auth.html?mode=login');
        return;
      }
      loadNotes();
    });
  </script>
</body>
</html>
