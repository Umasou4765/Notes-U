<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Notes-U</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="home">
  <header>
    <a href="index.html" class="logo" aria-label="Notes-U Home"><span>U</span></a>
    <div class="header-actions">
      <a href="upload.html" class="button" id="upload-note-btn">Upload Note</a>
      <button class="logout-button" id="logout-btn" aria-label="Log out">Log Out</button>
    </div>
  </header>
  <main>
    <aside class="sidebar">
      <h2>Academic Categories</h2>
      <ul class="category-list" id="categoryList">
        <li><a href="#" class="active" data-category="all">All Notes</a></li>
        <li class="category-semester-separator">Year 1 Semester 1</li>
        <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
        <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
        <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
        <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
        <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
        <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
        <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
        <li class="category-semester-separator">Year 1 Semester 2</li>
        <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
        <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
        <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
        <li class="category-semester-separator">Year 1 Semester 3</li>
        <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
        <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
        <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
        <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
        <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
        <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
        <li class="category-semester-separator">Year 2 Semester 1</li>
        <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
        <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
        <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
        <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
        <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
        <li class="category-semester-separator">Year 2 Semester 2</li>
        <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
        <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
        <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
        <li class="category-semester-separator">Year 2 Semester 3</li>
        <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
      </ul>
    </aside>
    <section class="content-area">
      <h2>Your Notes & Resources</h2>
      <div class="search-bar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.8-4.8m0 0A7.2 7.2 0 105.4 5.4a7.2 7.2 0 0010.8 10.8z"/>
        </svg>
        <input id="searchInput" placeholder="Search notes by title, description, or subject...">
      </div>
      <div id="notes-container" class="note-grid">
        <div class="note-card" data-category="placeholder-note">
          <h3>No Notes Found</h3>
          <p>It looks like there are no notes yet. Upload something to get started.</p>
          <div class="tags">
            <span class="category-tag">Info</span>
            <span class="category-tag">Empty</span>
          </div>
          <div class="note-actions">
            <a href="upload.html">Upload Now</a>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer>&copy; 2025 Notes-U. All rights reserved.</footer>
  <script type="module">
    import { onAuth, logout, fetchMyNotes } from './firebase-init.js';
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      function apply(t){
        document.body.classList.remove('light','dark');
        document.body.classList.add(t);
        localStorage.setItem('theme', t);
      }
      if(stored) apply(stored);
      else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
      });
      window.addEventListener('storage', e=>{
        if(e.key==='theme' && e.newValue) apply(e.newValue);
      });
    })();
    const logoutButton = document.getElementById('logout-btn');
    const notesContainer = document.getElementById('notes-container');
    const searchInput = document.getElementById('searchInput');
    const categoryList = document.getElementById('categoryList');
    let allNotesData = [];
    let currentCategory = 'all';
    let searchTerm = '';
    logoutButton.addEventListener('click', async ()=>{
      try { await logout(); } finally { location.href='auth.html?mode=login'; }
    });
    function escapeHtml(str=''){ return str.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function renderNotes(list){
      notesContainer.innerHTML = '';
      if(!list.length){
        notesContainer.innerHTML = `<div class="note-card" data-category="placeholder-note">
            <h3>No Notes Found</h3>
            <p>No notes match your filters. Try another category or clear your search.</p>
            <div class="note-actions"><a href="upload.html">Upload Now</a></div>
          </div>`;
        return;
      }
      for(const note of list){
        const prettyType = (note.notes_type||'').replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
        const card = document.createElement('div');
        card.className='note-card';
        card.dataset.category = note.subject_code;
        card.innerHTML = `
          <h3>${escapeHtml(note.title)}</h3>
          <p>${escapeHtml(note.description || 'No description provided.')}</p>
          <div>
            <span class="category-tag">${escapeHtml(note.academic_year.replace('year','Year '))}</span>
            <span class="category-tag">${escapeHtml(note.semester.replace('semester','Semester '))}</span>
            <span class="category-tag">${escapeHtml(note.subject_code)}</span>
            <span class="category-tag">${escapeHtml(prettyType)}</span>
          </div>
          <div class="note-actions" style="margin-top:6px;">
            <a href="${note.file_url}" target="_blank" rel="noopener noreferrer">View / Download</a>
          </div>`;
        notesContainer.appendChild(card);
      }
    }
    function applyFilters(){
      const filtered = allNotesData.filter(n=>{
        const matchCat = currentCategory==='all' || n.subject_code===currentCategory;
        const hay = (n.title+' '+(n.description||'')+' '+n.subject_code).toLowerCase();
        const matchSearch = !searchTerm || hay.includes(searchTerm);
        return matchCat && matchSearch;
      });
      renderNotes(filtered);
    }
    categoryList.addEventListener('click', e=>{
      const a = e.target.closest('a[data-category]'); if(!a) return;
      e.preventDefault();
      [...categoryList.querySelectorAll('a')].forEach(el=>el.classList.remove('active'));
      a.classList.add('active');
      currentCategory = a.dataset.category;
      applyFilters();
    });
    searchInput.addEventListener('input', e=>{
      searchTerm = e.target.value.trim().toLowerCase();
      applyFilters();
    });
    async function loadNotes(){
      notesContainer.innerHTML = `<div class="note-card"><h3>Loading...</h3><p>Fetching your notes...</p></div>`;
      try { allNotesData = await fetchMyNotes(); applyFilters(); }
      catch(err){
        notesContainer.innerHTML = `<div class="note-card"><h3>Error</h3><p>${escapeHtml(err.message || 'Failed to load notes')}</p>
          <div class="note-actions"><a href="#" id="reloadLink">Reload</a></div></div>`;
        document.getElementById('reloadLink')?.addEventListener('click', re=>{
          re.preventDefault(); loadNotes();
        });
      }
    }
    onAuth(user=>{
      if(!user) location.href='auth.html?mode=login';
      else loadNotes();
    });
  </script>
</body>
</html>