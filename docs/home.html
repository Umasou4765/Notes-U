<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Notes-U</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f8f8f8; --text:#333; --label:#666;
      --container:#fff; --border:rgba(0,0,0,0.14);
      --accent:#0d6efd; --accent-hover:#0b5ed7;
      --shadow:0 2px 4px rgba(0,0,0,0.08);
      --shadow-strong:0 4px 14px rgba(0,0,0,0.12);
      --focus-ring:0 0 0 3px rgba(13,110,253,.35);
      --danger:#d23d3d;
    }
    body.dark {
      --bg:#1a1a1a; --text:#f2f2f2; --label:#b0b0b0;
      --container:#222; --border:rgba(255,255,255,0.12);
      --shadow:0 2px 4px rgba(0,0,0,0.6);
      --shadow-strong:0 4px 14px rgba(0,0,0,0.7);
    }
    * { box-sizing:border-box; }
    body {
      font-family:'Inter',system-ui,Arial,sans-serif;
      margin:0; background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; min-height:100vh;
      transition:background .3s,color .3s;
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 28px; background:var(--container);
      box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
      border-bottom:1px solid var(--border);
    }
    .brand { display:flex; align-items:center; gap:12px; user-select:none; }
    .logo {
      font-size:1.7rem; font-weight:700; color:inherit;
      display:flex; align-items:center; justify-content:center;
      width:46px; height:46px; border:2px solid currentColor; border-radius:12px;
    }
    .site-title { font-size:1.25rem; font-weight:700; letter-spacing:-.5px; }
    .header-actions { display:flex; gap:12px; }

    .icon-btn, .icon-btn:visited {
      --btn-bg:var(--accent);
      --btn-bg-hover:var(--accent-hover);
      background:var(--btn-bg);
      color:#fff; border:none; cursor:pointer;
      padding:10px 16px; font-size:.8rem; font-weight:600;
      border-radius:10px; display:inline-flex; gap:8px; align-items:center;
      text-decoration:none; letter-spacing:.4px;
      box-shadow:0 4px 14px -6px rgba(0,90,200,0.45), 0 2px 7px -4px rgba(0,70,160,0.4);
      transition:background .25s, transform .4s, box-shadow .4s;
    }
    .icon-btn svg { width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; }
    .icon-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px -10px rgba(0,70,170,0.55), 0 4px 14px -6px rgba(0,70,160,0.4); }
    .icon-btn:active { transform:translateY(0) scale(.95); }
    .icon-btn:focus-visible { outline:none; box-shadow:var(--focus-ring); }

    .icon-btn.logout {
      --btn-bg:transparent;
      --btn-bg-hover:rgba(0,0,0,0.07);
      color:var(--text);
      background:var(--btn-bg);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .icon-btn.logout:hover { background:var(--btn-bg-hover); box-shadow:none; }
    body.dark .icon-btn.logout:hover { --btn-bg-hover:rgba(255,255,255,0.12); }

    main {
      flex-grow:1; display:grid; grid-template-columns:290px 1fr; gap:26px;
      padding:28px; max-width:1400px; width:100%; margin:0 auto; box-sizing:border-box;
    }
    aside.sidebar, .content-area {
      background:var(--container); border-radius:14px; padding:22px;
      box-shadow:var(--shadow); border:1px solid var(--border); min-height:0;
      display:flex; flex-direction:column;
    }
    nav.sidebar-nav { flex:1 1 auto; overflow-y:auto; }
    h2 { margin:0 0 18px; font-size:1.1rem; text-transform:uppercase; letter-spacing:.7px; font-weight:600; opacity:.85;}
    ul.category-list { list-style:none; margin:0; padding:0; }
    ul.category-list li { margin-bottom:2px; }
    ul.category-list a {
      display:block; padding:7px 10px; text-decoration:none;
      color:var(--label); border-radius:8px; font-size:.78rem;
      transition:background .18s,color .18s;
    }
    ul.category-list a[aria-current="true"],
    ul.category-list a:hover {
      background:rgba(0,0,0,0.07); color:var(--text);
    }
    body.dark ul.category-list a:hover,
    body.dark ul.category-list a[aria-current="true"] {
      background:rgba(255,255,255,0.12);
    }
    .category-semester-separator {
      font-size:.58rem; font-weight:700; letter-spacing:.9px;
      text-transform:uppercase; margin:10px 0 4px; opacity:.55; padding-left:4px;
    }

    .filters-bar {
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:18px;
    }
    .filters-bar .search-wrap { position:relative; flex:1 1 260px; }
    .filters-bar input[type="search"] {
      width:100%; padding:10px 14px 10px 40px; font-size:.85rem;
      border:1px solid var(--border); border-radius:8px; background:transparent; color:inherit;
    }
    .filters-bar input[type="search"]:focus { outline:2px solid var(--accent); outline-offset:2px; }
    .filters-bar svg.search-icon {
      position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.55;
    }
    select.sort-select {
      padding:9px 12px; font:inherit; font-size:.8rem;
      border:1px solid var(--border); background:transparent; color:inherit;
      border-radius:8px;
    }
    select.sort-select:focus { outline:2px solid var(--accent); outline-offset:2px; }
    button.clear-filters {
      padding:9px 14px; font-size:.7rem; font-weight:600;
      background:transparent; border:1px solid var(--border); border-radius:8px;
      cursor:pointer; letter-spacing:.5px;
    }
    button.clear-filters:hover { background:rgba(0,0,0,0.06); }
    body.dark button.clear-filters:hover { background:rgba(255,255,255,0.12); }

    .results-summary {
      font-size:.7rem; letter-spacing:.5px; margin-bottom:16px;
      color:var(--label);
    }

    .note-grid {
      --col-min:260px;
      display:grid; gap:18px;
      grid-template-columns:repeat(auto-fill,minmax(var(--col-min),1fr));
    }
    .note-card {
      background:transparent; border:1px solid var(--border); border-radius:12px;
      padding:16px 16px 14px; display:flex; flex-direction:column;
      box-shadow:0 2px 6px rgba(0,0,0,0.04); transition:transform .18s, box-shadow .18s, background .3s;
      position:relative;
    }
    .note-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-strong); }
    .note-card h3 { margin:0 0 6px; font-size:1.02rem; line-height:1.25; }
    .note-card p { margin:0 0 10px; font-size:.75rem; line-height:1.35; color:var(--label); }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
    .tag, .category-tag {
      display:inline-flex; align-items:center; justify-content:center;
      font-size:.58rem; padding:5px 8px 4px; background:rgba(0,0,0,0.07);
      border-radius:20px; letter-spacing:.4px; font-weight:600; color:var(--text);
    }
    body.dark .tag, body.dark .category-tag { background:rgba(255,255,255,0.14); }
    .meta-line {
      font-size:.55rem; letter-spacing:.5px; opacity:.65; margin-top:auto;
      display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;
    }
    .note-actions a {
      font-size:.65rem; color:var(--accent); text-decoration:none; font-weight:600;
    }
    .note-actions a:hover { text-decoration:underline; }
    mark {
      background: #ffeb88;
      color: inherit;
      padding:0 2px;
      border-radius:3px;
    }
    body.dark mark { background:#665500; }

    footer {
      text-align:center; font-size:.7rem; padding:18px; opacity:.7;
      border-top:1px solid var(--border); margin-top:auto;
    }
    @media (max-width:960px){
      main { grid-template-columns:1fr; }
      aside.sidebar { order:2; }
      .content-area { order:1; }
    }
    @media (max-width:660px){
      .filters-bar { flex-direction:column; align-items:stretch; }
      .filters-bar .search-wrap, select.sort-select, button.clear-filters { width:100%; }
    }
  </style>
</head>
<body>
  <header role="banner">
    <div class="brand" aria-label="Notes-U">
      <div class="logo" aria-hidden="true">U</div>
      <span class="site-title">Notes-U</span>
    </div>
    <div class="header-actions">
      <a href="upload.html" class="icon-btn" id="upload-note-btn" aria-label="Upload Note">
        <svg viewBox="0 0 24 24"><path d="M12 16V4m0 0l-5 5m5-5l5 5"/><path d="M4 20h16"/></svg>
        <span>Upload</span>
      </a>
      <button class="icon-btn logout" id="logout-btn" aria-label="Log out">
        <svg viewBox="0 0 24 24">
          <path d="M15 3h-6a2 2 0 00-2 2v3"/>
          <path d="M9 21h6a2 2 0 002-2v-3"/>
          <path d="M16 12H8"/>
          <path d="M11 9l-3 3 3 3"/>
        </svg>
        <span>Log Out</span>
      </button>
    </div>
  </header>

  <main role="main">
    <aside class="sidebar" aria-label="Filters">
      <h2>Subjects</h2>
      <nav class="sidebar-nav" aria-label="Subject categories">
        <ul class="category-list" id="categoryList">
          <li><a href="#" data-category="all" aria-current="true">All Notes</a></li>
          <li class="category-semester-separator">Year 1 Semester 1</li>
          <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
          <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
          <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
          <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
          <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
          <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
          <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
          <li class="category-semester-separator">Year 1 Semester 2</li>
          <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
          <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
          <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
          <li class="category-semester-separator">Year 1 Semester 3</li>
          <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
          <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
          <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
          <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
          <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
          <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
          <li class="category-semester-separator">Year 2 Semester 1</li>
          <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
          <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
          <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
          <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
          <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
          <li class="category-semester-separator">Year 2 Semester 2</li>
          <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
          <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
          <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
          <li class="category-semester-separator">Year 2 Semester 3</li>
          <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
        </ul>
      </nav>
    </aside>

    <section class="content-area" aria-labelledby="notesHeading">
      <h1 id="notesHeading" style="margin:0 0 10px;font-size:1.55rem;letter-spacing:-.5px;">Your Notes & Resources</h1>

      <div class="filters-bar">
        <div class="search-wrap">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.8-4.8m0 0A7.2 7.2 0 105.4 5.4a7.2 7.2 0 0010.8 10.8z"/>
          </svg>
          <input id="searchInput" type="search" placeholder="Search title, description, or subject..." autocomplete="off" aria-label="Search notes">
        </div>
        <select id="sortSelect" class="sort-select" aria-label="Sort notes">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="title">Title A–Z</option>
          <option value="subject">Subject Code</option>
          <option value="type">Type</option>
        </select>
        <button id="clearFiltersBtn" class="clear-filters" type="button" aria-label="Clear filters">Clear Filters</button>
      </div>

      <div id="resultsSummary" class="results-summary" aria-live="polite"></div>

      <div id="notes-container" class="note-grid" aria-live="polite">
        <!-- Notes will render here -->
      </div>
    </section>
  </main>

  <footer>&copy; 2025 Notes-U. All rights reserved.</footer>

  <script type="module">
    import { onAuth, logout, fetchMyNotes } from './firebase-init.js';

    /* ========== THEME (unchanged core) ========== */
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      function apply(t){
        document.body.classList.remove('light','dark');
        document.body.classList.add(t);
        localStorage.setItem('theme', t);
      }
      if(stored) apply(stored);
      else apply(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) apply(e.matches?'dark':'light');
      });
      window.addEventListener('storage', e=>{
        if(e.key==='theme' && e.newValue) apply(e.newValue);
      });
    })();

    /* ========== ELEMENTS ========== */
    const logoutButton   = document.getElementById('logout-btn');
    const notesContainer = document.getElementById('notes-container');
    const searchInput    = document.getElementById('searchInput');
    const sortSelect     = document.getElementById('sortSelect');
    const categoryList   = document.getElementById('categoryList');
    const clearFiltersBtn= document.getElementById('clearFiltersBtn');
    const resultsSummary = document.getElementById('resultsSummary');

    /* ========== STATE ========== */
    const state = {
      rawNotes: [],
      filtered: [],
      category: localStorage.getItem('notes.category') || 'all',
      search: localStorage.getItem('notes.search') || '',
      sort: localStorage.getItem('notes.sort') || 'newest'
    };

    /* ========== UTILITIES ========== */
    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function formatDate(ts){
      if(!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    }
    function formatSize(bytes){
      if(!bytes && bytes !== 0) return '';
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB';
      return (bytes/1024/1024).toFixed(2)+' MB';
    }
    function highlight(text, term){
      if(!term) return escapeHtml(text);
      const esc = escapeHtml(text);
      try {
        const re = new RegExp('('+term.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+')','ig');
        return esc.replace(re,'<mark>$1</mark>');
      } catch {
        return esc;
      }
    }

    function persist(){
      localStorage.setItem('notes.category', state.category);
      localStorage.setItem('notes.search', state.search);
      localStorage.setItem('notes.sort', state.sort);
    }

    /* ========== RENDERING ========== */
    function renderNotes(list){
      notesContainer.innerHTML = '';
      if(!list.length){
        notesContainer.innerHTML = `
          <div class="note-card" data-category="placeholder-note">
            <h3>No Notes Found</h3>
            <p>No notes match your current filters. Try clearing filters or uploading a new note.</p>
            <div class="tags">
              <span class="tag">Empty</span>
              <span class="tag">Info</span>
            </div>
            <div class="note-actions">
              <a href="upload.html">Upload Now</a>
            </div>
            <div class="meta-line">
              <span>—</span><span>—</span>
            </div>
          </div>`;
        updateSummary();
        return;
      }
      for(const n of list){
        const prettyType = (n.notes_type||'')
          .replace(/_/g,' ')
          .replace(/\b\w/g,m=>m.toUpperCase()) || 'Note';
        const extTag = n.file_ext ? `<span class="tag">${escapeHtml(n.file_ext.toUpperCase())}</span>` : '';
        const dateStr = formatDate(n.createdAt);
        const sizeStr = formatSize(n.file_size);
        const card = document.createElement('div');
        card.className='note-card';
        card.dataset.category = n.subject_code;
        const titleHTML = highlight(n.title, state.search);
        const descHTML  = highlight(n.description || 'No description provided.', state.search);
        card.innerHTML = `
          <h3>${titleHTML}</h3>
          <p>${descHTML}</p>
          <div class="tags">
            <span class="tag">${escapeHtml(n.academic_year.replace('year','Year '))}</span>
            <span class="tag">${escapeHtml(n.semester.replace('semester','Semester '))}</span>
            <span class="tag">${escapeHtml(n.subject_code)}</span>
            <span class="tag">${escapeHtml(prettyType)}</span>
            ${extTag}
          </div>
          <div class="note-actions" style="margin-top:4px;">
            <a href="${n.file_url}" target="_blank" rel="noopener noreferrer">View / Download</a>
          </div>
          <div class="meta-line">
            <span>${dateStr}</span>
            <span>${sizeStr}</span>
          </div>
        `;
        notesContainer.appendChild(card);
      }
      updateSummary();
    }

    function updateSummary(){
      const total = state.rawNotes.length;
      const shown = state.filtered.length;
      const catLabel = state.category === 'all' ? 'All' : state.category;
      resultsSummary.textContent =
        `${shown} of ${total} notes · Category: ${catLabel} · Sort: ${state.sort} ${state.search ? '· Search: '+state.search : ''}`;
    }

    /* ========== FILTER / SORT PIPELINE ========== */
    function applyFilters(){
      let list = [...state.rawNotes];

      // Category
      if(state.category !== 'all'){
        list = list.filter(n => n.subject_code === state.category);
      }
      // Search
      const term = state.search.toLowerCase();
      if(term){
        list = list.filter(n => {
          const hay = (n.title+' '+(n.description||'')+' '+n.subject_code).toLowerCase();
          return hay.includes(term);
        });
      }
      // Sort
      switch(state.sort){
        case 'oldest':
          list.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
          break;
        case 'title':
          list.sort((a,b)=> a.title.localeCompare(b.title));
          break;
        case 'subject':
          list.sort((a,b)=> a.subject_code.localeCompare(b.subject_code));
          break;
        case 'type':
          list.sort((a,b)=> (a.notes_type||'').localeCompare(b.notes_type||''));
          break;
        case 'newest':
        default:
          list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      }
      state.filtered = list;
      renderNotes(list);
    }

    /* ========== EVENT HANDLERS ========== */
    // Category clicks
    categoryList.addEventListener('click', e=>{
      const a = e.target.closest('a[data-category]');
      if(!a) return;
      e.preventDefault();
      [...categoryList.querySelectorAll('a[data-category]')].forEach(el=>{
        el.removeAttribute('aria-current');
      });
      a.setAttribute('aria-current','true');
      state.category = a.dataset.category;
      persist();
      applyFilters();
    });

    // Initialize category selection style if persisted
    if(state.category !== 'all'){
      const el = categoryList.querySelector(`a[data-category="${state.category}"]`);
      if(el){
        categoryList.querySelectorAll('a[data-category]').forEach(a=>a.removeAttribute('aria-current'));
        el.setAttribute('aria-current','true');
      }
    }

    // Debounced search
    let searchTimer = null;
    searchInput.value = state.search;
    searchInput.addEventListener('input', e=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{
        state.search = e.target.value.trim();
        persist();
        applyFilters();
      }, 220);
    });

    // Sort
    sortSelect.value = state.sort;
    sortSelect.addEventListener('change', e=>{
      state.sort = e.target.value;
      persist();
      applyFilters();
    });

    // Clear filters
    clearFiltersBtn.addEventListener('click', ()=>{
      state.category = 'all';
      state.search = '';
      state.sort = 'newest';
      searchInput.value = '';
      sortSelect.value = 'newest';
      categoryList.querySelectorAll('a[data-category]').forEach(a=>a.removeAttribute('aria-current'));
      const allLink = categoryList.querySelector('a[data-category="all"]');
      if(allLink) allLink.setAttribute('aria-current','true');
      persist();
      applyFilters();
    });

    // Logout
    logoutButton.addEventListener('click', async ()=>{
      try {
        await logout();
        localStorage.setItem('recentLogout','1');
      } finally {
        location.replace('auth.html?mode=login');
      }
    });

    // BFCache guard
    window.addEventListener('pageshow', (e)=>{
      if(e.persisted && localStorage.getItem('recentLogout')==='1'){
        location.replace('auth.html?mode=login');
      }
    });

    /* ========== LOAD DATA ========== */
    async function loadNotes(){
      notesContainer.innerHTML = `
        <div class="note-card">
          <h3>Loading...</h3>
          <p>Fetching your notes...</p>
          <div class="tags">
            <span class="tag">Loading</span>
          </div>
          <div class="meta-line"><span>—</span><span>—</span></div>
        </div>`;
      try {
        state.rawNotes = await fetchMyNotes();
        applyFilters();
      } catch(err){
        notesContainer.innerHTML = `
          <div class="note-card">
            <h3>Error</h3>
            <p>${escapeHtml(err.message || 'Failed to load notes')}</p>
            <div class="note-actions"><a href="#" id="reloadLink">Reload</a></div>
            <div class="meta-line"><span>—</span><span>—</span></div>
          </div>`;
        const reload = document.getElementById('reloadLink');
        if(reload) reload.addEventListener('click', re=>{
          re.preventDefault(); loadNotes();
        });
        resultsSummary.textContent = 'Could not load notes.';
      }
    }

    onAuth(user=>{
      if(!user){
        if(location.pathname.endsWith('home.html')){
          location.replace('auth.html?mode=login');
        }
        return;
      }
      if(localStorage.getItem('recentLogout')==='1'){
        localStorage.removeItem('recentLogout');
      }
      loadNotes();
    });
  </script>
</body>
</html>
