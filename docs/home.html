<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home - Notes-U</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/variables.css">
<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/app.css">
<style>
header.app-header {
  position:sticky; top:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: var(--space-4);
  padding: 10px 20px;
  background: linear-gradient(145deg,var(--color-surface),var(--color-surface-alt) 130%);
  border-bottom:1px solid var(--color-border);
  box-shadow: var(--shadow-sm);
  z-index: 200;
}
.branding {
  display:flex;
  align-items:center;
  gap:12px;
}
.brand-logo {
  width:50px; height:50px;
  border:2px solid currentColor;
  border-radius:16px;
  font-weight:700;
  font-size:1.3rem;
  display:flex;
  align-items:center;
  justify-content:center;
  background: linear-gradient(140deg, rgba(255,255,255,0.55), rgba(255,255,255,0.1));
  transition: transform var(--transition-fast);
}
.brand-logo:hover { transform: rotate(-4deg) scale(1.04); }
nav.sidebar {
  background: linear-gradient(145deg,var(--color-surface),var(--color-surface-alt) 140%);
  border:1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-5) var(--space-4) var(--space-5);
  box-shadow: var(--shadow);
  position:sticky;
  top:76px;
  height: fit-content;
  max-height: calc(100vh - 110px);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.sidebar-inner {
  overflow-y:auto;
  padding-right:4px;
  margin-top:4px;
  scrollbar-width: thin;
}

.sidebar-inner::-webkit-scrollbar { width:8px; }
.sidebar-inner::-webkit-scrollbar-thumb {
  background: var(--tag-bg);
  border-radius: 20px;
}
.category-list {
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.category-list a {
  display:block;
  padding:8px 10px 7px;
  border-radius: var(--radius-sm);
  font-size:.7rem;
  letter-spacing:.45px;
  font-weight:500;
  text-decoration:none;
  color: var(--color-text-soft);
  transition: background var(--transition-fast), color var(--transition-fast);
}
.category-list a:hover,
.category-list a[aria-current="true"] {
  background: var(--tag-bg);
  color: var(--color-text);
}
.category-semester-separator {
  font-size:.55rem;
  letter-spacing:.85px;
  font-weight:700;
  text-transform:uppercase;
  margin:10px 0 2px;
  opacity:.55;
  padding-left:4px;
}

.main-layout {
  display:grid;
  grid-template-columns: 280px 1fr;
  gap: 30px;
  width:100%;
  max-width: 1400px;
  margin: 40px auto 80px;
  padding: 0 28px;
}

@media (max-width: 980px) {
  .main-layout { grid-template-columns:1fr; }
  nav.sidebar {
    position:relative;
    top:0;
    order:2;
  }
}

.page-header {
  display:flex;
  flex-direction:column;
  gap: 10px;
  margin-bottom: 10px;
}
.page-header h2 {
  margin: 0;
  font-size: 1.95rem;
  letter-spacing:-.8px;
  background: linear-gradient(90deg,var(--color-text),var(--color-text-soft));
  -webkit-background-clip:text;
  color: transparent;
}

.toolbar {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  margin: 0 0 16px;
}
.view-toggle {
  display:flex;
  gap:6px;
  border:1px solid var(--color-border);
  border-radius: var(--radius-sm);
  padding:4px;
  background: var(--color-surface-alt);
}
.view-btn {
  border:0;
  background:transparent;
  cursor:pointer;
  font-size:.62rem;
  font-weight:600;
  letter-spacing:.5px;
  padding:7px 10px;
  border-radius: var(--radius-xs);
  color: var(--color-text-soft);
  display:inline-flex;
  gap:5px;
  align-items:center;
  transition: background var(--transition-fast), color var(--transition-fast);
}
.view-btn[aria-pressed="true"] {
  background: var(--color-accent);
  color:#fff;
}
.search-box {
  position:relative;
  flex:1 1 260px;
  min-width:240px;
}
.search-box input {
  width:100%;
  padding:11px 14px 11px 42px;
  border:1px solid var(--color-border);
  background: var(--color-surface);
  border-radius: var(--radius-sm);
  font-size:.8rem;
}
.search-box svg {
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  width:18px;
  height:18px;
  opacity:.6;
}
.sort-select {
  border:1px solid var(--color-border);
  border-radius: var(--radius-sm);
  background: var(--color-surface);
  padding:8px 12px;
  font-size:.7rem;
  font-weight:600;
  letter-spacing:.4px;
}
.results-summary {
  font-size: .62rem;
  letter-spacing:.5px;
  color: var(--color-text-soft);
  min-height: 1em;
  margin: 0 0 14px;
}

.logout-btn {
  width:44px;
  height:44px;
  border-radius:50%;
  border:1px solid var(--color-border);
  background: var(--color-surface-alt);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: background var(--transition-fast), transform var(--transition-fast);
}
.logout-btn:hover { background: var(--color-accent); color:#fff; }
.logout-btn:active { transform: scale(.92); }

.hidden { display:none !important; }
</style>
</head>
<body class="view-grid theming-prep">
<header class="app-header">
  <div class="branding">
    <div class="brand-logo">U</div>
    <strong>Notes-U</strong>
  </div>
  <button id="logout-btn" class="logout-btn" aria-label="Log out">
    <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="1.9" fill="none">
      <path d="M14 3H7a4 4 0 00-4 4v10a4 4 0 004 4h7"/>
      <path d="M9 12h11"/>
      <path d="M16 8l4 4-4 4"/>
    </svg>
  </button>
</header>

<div class="main-layout">
  <nav class="sidebar" aria-label="Subjects">
    <h3 style="margin:0;font-size:.8rem;letter-spacing:.7px;text-transform:uppercase;opacity:.65;">Subjects</h3>
    <div class="sidebar-inner">
      <ul class="category-list" id="categoryList">
        <li><a href="#" data-category="all" aria-current="true">All Notes</a></li>
        <li class="category-semester-separator">Year 1 Semester 1</li>
        <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
        <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
        <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
        <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
        <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
        <li><a href="#" data-category="MPU2302">MPU2302 - Integrity and Anti-Corruption</a></li>
        <li><a href="#" data-category="MPU2123">MPU2123 - Penghayatan Etika dan Peradaban</a></li>
        <li class="category-semester-separator">Year 1 Semester 2</li>
        <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
        <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
        <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
        <li class="category-semester-separator">Year 1 Semester 3</li>
        <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
        <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
        <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
        <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
        <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
        <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
        <li class="category-semester-separator">Year 2 Semester 1</li>
        <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
        <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
        <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
        <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
        <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
        <li class="category-semester-separator">Year 2 Semester 2</li>
        <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
        <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
        <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
        <li class="category-semester-separator">Year 2 Semester 3</li>
        <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
      </ul>
    </div>
  </nav>

  <section>
    <div class="page-header">
      <h2>Your Notes</h2>
      <div class="toolbar">
        <div class="view-toggle" role="group">
          <button id="gridViewBtn" class="view-btn" aria-pressed="true">Grid</button>
          <button id="listViewBtn" class="view-btn" aria-pressed="false">List</button>
        </div>
        <div>
          <select id="sortSelect" class="sort-select" aria-label="Sort notes">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="title">Aâ€“Z Title</option>
          </select>
        </div>
        <div class="search-box">
          <svg viewBox="0 0 24 24"><path d="M11 4a7 7 0 015.56 11.37l4.04 4.04-1.42 1.42-4.04-4.04A7 7 0 1111 4z" stroke="currentColor" stroke-width="2" fill="none"/></svg>
          <input id="searchInput" type="search" placeholder="Search title or description..." autocomplete="off">
        </div>
      </div>
      <div class="results-summary" id="resultsSummary" aria-live="polite"></div>
    </div>
    <div id="notesHost"></div>
  </section>
</div>

<a href="upload.html" class="fab" aria-label="Upload a new note">
  <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="1.9" fill="none">
    <path d="M12 19V5m0 0l-5 5m5-5 5 5"/>
    <path d="M4 19h16"/>
  </svg>
  Upload
</a>

<script type="module">
import { onAuth, logout, fetchMyNotes, invalidateNotesCache } from './firebase-init.js';

/* Theme */
function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme);
  localStorage.setItem('theme', theme);
}
function initTheme(){
  const stored = localStorage.getItem('theme');
  applyTheme(stored || (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  document.body.classList.remove('theming-prep');
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
    if(!localStorage.getItem('theme')) applyTheme(e.matches?'dark':'light');
  });
}
initTheme();

/* Back / BFCache guards */
function installBackGuards(){
  window.addEventListener('pageshow', e=>{
    if ((e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward') && !window.__currentUser) {
      location.replace('auth.html?login');
    }
  });
  history.replaceState({ protected:true }, '', location.href);
  window.addEventListener('popstate', ()=>{
    if(!window.__currentUser) location.replace('auth.html?login');
  });
}
installBackGuards();

/* Elements */
const logoutBtn = document.getElementById('logout-btn');
const categoryList = document.getElementById('categoryList');
const searchInput = document.getElementById('searchInput');
const resultsSummary = document.getElementById('resultsSummary');
const notesHost = document.getElementById('notesHost');
const gridViewBtn = document.getElementById('gridViewBtn');
const listViewBtn = document.getElementById('listViewBtn');
const sortSelect = document.getElementById('sortSelect');

let allNotesData = [];
let activeCategory = 'all';
let activeSort = 'newest';

function skeletons(n=6){
  return `<div class="note-grid">${Array.from({length:n}).map(()=>'<div class="skeleton"></div>').join('')}</div>`;
}

function escapeHtml(str=''){
  return str.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function sortNotes(list){
  switch(activeSort){
    case 'oldest': return list.slice().sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    case 'title': return list.slice().sort((a,b)=> (a.title||'').localeCompare(b.title||'',undefined,{sensitivity:'base'}));
    case 'newest':
    default: return list.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  }
}

function renderNotes(list){
  const isList = document.body.classList.contains('view-list');
  const wrapClass = isList ? 'note-list' : 'note-grid';
  const html = list.map(note=>{
    const typeDisplay = (note.notes_type||'note').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    return `<div class="note-card" data-category="${escapeHtml(note.subject_code)}">
      <h3>${escapeHtml(note.title || 'Untitled')}</h3>
      <p>${escapeHtml(note.description || 'No description provided.')}</p>
      <div class="tags">
        <span class="tag">${escapeHtml(note.academic_year.replace('year','Year '))}</span>
        <span class="tag">${escapeHtml(note.semester.replace('semester','Semester '))}</span>
        <span class="tag">${escapeHtml(note.subject_code)}</span>
        <span class="tag accent">${escapeHtml(typeDisplay)}</span>
      </div>
      <div class="note-actions">
        <a href="${note.file_url}" target="_blank" rel="noopener">View / Download</a>
      </div>
    </div>`;
  }).join('');
  notesHost.innerHTML = `<div class="${wrapClass}">${html}</div>`;
}

function updateSummary(count){
  resultsSummary.textContent = `${count} note${count!==1?'s':''} shown`;
}

function renderFiltered(){
  const term = (searchInput.value||'').toLowerCase();
  const filtered = allNotesData.filter(n=>{
    const matchCategory = activeCategory==='all' || n.subject_code===activeCategory;
    const hay = `${n.title||''} ${n.description||''} ${n.subject_code||''}`.toLowerCase();
    const matchSearch = !term || hay.includes(term);
    return matchCategory && matchSearch;
  });
  const sorted = sortNotes(filtered);
  renderNotes(sorted);
  updateSummary(sorted.length);
}

/* Category events */
categoryList.querySelectorAll('a[data-category]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    categoryList.querySelectorAll('a[aria-current="true"]').forEach(x=>x.removeAttribute('aria-current'));
    a.setAttribute('aria-current','true');
    activeCategory = a.dataset.category || 'all';
    renderFiltered();
  });
});

/* View mode */
gridViewBtn.addEventListener('click', ()=>{
  document.body.classList.add('view-grid');
  document.body.classList.remove('view-list');
  gridViewBtn.setAttribute('aria-pressed','true');
  listViewBtn.setAttribute('aria-pressed','false');
  renderFiltered();
});
listViewBtn.addEventListener('click', ()=>{
  document.body.classList.add('view-list');
  document.body.classList.remove('view-grid');
  listViewBtn.setAttribute('aria-pressed','true');
  gridViewBtn.setAttribute('aria-pressed','false');
  renderFiltered();
});

/* Sort */
sortSelect.addEventListener('change', ()=>{
  activeSort = sortSelect.value;
  renderFiltered();
});
/* Search */
searchInput.addEventListener('input', renderFiltered);

/* Logout */
logoutBtn.addEventListener('click', async ()=>{
  try {
    await logout();
    invalidateNotesCache();
    location.replace('auth.html?login');
  } catch {
    alert('Logout failed');
  }
});

/* Auth & load */
onAuth(user=>{
  window.__currentUser = user || null;
  if(!user){
    location.replace('auth.html?login');
    return;
  }
  notesHost.innerHTML = skeletons(8);
  (async ()=>{
    try {
      allNotesData = await fetchMyNotes();
      renderFiltered();
    } catch(e){
      notesHost.innerHTML = `<div class="note-card"><h3>Error Loading Notes</h3><p>${escapeHtml(e.message||'Unknown error')}</p><div class="note-actions"><a href="#" onclick="location.reload();return false;">Reload</a></div></div>`;
    }
  })();
});

notesHost.innerHTML = skeletons(6);
</script>
</body>
</html>