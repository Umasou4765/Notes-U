<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="css/app.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="light">
  <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme">
    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>

  <header class="site-header">
    <a href="index.html" class="header-logo" aria-label="Notes-U Home">U</a>
    <div class="header-actions">
      <a href="upload.html" class="btn" id="upload-note-btn" style="min-width:120px;">Upload</a>
      <button class="btn secondary" id="logout-btn" style="min-width:120px;">Log Out</button>
    </div>
  </header>

  <main class="main-layout">
    <aside class="sidebar">
      <h2>Categories</h2>
      <div class="sidebar-inner">
        <ul class="category-list" id="categoryList">
          <li><a href="#" class="active" data-category="all">All Notes</a></li>
          <li class="category-semester-separator">Year 1 Sem 1</li>
          <li><a href="#" data-category="AMCS1013">AMCS1013 - Problem Solving and Programming</a></li>
          <li><a href="#" data-category="AMCS1113">AMCS1113 - Computer Architecture</a></li>
          <li><a href="#" data-category="AMIT1303">AMIT1303 - Introduction to Interface Design</a></li>
          <li><a href="#" data-category="AMMS1623">AMMS1623 - Calculus and Algebra</a></li>
          <li><a href="#" data-category="AJEL1713">AJEL1713 - English for Tertiary Studies</a></li>
          <li><a href="#" data-category="MPU2302">MPU-2302 - Integrity and Anti-Corruption</a></li>
          <li><a href="#" data-category="MPU2123">MPU-2123 - Penghayatan Etika dan Peradaban</a></li>
          <li class="category-semester-separator">Year 1 Sem 2</li>
          <li><a href="#" data-category="AMCS1043">AMCS1043 - Database Development and Applications</a></li>
          <li><a href="#" data-category="AMCS1034">AMCS1034 - Software Development Fundamentals</a></li>
          <li><a href="#" data-category="AMMS2613">AMMS2613 - Probability and Statistics</a></li>
          <li class="category-semester-separator">Year 1 Sem 3</li>
          <li><a href="#" data-category="AMIT2034">AMIT2034 - Fundamentals of Computer Networks</a></li>
          <li><a href="#" data-category="AMCS2204">AMCS2204 - Object-Oriented Programming Techniques</a></li>
          <li><a href="#" data-category="AMCS2093">AMCS2093 - Operating Systems</a></li>
          <li><a href="#" data-category="AMIS1013">AMIS1013 - Systems Analysis and Design</a></li>
          <li><a href="#" data-category="AMMS2603">AMMS2603 - Discrete Mathematics</a></li>
          <li><a href="#" data-category="AJEL1723">AJEL1723 - Academic English</a></li>
          <li class="category-semester-separator">Year 2 Sem 1</li>
          <li><a href="#" data-category="AMCS2034">AMCS2034 - Introduction to Data Structures and Algorithms</a></li>
          <li><a href="#" data-category="AMCS2123">AMCS2123 - Systems and Programming Concepts</a></li>
          <li><a href="#" data-category="AMCS2104">AMCS2104 - Fundamentals of Artificial Intelligence</a></li>
          <li><a href="#" data-category="AMIT3353">AMIT3353 - Mobile Application Development</a></li>
          <li><a href="#" data-category="AMIS1012">AMIS1012 - Ethics in Computing</a></li>
          <li class="category-semester-separator">Year 2 Sem 2</li>
          <li><a href="#" data-category="AMCS2094">AMCS2094 - Mini Project</a></li>
          <li><a href="#" data-category="AMCS2103">AMCS2103 - Parallel and Distributed Computing</a></li>
          <li><a href="#" data-category="AMIS1003">AMIS1003 - Introduction to Cybersecurity</a></li>
          <li class="category-semester-separator">Year 2 Sem 3</li>
          <li><a href="#" data-category="AMIT320A">AMIT320A - Industrial Training</a></li>
        </ul>
      </div>
    </aside>

    <section class="content-area">
      <h2>Your Notes & Resources</h2>
      <div class="search-bar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.8-4.8m0 0A7.2 7.2 0 105.4 5.4a7.2 7.2 0 0010.8 10.8z"/>
        </svg>
        <input id="searchInput" placeholder="Search by title, description, or subject...">
      </div>
      <div id="notes-container" class="note-grid">
        <!-- Placeholder will be replaced dynamically -->
        <div class="note-card" data-category="placeholder-note">
          <h3>No Notes Yet</h3>
          <p>Upload your first resource to get started.</p>
          <div class="note-actions"><a href="upload.html">Upload Now</a></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">&copy; 2025 Notes-U. All rights reserved.</footer>

  <script type="module">
    import { onAuth, logout, fetchMyNotes } from './firebase-init.js';

    /* Theme */
    function applyTheme(dark){
      document.body.classList.toggle('dark',dark);
      document.body.classList.toggle('light',!dark);
      localStorage.setItem('theme',dark?'dark':'light');
    }
    (function initTheme(){
      const stored=localStorage.getItem('theme');
      if(stored==='dark') applyTheme(true);
      else if(stored==='light') applyTheme(false);
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
      window.addEventListener('storage', e=>{
        if(e.key==='theme' && e.newValue) applyTheme(e.newValue==='dark');
      });
    })();
    const toggleBtn=document.getElementById('theme-toggle');
    let spin=0;
    toggleBtn.addEventListener('click', ()=>{
      const goDark=!document.body.classList.contains('dark');
      applyTheme(goDark);
      spin+=360; toggleBtn.style.transform=`rotate(${spin}deg)`; setTimeout(()=>toggleBtn.style.transform='',650);
    });

    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', async ()=>{
      try { await logout(); } finally { location.href='auth.html?mode=login'; }
    });

    const categoryList = document.getElementById('categoryList');
    const searchInput = document.getElementById('searchInput');
    const notesContainer = document.getElementById('notes-container');

    let allNotes = [];
    let currentCategory='all';
    let currentSearch='';

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    function renderNotes(list){
      notesContainer.innerHTML='';
      if(!list.length){
        notesContainer.innerHTML=`
          <div class="note-card">
            <h3>No Matches</h3>
            <p>Try changing your filters or upload new material.</p>
            <div class="note-actions"><a href="upload.html">Upload</a></div>
          </div>`;
        return;
      }
      for(const n of list){
        const typePretty = (n.notes_type||'')
          .replace(/_/g,' ')
          .replace(/\b\w/g,m=>m.toUpperCase());
        const card = document.createElement('div');
        card.className='note-card';
        card.dataset.category = n.subject_code;
        card.innerHTML=`
          <h3>${escapeHtml(n.title)}</h3>
          <p>${escapeHtml(n.description || 'No description provided.')}</p>
          <div>
            <span class="category-tag">${escapeHtml(n.academic_year.replace('year','Year '))}</span>
            <span class="category-tag">${escapeHtml(n.semester.replace('semester','Sem '))}</span>
            <span class="category-tag">${escapeHtml(n.subject_code)}</span>
            <span class="category-tag">${escapeHtml(typePretty)}</span>
          </div>
          <div class="note-actions" style="margin-top:6px;">
            <a href="${n.file_url}" target="_blank" rel="noopener noreferrer">View / Download</a>
          </div>`;
        notesContainer.appendChild(card);
      }
    }

    function applyFilters(){
      const filtered = allNotes.filter(n=>{
        const catOk = currentCategory==='all' || n.subject_code===currentCategory;
        const hay = (n.title + ' ' + (n.description||'') + ' ' + n.subject_code).toLowerCase();
        const searchOk = !currentSearch || hay.includes(currentSearch);
        return catOk && searchOk;
      });
      renderNotes(filtered);
    }

    categoryList.addEventListener('click', e=>{
      const a=e.target.closest('a[data-category]');
      if(!a) return;
      e.preventDefault();
      [...categoryList.querySelectorAll('a')].forEach(el=>el.classList.remove('active'));
      a.classList.add('active');
      currentCategory = a.dataset.category;
      applyFilters();
    });

    searchInput.addEventListener('input', e=>{
      currentSearch = e.target.value.toLowerCase().trim();
      applyFilters();
    });

    async function loadNotes(){
      notesContainer.innerHTML = `
        <div class="note-card">
          <h3>Loading...</h3>
          <p>Fetching your notes...</p>
        </div>`;
      try {
        allNotes = await fetchMyNotes();
        applyFilters();
      } catch(err){
        notesContainer.innerHTML = `
          <div class="note-card">
            <h3>Error</h3>
            <p>${escapeHtml(err.message||'Failed to load notes')}</p>
            <div class="note-actions"><a href="#" id="reload">Reload</a></div>
          </div>`;
        const rl = document.getElementById('reload');
        rl?.addEventListener('click', re=>{
          re.preventDefault();
          loadNotes();
        });
      }
    }

    onAuth(user=>{
      if(!user) location.href='auth.html?mode=login';
      else loadNotes();
    });
  </script>
</body>
</html>