<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home - Notes-U</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family:Inter, system-ui, sans-serif; margin:0; background:#f7f9fb; color:#222; min-height:100vh; display:flex; flex-direction:column; }
  header { background:#fff; padding:14px 24px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 4px rgba(0,0,0,0.05); position:sticky; top:0; z-index:10; }
  .logo { font-weight:700; font-size:1.3rem; text-decoration:none; color:#222; }
  .actions { display:flex; gap:12px; }
  button, a.btn { border:none; background:#007bff; color:#fff; padding:10px 16px; font-size:.9rem; font-weight:600; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; }
  button.secondary { background:#e0e5eb; color:#222; }
  button.secondary:hover { background:#d2d9e0; }
  button:hover, a.btn:hover { background:#005fcc; }
  main { flex:1; max-width:1250px; margin:30px auto; padding:0 24px 40px; width:100%; display:grid; grid-template-columns:260px 1fr; gap:30px; }
  aside { background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 14px rgba(0,0,0,0.05); height:fit-content; }
  aside h2 { margin-top:0; font-size:1.2rem; }
  .category-list { list-style:none; padding:0; margin:20px 0 0; }
  .category-list li { margin-bottom:6px; }
  .category-list a { display:block; padding:8px 10px; text-decoration:none; border-radius:6px; font-size:.85rem; color:#555; }
  .category-list a.active, .category-list a:hover { background:#e9edf2; color:#111; }
  section.content { background:#fff; padding:28px; border-radius:16px; box-shadow:0 4px 14px rgba(0,0,0,0.05); min-height:300px; }
  h1 { margin:0 0 6px; font-size:1.8rem; }
  #user-info { color:#666; font-size:.9rem; margin-bottom:22px; }
  .search-bar { margin:0 0 20px; position:relative; }
  .search-bar input { width:100%; padding:11px 14px; border:1px solid #ccc; border-radius:8px; font-size:.9rem; }
  .grid { display:grid; gap:20px; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); }
  .note { border:1px solid #e2e6ea; border-radius:12px; padding:16px 16px 18px; background:#fff; display:flex; flex-direction:column; gap:10px; }
  .note h3 { margin:0; font-size:1.05rem; }
  .tags { display:flex; flex-wrap:wrap; gap:6px; }
  .tag { background:#eef2f7; color:#445; padding:4px 8px; border-radius:6px; font-size:.65rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; }
  .note a.view { text-decoration:none; color:#007bff; font-size:.8rem; font-weight:600; }
  .note a.view:hover { text-decoration:underline; }
  .empty { text-align:center; padding:50px 20px; color:#666; }
  footer { text-align:center; font-size:.75rem; padding:18px 0 30px; color:#777; }
  @media (max-width: 820px) {
    main { grid-template-columns:1fr; }
    aside { order:2; }
    section.content { order:1; }
  }
</style>
</head>
<body>
<header>
  <a class="logo" href="home.html">Notes-U</a>
  <div class="actions">
    <a class="btn" href="upload.html">Upload Note</a>
    <button id="logout-btn" class="secondary">Log Out</button>
  </div>
</header>
<main>
  <aside>
    <h2>Categories</h2>
    <ul class="category-list" id="category-list">
      <li><a data-cat="all" class="active" href="#">All Notes</a></li>
      <!-- Dynamic subjects list (optional enhancement) -->
    </ul>
  </aside>
  <section class="content">
    <h1>Your Notes</h1>
    <div id="user-info"></div>
    <div class="search-bar">
      <input id="search" placeholder="Search by title, subject code, description...">
    </div>
    <div class="grid" id="notes-grid"></div>
    <div class="empty" id="empty-state" style="display:none;">
      No notes found. Upload one to get started.
    </div>
  </section>
</main>
<footer>&copy; 2025 Notes-U</footer>

<script type="module">
import { onAuth, fetchNotes, logout } from './firebase-init.js';

const notesGrid = document.getElementById('notes-grid');
const emptyState = document.getElementById('empty-state');
const logoutBtn = document.getElementById('logout-btn');
const userInfo = document.getElementById('user-info');
const searchInput = document.getElementById('search');

let allNotes = [];
let currentCategory = 'all';

onAuth(async user => {
  if (!user) {
    window.location.href = 'auth.html?mode=login';
    return;
  }
  userInfo.textContent = `Logged in as ${user.displayName || user.email}`;
  await loadNotes();
});

async function loadNotes() {
  try {
    allNotes = await fetchNotes();
    render();
  } catch (e) {
    notesGrid.innerHTML = '<p style="color:#c00">Failed to load notes.</p>';
    console.error(e);
  }
}

function render() {
  const term = searchInput.value.trim().toLowerCase();
  const filtered = allNotes.filter(n => {
    const catOk = currentCategory === 'all' || n.subjectCode === currentCategory;
    const text = (n.title + ' ' + n.subjectCode + ' ' + n.description).toLowerCase();
    const searchOk = !term || text.includes(term);
    return catOk && searchOk;
  });
  notesGrid.innerHTML = '';
  if (filtered.length === 0) {
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';
  filtered.forEach(n => {
    const el = document.createElement('div');
    el.className = 'note';
    el.innerHTML = `
      <h3>${n.title}</h3>
      <div class="tags">
        <span class="tag">${n.academicYear}</span>
        <span class="tag">${n.semester}</span>
        <span class="tag">${n.subjectCode}</span>
        <span class="tag">${n.notesType}</span>
      </div>
      <p style="margin:0;color:#555;font-size:.78rem;line-height:1.4;">${n.description || 'No description.'}</p>
      ${n.fileUrl ? `<a class="view" href="${n.fileUrl}" target="_blank">View / Download</a>` : ''}
    `;
    notesGrid.appendChild(el);
  });
}

searchInput.addEventListener('input', render);

// Optional: dynamically populate categories from notes (after fetch)
function refreshCategories() {
  const catSet = new Set();
  allNotes.forEach(n => catSet.add(n.subjectCode));
  const ul = document.getElementById('category-list');
  [...ul.querySelectorAll('li:not(:first-child)')].forEach(li => li.remove());
  catSet.forEach(code => {
    const li = document.createElement('li');
    li.innerHTML = `<a data-cat="${code}" href="#">${code}</a>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll('a').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      ul.querySelectorAll('a').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      currentCategory = a.dataset.cat;
      render();
    });
  });
}

logoutBtn.addEventListener('click', async () => {
  await logout();
  window.location.href = 'auth.html?mode=login';
});

// After initial load, refresh categories
setTimeout(refreshCategories, 1200);
</script>
</body>
</html>