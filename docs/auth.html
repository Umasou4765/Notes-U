<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticate - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand:#0d6efd;
      --brand-hover:#0b5ed7;
      --danger:#d83535;
      --warning:#f5a524;
      --success:#20a864;
      --focus:0 0 0 4px rgba(13,110,253,.28);
      --ease:cubic-bezier(.4,0,.2,1);
      --radius:18px;
    }
    body {
      font-family:'Inter',system-ui,Arial,sans-serif;
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg,#f5f7fb);
      color:var(--text,#1c1f26);
      -webkit-font-smoothing:antialiased;
      transition:background .6s,color .45s;
      overflow-x:hidden;
    }
    /* Light tokens (default) */
    body {
      --bg:#f5f7fb;
      --panel:#ffffff;
      --panel-accent:#f1f5ff;
      --panel-border:rgba(0,20,60,.12);
      --text:#1c1f26;
      --text-soft:#5d6472;
      --border:rgba(0,0,0,.16);
      --input-bg:#fff;
      --input-border:rgba(0,0,40,.22);
      --shadow:0 14px 48px -12px rgba(0,40,120,.18),0 6px 26px -12px rgba(0,50,140,.10);
      --shadow-sm:0 2px 6px rgba(0,0,0,.08);
      --tag:#e7eefc;
      --tag-text:#334;
      --link:var(--brand);
      --link-hover:var(--brand-hover);
    }
    body.dark {
      --bg:#0f1217;
      --panel:#161c24;
      --panel-accent:#1f2732;
      --panel-border:rgba(255,255,255,.09);
      --text:#e6e9ef;
      --text-soft:#9aa4b4;
      --border:rgba(255,255,255,.16);
      --input-bg:#1d2732;
      --input-border:rgba(255,255,255,.22);
      --shadow:0 18px 58px -16px rgba(0,0,0,.75),0 8px 28px -14px rgba(0,0,0,.55);
      --shadow-sm:0 2px 8px rgba(0,0,0,.45);
      --tag:#243646;
      --tag-text:#c2d0de;
      --link:#81b9ff;
      --link-hover:#a2ccff;
    }

    body::before, body::after {
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-2;
      background:
        radial-gradient(circle at 18% 24%, var(--panel-accent) 0%, transparent 60%),
        radial-gradient(circle at 82% 72%, var(--panel-accent) 0%, transparent 65%);
      animation:floaty 18s linear infinite;
      background-size:160% 160%;
      opacity:.9;
      mix-blend-mode:normal;
      transition:opacity .6s;
    }
    body.dark::before, body.dark::after {
      opacity:.55;
      background:
        radial-gradient(circle at 20% 28%, rgba(80,140,255,.12) 0%, transparent 62%),
        radial-gradient(circle at 78% 74%, rgba(0,170,255,.10) 0%, transparent 68%);
    }
    body::after {
      z-index:-1;
      mix-blend-mode:overlay;
      opacity:.28;
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 2px, transparent 2px 4px);
    }
    body.dark::after {
      mix-blend-mode:normal;
      opacity:.22;
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,.05) 0 2px, transparent 2px 4px);
    }

    @keyframes floaty {
      0%{transform:translateY(0)}
      50%{transform:translateY(-2.5%)}
      100%{transform:translateY(0)}
    }

    .auth-card {
      width:100%;
      max-width:520px;
      background:linear-gradient(145deg,var(--panel),var(--panel-accent) 140%);
      border:1px solid var(--panel-border);
      border-radius:32px;
      padding:56px 56px 52px;
      box-shadow:var(--shadow);
      position:relative;
      box-sizing:border-box;
      overflow:hidden;
      backdrop-filter:blur(6px) saturate(140%);
      -webkit-backdrop-filter:blur(6px) saturate(140%);
      animation:cardIn .7s var(--ease);
    }
    @keyframes cardIn {
      0% { opacity:0; transform:translateY(42px) scale(.95); filter:blur(6px); }
      55% { filter:blur(0); }
      100%{ opacity:1; transform:none; filter:none; }
    }
    .logo {
      font-size:3rem;
      font-weight:700;
      width:98px;
      height:98px;
      border:3px solid currentColor;
      border-radius:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 34px;
      letter-spacing:.5px;
      background:linear-gradient(140deg,rgba(255,255,255,.6),rgba(255,255,255,.1));
      color:var(--text);
      box-shadow:inset 0 0 0 1px var(--panel-border), 0 8px 22px -8px rgba(0,0,0,.25);
      user-select:none;
      transition:transform .6s var(--ease);
    }
    body.dark .logo {
      background:linear-gradient(140deg,rgba(255,255,255,.12),rgba(255,255,255,.04));
      box-shadow:inset 0 0 0 1px var(--panel-border), 0 10px 24px -8px rgba(0,0,0,.55);
    }
    .logo:hover { transform:scale(1.04) rotate(-3deg); }

    h1 {
      margin:0 0 10px;
      font-size:2rem;
      text-align:center;
      letter-spacing:-.5px;
      font-weight:700;
    }
    p.lead {
      margin:0 0 30px;
      text-align:center;
      font-size:.98rem;
      line-height:1.5;
      color:var(--text-soft);
    }

    .mode-tabs {
      display:flex;
      gap:8px;
      margin:0 0 26px;
      background:rgba(0,0,0,.04);
      border:1px solid var(--panel-border);
      padding:4px;
      border-radius:14px;
      position:relative;
    }
    body.dark .mode-tabs { background:rgba(255,255,255,.04); }
    .mode-tab {
      flex:1;
      font:inherit;
      padding:12px 6px;
      border:none;
      background:transparent;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
      color:var(--text-soft);
      position:relative;
      transition:color .35s;
    }
    .mode-tab[aria-selected="true"] {
      color:var(--text);
      background:var(--tag);
      box-shadow:inset 0 0 0 1px var(--panel-border);
    }
    body.dark .mode-tab[aria-selected="true"] {
      background:var(--tag);
      color:var(--tag-text);
    }

    form {
      display:flex;
      flex-direction:column;
      gap:22px;
      margin:0;
    }
    .field {
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
    }
    .field label {
      font-size:.7rem;
      letter-spacing:.6px;
      font-weight:600;
      text-transform:uppercase;
      color:var(--text-soft);
    }
    .input-wrap {
      position:relative;
      display:flex;
      align-items:center;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width:100%;
      font:inherit;
      padding:14px 46px 14px 15px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      color:var(--text);
      border-radius:14px;
      line-height:1.25;
      transition:border-color .35s, box-shadow .35s, background .45s;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    input:focus {
      outline:none;
      border-color:var(--brand);
      box-shadow:var(--focus);
    }
    .toggle-pass {
      position:absolute;
      top:50%;
      right:10px;
      transform:translateY(-50%);
      background:transparent;
      border:none;
      cursor:pointer;
      padding:4px 6px;
      font-size:.65rem;
      font-weight:600;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:var(--link);
      border-radius:6px;
      line-height:1;
    }
    .toggle-pass:hover { text-decoration:underline; }

    .inline-hint {
      font-size:.65rem;
      letter-spacing:.3px;
      color:var(--text-soft);
      line-height:1.3;
      margin-top:-4px;
    }

    .password-meter {
      display:flex;
      gap:6px;
      margin-top:4px;
      height:6px;
    }
    .password-meter span {
      flex:1;
      border-radius:4px;
      background:rgba(0,0,0,.15);
      transition:background .4s;
    }
    body.dark .password-meter span {
      background:rgba(255,255,255,.18);
    }

    .errors {
      margin-top:-4px;
      font-size:.7rem;
      color:var(--danger);
      font-weight:500;
      display:none;
      line-height:1.3;
    }
    .errors.show { display:block; }

    .actions {
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:6px;
    }
    .submit-btn {
      --bg:var(--brand);
      --bg-hover:var(--brand-hover);
      font:inherit;
      border:none;
      padding:15px 20px;
      font-weight:600;
      letter-spacing:.4px;
      border-radius:16px;
      cursor:pointer;
      background:linear-gradient(135deg,var(--bg),var(--bg-hover) 110%);
      color:#fff;
      box-shadow:0 6px 22px -8px rgba(0,60,160,.5), 0 2px 10px -4px rgba(0,60,140,.4);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      transition:background .35s, transform .45s var(--ease), box-shadow .45s var(--ease);
    }
    .submit-btn:hover:not(:disabled) {
      transform:translateY(-3px);
      box-shadow:0 10px 30px -10px rgba(0,70,170,.55), 0 4px 16px -8px rgba(0,70,160,.45);
    }
    .submit-btn:active:not(:disabled) { transform:translateY(0) scale(.96); }
    .submit-btn:disabled {
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:0 0 0 0 transparent;
    }
    .link-row {
      text-align:center;
      font-size:.78rem;
      color:var(--text-soft);
    }
    .link-row a {
      color:var(--link);
      text-decoration:none;
      font-weight:500;
    }
    .link-row a:hover { text-decoration:underline; }

    .forgot-panel {
      margin-top:26px;
      border-top:1px solid var(--panel-border);
      padding-top:24px;
      display:none;
      animation:fade .5s var(--ease);
    }
    .forgot-panel.active { display:block; }
    @keyframes fade {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:none; }
    }
    .badge {
      display:inline-block;
      background:var(--tag);
      color:var(--tag-text);
      font-size:.55rem;
      letter-spacing:.5px;
      padding:4px 8px 3px;
      border-radius:20px;
      font-weight:600;
      margin-left:6px;
      vertical-align:middle;
    }

    .theme-toggle {
      position:fixed;
      top:18px;
      right:18px;
      width:48px;
      height:48px;
      border-radius:16px;
      border:1px solid var(--panel-border);
      background:var(--panel);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow-sm);
      transition:background .5s, transform .5s var(--ease);
    }
    .theme-toggle:hover { transform:translateY(-2px); }
    .theme-toggle:active { transform:translateY(0) scale(.95); }
    .theme-toggle svg {
      width:26px;height:26px;
      transition:opacity .45s, transform .6s var(--ease);
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .theme-toggle .sun { opacity:0; position:absolute; transform:rotate(-45deg) scale(.6); }
    body.dark .theme-toggle .sun { opacity:1; transform:rotate(0deg) scale(1); }
    body.dark .theme-toggle .moon { opacity:0; transform:rotate(55deg) scale(.55); }

    .status-line {
      font-size:.68rem;
      letter-spacing:.4px;
      color:var(--text-soft);
      min-height:1em;
      margin-top:6px;
    }
    .status-line.ok { color:var(--success); }
    .status-line.err { color:var(--danger); }

    @media (max-width:640px){
      .auth-card {
        padding:48px 34px 44px;
        border-radius:26px;
        margin:38px 16px;
      }
      .logo {
        width:86px; height:86px; font-size:2.4rem; margin-bottom:30px;
      }
      h1 { font-size:1.85rem; }
    }

    @media (prefers-reduced-motion:reduce){
      * { animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body class="light">
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>

  <main class="auth-card" role="main">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 id="authHeading">Welcome Back</h1>
    <p class="lead" id="authLead">Log in to access and manage your academic notes.</p>

    <div class="mode-tabs" role="tablist" aria-label="Authentication mode">
      <button id="tab-login" class="mode-tab" role="tab" aria-selected="true" tabindex="0" data-mode="login">Login</button>
      <button id="tab-signup" class="mode-tab" role="tab" aria-selected="false" tabindex="-1" data-mode="signup">Sign Up</button>
    </div>

    <!-- Status line (general) -->
    <div id="globalStatus" class="status-line" aria-live="polite"></div>

    <!-- LOGIN FORM -->
    <form id="loginForm" novalidate autocomplete="off" aria-labelledby="authHeading">
      <div class="field">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@example.com">
        <div class="errors" id="login-email-error" aria-live="polite"></div>
      </div>
      <div class="field">
        <label for="login-password">Password</label>
        <div class="input-wrap">
          <input id="login-password" type="password" required minlength="8" autocomplete="current-password" placeholder="••••••••">
          <button type="button" class="toggle-pass" data-target="login-password" aria-label="Toggle password visibility">Show</button>
        </div>
        <div class="errors" id="login-password-error" aria-live="polite"></div>
      </div>
      <div class="actions">
        <button type="submit" class="submit-btn" id="loginBtn">
          <span class="btn-text">Log In</span>
        </button>
        <div class="link-row">
          <a href="#" id="forgotLink">Forgot password?</a>
        </div>
      </div>
    </form>

    <!-- SIGNUP FORM -->
    <form id="signupForm" novalidate autocomplete="off" hidden aria-labelledby="authHeading">
      <div class="field">
        <label for="signup-email">Email <span class="badge">Required</span></label>
        <input id="signup-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@university.edu">
        <div class="errors" id="signup-email-error" aria-live="polite"></div>
      </div>

      <div class="field">
        <label for="signup-display">Display Name <span class="badge">Optional</span></label>
        <input id="signup-display" type="text" maxlength="40" placeholder="How your name appears">
        <div class="errors" id="signup-display-error" aria-live="polite"></div>
      </div>

      <div class="field">
        <label for="signup-password">Password</label>
        <div class="input-wrap">
          <input id="signup-password" type="password" required minlength="8" autocomplete="new-password" placeholder="At least 8 characters">
          <button type="button" class="toggle-pass" data-target="signup-password" aria-label="Toggle password visibility">Show</button>
        </div>
        <div class="password-meter" aria-hidden="true">
          <span data-meter="1"></span><span data-meter="2"></span><span data-meter="3"></span><span data-meter="4"></span>
        </div>
        <div class="inline-hint">Use 8+ chars, mix letters & numbers for a stronger password.</div>
        <div class="errors" id="signup-password-error" aria-live="polite"></div>
      </div>

      <div class="field">
        <label for="signup-confirm">Confirm Password</label>
        <div class="input-wrap">
          <input id="signup-confirm" type="password" required autocomplete="new-password" placeholder="Re-enter password">
          <button type="button" class="toggle-pass" data-target="signup-confirm" aria-label="Toggle password visibility">Show</button>
        </div>
        <div class="errors" id="signup-confirm-error" aria-live="polite"></div>
      </div>

      <div class="actions">
        <button type="submit" class="submit-btn" id="signupBtn">
          <span class="btn-text">Create Account</span>
        </button>
        <div class="link-row">
          <span>Already have an account? <a href="#" id="toLoginLink">Log in</a></span>
        </div>
      </div>
    </form>

    <!-- Forgot password panel -->
    <section id="forgotPanel" class="forgot-panel" aria-labelledby="forgotHeading" hidden>
      <h2 id="forgotHeading" style="font-size:1.05rem;margin:0 0 10px;letter-spacing:.2px;">Reset Password</h2>
      <p style="margin:0 0 14px;font-size:.78rem;line-height:1.4;color:var(--text-soft);">
        Enter your account email and we'll send a password reset link.
      </p>
      <form id="forgotForm" novalidate>
        <div class="field" style="margin-bottom:6px;">
          <label for="forgot-email">Email</label>
            <input id="forgot-email" type="email" required placeholder="you@example.com" autocomplete="email">
          <div class="errors" id="forgot-email-error" aria-live="polite"></div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button type="submit" class="submit-btn" id="forgotBtn" style="padding:13px 16px;">
            <span class="btn-text">Send Reset Link</span>
          </button>
          <div class="link-row">
            <a href="#" id="closeForgot">Back to login</a>
          </div>
          <div id="forgotStatus" class="status-line" aria-live="polite"></div>
        </div>
      </form>
    </section>

  </main>

  <script type="module">
    import { signupWithEmail, loginWithEmail, friendlyError, auth } from './firebase-init.js';
    import { onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* ---------- THEME ---------- */
    const rootBody = document.body;
    function applyTheme(dark){
      rootBody.classList.toggle('dark', dark);
      rootBody.classList.toggle('light', !dark);
      localStorage.setItem('theme', dark ? 'dark':'light');
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored) applyTheme(stored==='dark');
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
    })();
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      applyTheme(!rootBody.classList.contains('dark'));
    });

    /* ---------- ELEMENTS ---------- */
    const loginForm     = document.getElementById('loginForm');
    const signupForm    = document.getElementById('signupForm');
    const forgotPanel   = document.getElementById('forgotPanel');
    const forgotForm    = document.getElementById('forgotForm');

    const tabLogin      = document.getElementById('tab-login');
    const tabSignup     = document.getElementById('tab-signup');

    const authHeading   = document.getElementById('authHeading');
    const authLead      = document.getElementById('authLead');
    const globalStatus  = document.getElementById('globalStatus');

    const loginBtn      = document.getElementById('loginBtn');
    const signupBtn     = document.getElementById('signupBtn');
    const forgotBtn     = document.getElementById('forgotBtn');
    const forgotStatus  = document.getElementById('forgotStatus');

    /* ---------- MODE HANDLING ---------- */
    function setMode(mode){
      const isSignup = mode === 'signup';
      signupForm.hidden = !isSignup;
      loginForm.hidden = isSignup;
      forgotPanel.hidden = true;
      if(isSignup){
        authHeading.textContent = 'Create Your Account';
        authLead.textContent    = 'Sign up with your email to start uploading and managing your notes.';
        tabSignup.setAttribute('aria-selected','true');
        tabSignup.tabIndex = 0;
        tabLogin.setAttribute('aria-selected','false');
        tabLogin.tabIndex = -1;
      } else {
        authHeading.textContent = 'Welcome Back';
        authLead.textContent    = 'Log in to access and manage your academic notes.';
        tabLogin.setAttribute('aria-selected','true');
        tabLogin.tabIndex = 0;
        tabSignup.setAttribute('aria-selected','false');
        tabSignup.tabIndex = -1;
      }
      const url = new URL(window.location);
      url.searchParams.set('mode', mode);
      history.replaceState({}, '', url);
      clearGlobalStatus();
    }

    // Initialize from query param
    const qpMode = new URLSearchParams(location.search).get('mode');
    setMode(qpMode === 'signup' ? 'signup' : 'login');

    tabLogin.addEventListener('click', ()=> setMode('login'));
    tabSignup.addEventListener('click', ()=> setMode('signup'));
    document.getElementById('toLoginLink').addEventListener('click', e=>{
      e.preventDefault(); setMode('login');
    });

    /* ---------- UTILITIES ---------- */
    function showErr(id, msg){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg || '';
      el.classList.toggle('show', !!msg);
    }
    function clearGlobalStatus(){
      globalStatus.textContent='';
      globalStatus.className='status-line';
    }
    function setGlobalStatus(msg, kind=''){
      globalStatus.textContent = msg;
      globalStatus.className = 'status-line ' + (kind||'');
    }

    function validateEmail(val){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
    }
    function passwordScore(pw){
      if(!pw) return 0;
      let s = 0;
      if(pw.length >= 8) s++;
      if(/[A-Z]/.test(pw)) s++;
      if(/[0-9]/.test(pw)) s++;
      if(/[^A-Za-z0-9]/.test(pw) || pw.length >= 12) s++;
      return s;
    }
    function updatePasswordMeter(pw){
      const score = passwordScore(pw);
      const spans = signupForm.querySelectorAll('.password-meter span');
      spans.forEach((span,i)=>{
        if(i < score){
          span.style.background = score <= 2 ? 'var(--warning)'
                             : score === 3 ? '#f0c330'
                             : 'var(--success)';
        } else {
          span.style.background = body.classList.contains('dark')
            ? 'rgba(255,255,255,.18)'
            : 'rgba(0,0,0,.15)';
        }
      });
    }

    /* ---------- PASSWORD TOGGLE ---------- */
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.toggle-pass');
      if(!btn) return;
      const id = btn.dataset.target;
      const input = document.getElementById(id);
      if(!input) return;
      if(input.type === 'password'){
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
      input.focus({ preventScroll:true });
    });

    /* ---------- LOGIN FLOW ---------- */
    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      clearGlobalStatus();
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      let ok = true;
      if(!email || !validateEmail(email)){
        showErr('login-email-error','Valid email required.');
        ok = false;
      } else showErr('login-email-error','');
      if(!pass){
        showErr('login-password-error','Password required.');
        ok = false;
      } else showErr('login-password-error','');
      if(!ok) return;

      loginBtn.disabled = true;
      loginBtn.querySelector('.btn-text').textContent = 'Logging In...';
      try {
        await loginWithEmail(email, pass);
        setGlobalStatus('Login successful. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 400);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        loginBtn.disabled = false;
        loginBtn.querySelector('.btn-text').textContent = 'Log In';
      }
    });

    /* ---------- SIGNUP FLOW ---------- */
    const signupPasswordInput = document.getElementById('signup-password');
    signupPasswordInput.addEventListener('input', e=>{
      updatePasswordMeter(e.target.value);
    });

    signupForm.addEventListener('submit', async e=>{
      e.preventDefault();
      clearGlobalStatus();
      const email = document.getElementById('signup-email').value.trim();
      const display = document.getElementById('signup-display').value.trim();
      const pass = document.getElementById('signup-password').value;
      const confirm = document.getElementById('signup-confirm').value;

      let ok = true;
      if(!validateEmail(email)){
        showErr('signup-email-error','Enter a valid email address.');
        ok = false;
      } else showErr('signup-email-error','');

      if(pass.length < 8){
        showErr('signup-password-error','Password must be at least 8 characters.');
        ok = false;
      } else if(passwordScore(pass) < 2){
        showErr('signup-password-error','Use a stronger password (mix letters, numbers, symbols).');
        ok = false;
      } else showErr('signup-password-error','');

      if(confirm !== pass){
        showErr('signup-confirm-error','Passwords do not match.');
        ok = false;
      } else showErr('signup-confirm-error','');

      // Display name optional: enforce no crazy length / restrict only
      if(display.length > 40){
        showErr('signup-display-error','Display name too long.');
        ok = false;
      } else showErr('signup-display-error','');

      if(!ok) return;

      signupBtn.disabled = true;
      signupBtn.querySelector('.btn-text').textContent = 'Creating...';
      try {
        await signupWithEmail(email, pass, display || null);
        setGlobalStatus('Account created! Redirecting to home...','ok');
        setTimeout(()=> location.href='home.html', 500);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        signupBtn.disabled = false;
        signupBtn.querySelector('.btn-text').textContent = 'Create Account';
      }
    });

    /* ---------- FORGOT PASSWORD ---------- */
    const forgotLink = document.getElementById('forgotLink');
    const closeForgot = document.getElementById('closeForgot');
    forgotLink.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = false;
      forgotPanel.classList.add('active');
      document.getElementById('forgot-email').focus();
    });
    closeForgot.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = true;
      forgotPanel.classList.remove('active');
      forgotStatus.textContent = '';
    });

    forgotForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      if(!validateEmail(email)){
        document.getElementById('forgot-email-error').textContent = 'Valid email required.';
        return;
      } else {
        document.getElementById('forgot-email-error').textContent = '';
      }
      forgotBtn.disabled = true;
      forgotBtn.querySelector('.btn-text').textContent = 'Sending...';
      forgotStatus.textContent = '';
      try {
        await sendPasswordResetEmail(auth, email);
        forgotStatus.textContent = 'Reset link sent. Check your inbox.';
        forgotStatus.className = 'status-line ok';
      } catch(err){
        forgotStatus.textContent = friendlyError(err);
        forgotStatus.className = 'status-line err';
      } finally {
        forgotBtn.disabled = false;
        forgotBtn.querySelector('.btn-text').textContent = 'Send Reset Link';
      }
    });

    /* ---------- AUTO REDIRECT IF ALREADY LOGGED IN ---------- */
    onAuthStateChanged(auth, user=>{
      if(user && !forgotPanel.classList.contains('active')){
        setGlobalStatus('Already signed in. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 450);
      }
    });

    /* ---------- PASSWORD METER INIT ---------- */
    updatePasswordMeter('');

    /* ---------- ACCESSIBILITY: ENTER SWITCH TABS ---------- */
    document.addEventListener('keydown', e=>{
      if(e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
        if(document.activeElement === tabLogin || document.activeElement === tabSignup){
          e.preventDefault();
          if(e.key === 'ArrowRight') setMode('signup');
          else setMode('login');
          (tabLogin.getAttribute('aria-selected')==='true' ? tabLogin : tabSignup).focus();
        }
      }
    });
  </script>
</body>
</html>
