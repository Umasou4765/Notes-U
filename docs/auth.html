<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticate - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark">
  <!-- Prevent caching of auth page to reduce stale back navigation -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand:#0d6efd;
      --brand-hover:#0b5ed7;
      --danger:#d83535;
      --warning:#f5a524;
      --success:#20a864;
      --focus-ring:0 0 0 4px rgba(13,110,253,.30);
      --ease:cubic-bezier(.4,0,.2,1);
    }
    body {
      --bg:#f5f7fb;
      --bg-accent-1:#dfe8ff;
      --bg-accent-2:#f1f5ff;
      --panel:#ffffff;
      --panel-alt:#f1f5ff;
      --panel-border:rgba(0,25,70,.14);
      --text:#1b1f27;
      --text-soft:#5d6472;
      --input-bg:#ffffff;
      --input-border:rgba(10,30,70,.22);
      --shadow:0 14px 48px -14px rgba(0,50,140,.18), 0 6px 26px -12px rgba(0,60,160,.12);
      --shadow-sm:0 2px 6px rgba(0,0,0,.08);
      --tag:#e4ecfa;
      --tag-text:#2c3440;
      --link:var(--brand);
      --link-hover:var(--brand-hover);
    }
    body.dark {
      --bg:#0f1217;
      --bg-accent-1:#1e2734;
      --bg-accent-2:#18212c;
      --panel:#161c24;
      --panel-alt:#1e2732;
      --panel-border:rgba(255,255,255,.10);
      --text:#e6e9ef;
      --text-soft:#9aa4b4;
      --input-bg:#1d2732;
      --input-border:rgba(255,255,255,.22);
      --shadow:0 18px 60px -18px rgba(0,0,0,.75), 0 8px 32px -14px rgba(0,0,0,.55);
      --shadow-sm:0 2px 8px rgba(0,0,0,.42);
      --tag:#263847;
      --tag-text:#c6d4e2;
      --link:#81b9ff;
      --link-hover:#a9d2ff;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family:'Inter',system-ui,Arial,sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 18px 42px;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      transition:background .6s,color .45s;
      overflow-x:hidden;
    }
    body::before, body::after {
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      pointer-events:none;
      background:
        radial-gradient(circle at 18% 24%, var(--bg-accent-1) 0%, transparent 60%),
        radial-gradient(circle at 82% 72%, var(--bg-accent-2) 0%, transparent 65%);
      background-size:160% 160%;
      animation:floaty 18s linear infinite;
      opacity:.9;
      transition:opacity .7s;
    }
    body.dark::before, body.dark::after {
      opacity:.55;
      background:
        radial-gradient(circle at 20% 30%, rgba(70,130,255,.14) 0%, transparent 62%),
        radial-gradient(circle at 78% 75%, rgba(0,170,255,.11) 0%, transparent 68%);
    }
    body::after {
      z-index:-1;
      mix-blend-mode:overlay;
      opacity:.30;
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 2px, transparent 2px 4px);
    }
    body.dark::after {
      mix-blend-mode:normal;
      opacity:.22;
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,.05) 0 2px, transparent 2px 4px);
    }
    @keyframes floaty {
      0%{transform:translateY(0)}
      50%{transform:translateY(-2.2%)}
      100%{transform:translateY(0)}
    }
    .auth-card {
      width:100%;
      max-width:520px;
      background:linear-gradient(145deg,var(--panel),var(--panel-alt) 140%);
      border:1px solid var(--panel-border);
      border-radius:32px;
      padding:60px 56px 54px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(6px) saturate(140%);
      -webkit-backdrop-filter:blur(6px) saturate(140%);
      animation:cardIn .7s var(--ease);
    }
    @keyframes cardIn {
      0% { opacity:0; transform:translateY(42px) scale(.95); filter:blur(6px); }
      55% { filter:blur(0); }
      100%{ opacity:1; transform:none; filter:none; }
    }
    .logo {
      font-size:3rem;
      font-weight:700;
      width:100px;
      height:100px;
      border:3px solid currentColor;
      border-radius:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 36px;
      user-select:none;
      letter-spacing:.6px;
      background:linear-gradient(140deg,rgba(255,255,255,.60),rgba(255,255,255,.08));
      box-shadow:inset 0 0 0 1px var(--panel-border), 0 10px 26px -10px rgba(0,0,0,.22);
      transition:transform .6s var(--ease), background .6s;
    }
    body.dark .logo {
      background:linear-gradient(140deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      box-shadow:inset 0 0 0 1px var(--panel-border), 0 12px 30px -10px rgba(0,0,0,.55);
    }
    .logo:hover { transform:scale(1.045) rotate(-3deg); }
    h1 {
      margin:0 0 12px;
      font-size:2rem;
      font-weight:700;
      letter-spacing:-.5px;
      text-align:center;
      line-height:1.15;
    }
    p.lead {
      margin:0 0 32px;
      font-size:.98rem;
      line-height:1.55;
      text-align:center;
      color:var(--text-soft);
    }
    .forms-shell {
      position:relative;
      min-height:400px;
      transition:min-height .35s var(--ease);
    }
    form.auth-form {
      display:none;
      animation:fade .45s var(--ease);
      margin:0;
    }
    form.auth-form.active { display:block; }
    @keyframes fade {
      from { opacity:0; transform:translateY(14px); }
      to { opacity:1; transform:none; }
    }
    .field {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:20px;
      position:relative;
    }
    .field label {
      font-size:.70rem;
      font-weight:600;
      letter-spacing:.55px;
      text-transform:uppercase;
      color:var(--text-soft);
    }
    .input-wrap { position:relative; display:flex; align-items:center; }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width:100%;
      font:inherit;
      padding:15px 50px 15px 16px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      color:var(--text);
      border-radius:14px;
      line-height:1.25;
      transition:border-color .35s, box-shadow .35s, background .45s;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    input:focus {
      outline:none;
      border-color:var(--brand);
      box-shadow:var(--focus-ring);
    }
    .toggle-pass {
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:transparent;
      border:none;
      cursor:pointer;
      font-size:.62rem;
      letter-spacing:.6px;
      font-weight:600;
      padding:5px 7px;
      color:var(--link);
      text-transform:uppercase;
      border-radius:6px;
    }
    .toggle-pass:hover { text-decoration:underline; }
    .password-meter {
      display:flex;
      gap:6px;
      height:6px;
      margin-top:4px;
    }
    .password-meter span {
      flex:1;
      border-radius:4px;
      background:rgba(0,0,0,.15);
      transition:background .4s;
    }
    body.dark .password-meter span { background:rgba(255,255,255,.16); }
    .inline-hint {
      font-size:.64rem;
      line-height:1.25;
      color:var(--text-soft);
      margin-top:4px;
      letter-spacing:.3px;
    }
    .errors {
      font-size:.7rem;
      color:var(--danger);
      font-weight:500;
      line-height:1.3;
      display:none;
    }
    .errors.show { display:block; }
    .submit-btn {
      --bg:var(--brand);
      --bg-hover:var(--brand-hover);
      font:inherit;
      border:none;
      padding:16px 22px;
      font-size:1rem;
      font-weight:600;
      letter-spacing:.4px;
      border-radius:16px;
      background:linear-gradient(135deg,var(--bg),var(--bg-hover) 115%);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow:0 6px 22px -8px rgba(0,60,160,.5), 0 2px 10px -4px rgba(0,60,140,.4);
      transition:background .35s, transform .5s var(--ease), box-shadow .5s var(--ease);
      width:100%;
      margin-top:4px;
    }
    .submit-btn:hover:not(:disabled){
      transform:translateY(-3px);
      box-shadow:0 10px 34px -12px rgba(0,70,170,.55), 0 4px 18px -8px rgba(0,70,160,.45);
    }
    .submit-btn:active:not(:disabled){ transform:translateY(0) scale(.96); }
    .submit-btn:disabled {
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    .switch-links {
      margin-top:26px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:.8rem;
      letter-spacing:.25px;
    }
    .switch-links a {
      color:var(--link);
      text-decoration:none;
      font-weight:600;
    }
    .switch-links a:hover { text-decoration:underline; }
    .forgot-link {
      font-size:.72rem;
      font-weight:500;
      text-decoration:none;
      color:var(--link);
      display:inline-block;
      margin-top:4px;
    }
    .forgot-link:hover { text-decoration:underline; }
    .forgot-panel {
      margin-top:28px;
      padding:22px 20px 24px;
      background:var(--panel-alt);
      border:1px solid var(--panel-border);
      border-radius:18px;
      display:none;
      animation:fade .45s var(--ease);
    }
    .forgot-panel.active { display:block; }
    .forgot-panel h2 {
      margin:0 0 10px;
      font-size:1rem;
      font-weight:600;
      letter-spacing:.3px;
    }
    .status-line {
      font-size:.65rem;
      letter-spacing:.4px;
      color:var(--text-soft);
      min-height:1em;
      margin-top:10px;
    }
    .status-line.ok { color:var(--success); }
    .status-line.err { color:var(--danger); }
    .global-status {
      text-align:center;
      font-size:.7rem;
      letter-spacing:.4px;
      min-height:1em;
      margin:0 0 16px;
      color:var(--text-soft);
    }
    .global-status.ok { color:var(--success); }
    .global-status.err { color:var(--danger); }
    .theme-toggle {
      position:fixed;
      top:18px;
      right:18px;
      width:50px;
      height:50px;
      border-radius:18px;
      background:var(--panel);
      border:1px solid var(--panel-border);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:var(--shadow-sm);
      transition:transform .55s var(--ease), background .55s, box-shadow .45s;
      z-index:10;
    }
    .theme-toggle:hover { transform:translateY(-2px); }
    .theme-toggle:active { transform:translateY(0) scale(.95); }
    .theme-toggle svg {
      width:28px;height:28px;
      transition:opacity .45s, transform .65s var(--ease);
      stroke-linecap:round; stroke-linejoin:round;
    }
    .theme-toggle .sun { opacity:0; position:absolute; transform:rotate(-40deg) scale(.6); }
    body.dark .theme-toggle .sun { opacity:1; transform:rotate(0) scale(1); }
    body.dark .theme-toggle .moon { opacity:0; transform:rotate(55deg) scale(.55); }
    @media (max-width:640px){
      .auth-card { padding:52px 36px 48px; border-radius:26px; }
      .logo { width:88px; height:88px; font-size:2.6rem; margin-bottom:30px; }
      h1 { font-size:1.88rem; }
      .forms-shell { min-height:430px; }
    }
    @media (prefers-reduced-motion:reduce){
      * { animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body class="light">
  <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>

  <main class="auth-card" role="main" aria-labelledby="authHeading">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 id="authHeading">Welcome Back</h1>
    <p class="lead" id="authLead">Log in to access and manage your academic notes.</p>

    <div id="globalStatus" class="global-status" aria-live="polite"></div>

    <div class="forms-shell" id="formsShell">
      <!-- LOGIN -->
      <form id="loginForm" class="auth-form active" novalidate autocomplete="off" aria-describedby="globalStatus">
        <div class="field">
          <label for="login-email">Email</label>
          <div class="input-wrap">
            <input id="login-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@example.com" maxlength="120">
          </div>
          <div class="errors" id="login-email-error" aria-live="polite"></div>
        </div>

        <div class="field" style="margin-bottom:12px;">
          <label for="login-password">Password</label>
            <div class="input-wrap">
              <input id="login-password" type="password" required minlength="8" autocomplete="current-password" placeholder="••••••••">
              <button type="button" class="toggle-pass" data-target="login-password" aria-label="Toggle password visibility">Show</button>
            </div>
          <div class="errors" id="login-password-error" aria-live="polite"></div>
          <a href="#" id="forgotLink" class="forgot-link">Forgot password?</a>
        </div>

        <button type="submit" class="submit-btn" id="loginBtn"><span class="btn-text">Log In</span></button>
      </form>

      <!-- SIGN UP -->
      <form id="signupForm" class="auth-form" novalidate autocomplete="off" hidden aria-describedby="globalStatus">
        <div class="field">
          <label for="signup-email">Email</label>
          <div class="input-wrap">
            <input id="signup-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@university.edu" maxlength="120">
          </div>
          <div class="errors" id="signup-email-error" aria-live="polite"></div>
        </div>

        <div class="field">
          <label for="signup-display">Display Name (Optional)</label>
          <div class="input-wrap">
            <input id="signup-display" type="text" maxlength="40" placeholder="How your name appears">
          </div>
          <div class="errors" id="signup-display-error" aria-live="polite"></div>
        </div>

        <div class="field">
          <label for="signup-password">Password</label>
          <div class="input-wrap">
            <input id="signup-password" type="password" required minlength="8" autocomplete="new-password" placeholder="At least 8 characters">
            <button type="button" class="toggle-pass" data-target="signup-password" aria-label="Toggle password visibility">Show</button>
          </div>
            <div class="password-meter" aria-hidden="true">
              <span data-meter="1"></span><span data-meter="2"></span><span data-meter="3"></span><span data-meter="4"></span>
            </div>
          <div class="inline-hint">Use 8+ chars. Mixing upper, number & symbol strengthens it.</div>
          <div class="errors" id="signup-password-error" aria-live="polite"></div>
        </div>

        <div class="field" style="margin-bottom:12px;">
          <label for="signup-confirm">Confirm Password</label>
          <div class="input-wrap">
            <input id="signup-confirm" type="password" required autocomplete="new-password" placeholder="Re-enter password">
            <button type="button" class="toggle-pass" data-target="signup-confirm" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="signup-confirm-error" aria-live="polite"></div>
        </div>

        <button type="submit" class="submit-btn" id="signupBtn"><span class="btn-text">Create Account</span></button>
      </form>
    </div>

    <div class="switch-links" aria-live="polite">
      <a href="auth.html?signup" id="linkToSignup" style="display:block;">Don't have an account? Create one now</a>
      <a href="auth.html?login" id="linkToLogin" style="display:none;">Already have an account? Log In instead</a>
    </div>

    <!-- Forgot password panel -->
    <section id="forgotPanel" class="forgot-panel" aria-labelledby="forgotHeading" hidden>
      <h2 id="forgotHeading">Reset Password</h2>
      <p style="margin:0 0 14px; font-size:.75rem; line-height:1.45; color:var(--text-soft);">
        Enter your account email and a password reset link will be sent if it exists.
      </p>
      <form id="forgotForm" novalidate autocomplete="off">
        <div class="field" style="margin-bottom:4px;">
          <label for="forgot-email">Email</label>
          <div class="input-wrap">
            <input id="forgot-email" type="email" required placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="errors" id="forgot-email-error" aria-live="polite"></div>
        </div>
        <button type="submit" class="submit-btn" id="forgotBtn" style="margin-top:6px;padding:14px 18px;">
          <span class="btn-text">Send Reset Link</span>
        </button>
        <div class="status-line" id="forgotStatus" aria-live="polite"></div>
        <div style="margin-top:8px;text-align:center;">
          <a href="#" id="closeForgot" class="forgot-link">Back to login</a>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { signupWithEmail, loginWithEmail, friendlyError, auth } from './firebase-init.js';
    import { onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* Theme */
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(dark){
      body.classList.toggle('dark', dark);
      body.classList.toggle('light', !dark);
      localStorage.setItem('theme', dark ? 'dark':'light');
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored) applyTheme(stored==='dark');
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
    })();
    themeToggle.addEventListener('click', ()=> applyTheme(!body.classList.contains('dark')));

    /* Elements */
    const formsShell      = document.getElementById('formsShell');
    const loginForm       = document.getElementById('loginForm');
    const signupForm      = document.getElementById('signupForm');
    const forgotPanel     = document.getElementById('forgotPanel');
    const forgotForm      = document.getElementById('forgotForm');
    const linkToSignup    = document.getElementById('linkToSignup');
    const linkToLogin     = document.getElementById('linkToLogin');
    const forgotLink      = document.getElementById('forgotLink');
    const closeForgot     = document.getElementById('closeForgot');
    const authHeading     = document.getElementById('authHeading');
    const authLead        = document.getElementById('authLead');
    const globalStatus    = document.getElementById('globalStatus');
    const loginBtn        = document.getElementById('loginBtn');
    const signupBtn       = document.getElementById('signupBtn');
    const forgotBtn       = document.getElementById('forgotBtn');
    const forgotStatus    = document.getElementById('forgotStatus');
    const signupPassword  = document.getElementById('signup-password');

    /* Mode detection */
    function detectMode(){
      const qs = window.location.search;
      if(/\?signup\b/i.test(qs)) return 'signup';
      if(/\?login\b/i.test(qs)) return 'login';
      const p = new URLSearchParams(qs).get('mode');
      return p === 'signup' ? 'signup' : 'login';
    }
    let mode = detectMode();

    function setGlobalStatus(msg='', kind=''){
      globalStatus.textContent = msg;
      globalStatus.className = 'global-status' + (kind ? ' ' + kind : '');
    }
    function showErr(id, msg){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg || '';
      el.classList.toggle('show', !!msg);
    }
    function applyMode(m){
      mode = m;
      const isSignup = m === 'signup';
      loginForm.classList.toggle('active', !isSignup);
      signupForm.classList.toggle('active', isSignup);
      loginForm.hidden = isSignup;
      signupForm.hidden = !isSignup;
      linkToSignup.style.display = isSignup ? 'none':'block';
      linkToLogin.style.display  = isSignup ? 'block':'none';
      forgotPanel.hidden = true;
      forgotPanel.classList.remove('active');
      if(isSignup){
        authHeading.textContent = 'Create Your Account';
        authLead.textContent    = 'Sign up with your email to start uploading and managing your notes.';
      } else {
        authHeading.textContent = 'Welcome Back';
        authLead.textContent    = 'Log in to access and manage your academic notes.';
      }
      requestAnimationFrame(()=>{
        const activeHeight = document.querySelector('form.auth-form.active').offsetHeight;
        const inactiveHeight = document.querySelector('form.auth-form:not(.active)').offsetHeight;
        const target = Math.max(activeHeight, inactiveHeight, 400);
        formsShell.style.minHeight = target + 'px';
      });
      history.replaceState({}, '', 'auth.html?' + m);
      setGlobalStatus();
    }
    applyMode(mode);

    linkToSignup.addEventListener('click', e=>{ e.preventDefault(); applyMode('signup'); });
    linkToLogin.addEventListener('click',  e=>{ e.preventDefault(); applyMode('login');  });

    /* Password strength */
    function passwordScore(pw){
      if(!pw) return 0;
      let s=0;
      if(pw.length >= 8) s++;
      if(/[A-Z]/.test(pw)) s++;
      if(/[0-9]/.test(pw)) s++;
      if(/[^A-Za-z0-9]/.test(pw) || pw.length >= 12) s++;
      return s;
    }
    function updatePasswordMeter(pw){
      const score = passwordScore(pw);
      const spans = signupForm.querySelectorAll('.password-meter span');
      spans.forEach((span,i)=>{
        if(i < score){
          span.style.background = score <= 2 ? 'var(--warning)'
                               : score === 3 ? '#f0c330'
                               : 'var(--success)';
        } else {
          span.style.background = body.classList.contains('dark')
            ? 'rgba(255,255,255,.16)'
            : 'rgba(0,0,0,.15)';
        }
      });
    }
    signupPassword.addEventListener('input', e=> updatePasswordMeter(e.target.value));
    updatePasswordMeter('');

    /* Password visibility */
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.toggle-pass');
      if(!btn) return;
      const input = document.getElementById(btn.dataset.target);
      if(!input) return;
      if(input.type === 'password'){
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
      input.focus({ preventScroll:true });
    });

    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    /* Login */
    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setGlobalStatus();
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      let ok = true;
      if(!email || !validEmail(email)){
        showErr('login-email-error','Valid email required.');
        ok=false;
      } else showErr('login-email-error','');
      if(!pass){
        showErr('login-password-error','Password required.');
        ok=false;
      } else showErr('login-password-error','');
      if(!ok) return;

      loginBtn.disabled = true;
      loginBtn.querySelector('.btn-text').textContent = 'Logging In...';
      try {
        await loginWithEmail(email, pass);
        setGlobalStatus('Login successful. Redirecting...','ok');
        setTimeout(()=> location.replace('home.html'), 450);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        loginBtn.disabled = false;
        loginBtn.querySelector('.btn-text').textContent = 'Log In';
      }
    });

    /* Signup */
    signupForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setGlobalStatus();
      const email   = document.getElementById('signup-email').value.trim();
      const display = document.getElementById('signup-display').value.trim();
      const pass    = document.getElementById('signup-password').value;
      const conf    = document.getElementById('signup-confirm').value;

      let ok = true;
      if(!validEmail(email)){
        showErr('signup-email-error','Enter a valid email.');
        ok=false;
      } else showErr('signup-email-error','');

      if(pass.length < 8){
        showErr('signup-password-error','At least 8 characters required.');
        ok=false;
      } else if(passwordScore(pass) < 2){
        showErr('signup-password-error','Use mixed case, numbers or symbols.');
        ok=false;
      } else showErr('signup-password-error','');

      if(conf !== pass){
        showErr('signup-confirm-error','Passwords do not match.');
        ok=false;
      } else showErr('signup-confirm-error','');

      if(display.length > 40){
        showErr('signup-display-error','Display name too long.');
        ok=false;
      } else showErr('signup-display-error','');

      if(!ok) return;

      signupBtn.disabled = true;
      signupBtn.querySelector('.btn-text').textContent = 'Creating...';
      try {
        await signupWithEmail(email, pass, display || null);
        setGlobalStatus('Account created! Redirecting...','ok');
        setTimeout(()=> location.replace('home.html'), 550);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        signupBtn.disabled = false;
        signupBtn.querySelector('.btn-text').textContent = 'Create Account';
      }
    });

    /* Forgot password */
    forgotLink.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = false;
      forgotPanel.classList.add('active');
      document.getElementById('forgot-email').focus();
      setGlobalStatus();
    });
    closeForgot.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = true;
      forgotPanel.classList.remove('active');
      forgotStatus.textContent = '';
    });
    forgotForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      if(!validEmail(email)){
        document.getElementById('forgot-email-error').textContent = 'Valid email required.';
        return;
      } else {
        document.getElementById('forgot-email-error').textContent = '';
      }
      forgotBtn.disabled = true;
      forgotBtn.querySelector('.btn-text').textContent = 'Sending...';
      forgotStatus.textContent = '';
      forgotStatus.className = 'status-line';
      try {
        await sendPasswordResetEmail(auth, email);
        forgotStatus.textContent = 'Reset link sent (check inbox / spam).';
        forgotStatus.className = 'status-line ok';
      } catch(err){
        forgotStatus.textContent = friendlyError(err);
        forgotStatus.className = 'status-line err';
      } finally {
        forgotBtn.disabled = false;
        forgotBtn.querySelector('.btn-text').textContent = 'Send Reset Link';
      }
    });

    /* Auto redirect if already logged in (replace) */
    onAuthStateChanged(auth, user=>{
      if(user && !forgotPanel.classList.contains('active')){
        setGlobalStatus('Already signed in. Redirecting...','ok');
        setTimeout(()=> location.replace('home.html'), 480);
      }
    });

    /* Resize shell on window resize */
    window.addEventListener('resize', ()=>{
      const active = document.querySelector('form.auth-form.active');
      if(active){
        formsShell.style.minHeight = Math.max(
          active.offsetHeight,
          document.querySelector('form.auth-form:not(.active)')?.offsetHeight || 0,
          400
        ) + 'px';
      }
    });

    /* If page restored from bfcache, clear sensitive inputs */
    window.addEventListener('pageshow', e=>{
      if(e.persisted){
        loginForm.reset();
        signupForm.reset();
      }
    });
  </script>
</body>
</html>
