<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticate - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="light auth-page">
  <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>
  <main class="auth-card" role="main" aria-labelledby="authHeading">
    <div class="logo logo--lg" aria-label="Notes-U Logo">U</div>
    <h1 id="authHeading">Welcome Back</h1>
    <p class="lead" id="authLead">Log in to access and manage your academic notes.</p>
    <div id="globalStatus" class="global-status" aria-live="polite"></div>
    <div class="forms-shell" id="formsShell">
      <form id="loginForm" class="auth-form active" novalidate autocomplete="off" aria-describedby="globalStatus">
        <div class="field">
          <label for="login-email">Email</label>
          <div class="input-wrap">
            <input id="login-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@example.com" maxlength="120">
          </div>
          <div class="errors" id="login-email-error" aria-live="polite"></div>
        </div>
        <div class="field" style="margin-bottom:12px;">
          <label for="login-password">Password</label>
          <div class="input-wrap">
            <input id="login-password" type="password" required minlength="8" autocomplete="current-password" placeholder="••••••••">
            <button type="button" class="toggle-pass" data-target="login-password" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="login-password-error" aria-live="polite"></div>
          <a href="#" id="forgotLink" class="forgot-link">Forgot password?</a>
        </div>
        <button type="submit" class="submit-btn" id="loginBtn"><span class="btn-text">Log In</span></button>
      </form>
      <form id="signupForm" class="auth-form" novalidate autocomplete="off" hidden aria-describedby="globalStatus">
        <div class="field">
          <label for="signup-email">Email</label>
          <div class="input-wrap">
            <input id="signup-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@university.edu" maxlength="120">
          </div>
          <div class="errors" id="signup-email-error" aria-live="polite"></div>
        </div>
        <div class="field">
          <label for="signup-password">Password</label>
          <div class="input-wrap">
            <input id="signup-password" type="password" required minlength="8" autocomplete="new-password" placeholder="At least 8 characters">
            <button type="button" class="toggle-pass" data-target="signup-password" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="inline-hint" style="font-size:.72rem;color:var(--text-soft);margin-top:3px;">Use 8+ chars. Mixing upper, number & symbol strengthens it.</div>
          <div class="errors" id="signup-password-error" aria-live="polite"></div>
        </div>
        <div class="field" style="margin-bottom:12px;">
          <label for="signup-confirm">Confirm Password</label>
          <div class="input-wrap">
            <input id="signup-confirm" type="password" required autocomplete="new-password" placeholder="Re-enter password">
            <button type="button" class="toggle-pass" data-target="signup-confirm" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="signup-confirm-error" aria-live="polite"></div>
        </div>
        <button type="submit" class="submit-btn" id="signupBtn"><span class="btn-text">Create Account</span></button>
      </form>
    </div>
    <div class="switch-links" aria-live="polite">
      <a href="auth.html?signup" id="linkToSignup" style="display:block;">Don't have an account? Create one now</a>
      <a href="auth.html?login" id="linkToLogin" style="display:none;">Already have an account? Log In instead</a>
    </div>
    <section id="forgotPanel" class="forgot-panel" aria-labelledby="forgotHeading" hidden>
      <h2 id="forgotHeading">Reset Password</h2>
      <p style="margin:0 0 14px; font-size:.75rem; line-height:1.45; color:var(--text-soft);">
        Enter your account email and a password reset link will be sent if it exists.
      </p>
      <form id="forgotForm" novalidate autocomplete="off">
        <div class="field" style="margin-bottom:4px;">
          <label for="forgot-email">Email</label>
          <div class="input-wrap">
            <input id="forgot-email" type="email" required placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="errors" id="forgot-email-error" aria-live="polite"></div>
        </div>
        <button type="submit" class="submit-btn" id="forgotBtn" style="margin-top:6px;padding:14px 18px;">
          <span class="btn-text">Send Reset Link</span>
        </button>
        <div class="status-line" id="forgotStatus" aria-live="polite"></div>
        <div style="margin-top:8px;text-align:center;">
          <a href="#" id="closeForgot" class="forgot-link">Back to login</a>
        </div>
      </form>
    </section>
  </main>
  <script type="module">
    import { signupWithEmail, loginWithEmail, friendlyError, auth } from './firebase-init.js';
    import { onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(dark){
      body.classList.toggle('dark', dark);
      body.classList.toggle('light', !dark);
      localStorage.setItem('theme', dark ? 'dark':'light');
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored) applyTheme(stored==='dark');
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
      window.addEventListener('storage', e=>{
        if(e.key==='theme' && e.newValue){ applyTheme(e.newValue==='dark'); }
      });
    })();
    themeToggle.addEventListener('click', ()=> applyTheme(!body.classList.contains('dark')));

    const formsShell      = document.getElementById('formsShell');
    const loginForm       = document.getElementById('loginForm');
    const signupForm      = document.getElementById('signupForm');
    const forgotPanel     = document.getElementById('forgotPanel');
    const forgotForm      = document.getElementById('forgotForm');
    const linkToSignup    = document.getElementById('linkToSignup');
    const linkToLogin     = document.getElementById('linkToLogin');
    const forgotLink      = document.getElementById('forgotLink');
    const closeForgot     = document.getElementById('closeForgot');
    const authHeading     = document.getElementById('authHeading');
    const authLead        = document.getElementById('authLead');
    const globalStatus    = document.getElementById('globalStatus');
    const loginBtn        = document.getElementById('loginBtn');
    const signupBtn       = document.getElementById('signupBtn');
    const forgotBtn       = document.getElementById('forgotBtn');
    const forgotStatus    = document.getElementById('forgotStatus');

    function detectMode(){
      const qs = window.location.search;
      if(/\?signup\b/i.test(qs)) return 'signup';
      if(/\?login\b/i.test(qs)) return 'login';
      const p = new URLSearchParams(qs).get('mode');
      return p === 'signup' ? 'signup' : 'login';
    }
    let mode = detectMode();

    function setGlobalStatus(msg='', kind=''){
      globalStatus.textContent = msg;
      globalStatus.className = 'global-status' + (kind ? ' ' + kind : '');
    }
    function showErr(id,msg){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg || '';
      el.classList.toggle('show', !!msg);
    }
    function applyMode(m){
      mode = m;
      const isSignup = m === 'signup';
      loginForm.classList.toggle('active', !isSignup);
      signupForm.classList.toggle('active', isSignup);
      loginForm.hidden = isSignup;
      signupForm.hidden = !isSignup;
      linkToSignup.style.display = isSignup ? 'none':'block';
      linkToLogin.style.display  = isSignup ? 'block':'none';
      forgotPanel.hidden = true;
      forgotPanel.classList.remove('active');
      if(isSignup){
        authHeading.textContent = 'Create Your Account';
        authLead.textContent    = 'Sign up with your email to start uploading and managing your notes.';
      } else {
        authHeading.textContent = 'Welcome Back';
        authLead.textContent    = 'Log in to access and manage your academic notes.';
      }
      setGlobalStatus();
    }
    applyMode(mode);
    linkToSignup.addEventListener('click', e=>{ e.preventDefault(); applyMode('signup'); });
    linkToLogin.addEventListener('click',  e=>{ e.preventDefault(); applyMode('login'); });

    document.addEventListener('click', e=>{
      const btn = e.target.closest('.toggle-pass');
      if(!btn) return;
      const input = document.getElementById(btn.dataset.target);
      if(!input) return;
      if(input.type === 'password'){
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
      input.focus({ preventScroll:true });
    });

    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setGlobalStatus();
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      let ok = true;
      if(!email || !validEmail(email)){ showErr('login-email-error','Valid email required.'); ok=false; } else showErr('login-email-error','');
      if(!pass){ showErr('login-password-error','Password required.'); ok=false; } else showErr('login-password-error','');
      if(!ok) return;
      loginBtn.disabled = true;
      loginBtn.querySelector('.btn-text').textContent = 'Logging In...';
      try {
        await loginWithEmail(email, pass);
        setGlobalStatus('Login successful. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 450);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        loginBtn.disabled = false;
        loginBtn.querySelector('.btn-text').textContent = 'Log In';
      }
    });

    signupForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setGlobalStatus();
      const email = document.getElementById('signup-email').value.trim();
      const pass  = document.getElementById('signup-password').value;
      const conf  = document.getElementById('signup-confirm').value;
      let ok = true;
      if(!validEmail(email)){ showErr('signup-email-error','Enter a valid email.'); ok=false; } else showErr('signup-email-error','');
      if(pass.length < 8){ showErr('signup-password-error','At least 8 characters required.'); ok=false; } else showErr('signup-password-error','');
      if(conf !== pass){ showErr('signup-confirm-error','Passwords do not match.'); ok=false; } else showErr('signup-confirm-error','');
      if(!ok) return;
      signupBtn.disabled = true;
      signupBtn.querySelector('.btn-text').textContent = 'Creating...';
      try {
        await signupWithEmail(email, pass);
        setGlobalStatus('Account created! Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 550);
      } catch(err){
        setGlobalStatus(friendlyError(err),'err');
        signupBtn.disabled = false;
        signupBtn.querySelector('.btn-text').textContent = 'Create Account';
      }
    });

    const forgotLink = document.getElementById('forgotLink');
    const closeForgot = document.getElementById('closeForgot');
    forgotLink.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = false;
      forgotPanel.classList.add('active');
      document.getElementById('forgot-email').focus();
      setGlobalStatus();
    });
    closeForgot.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden = true;
      forgotPanel.classList.remove('active');
      forgotStatus.textContent = '';
    });
    forgotForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      if(!validEmail(email)){
        document.getElementById('forgot-email-error').textContent = 'Valid email required.';
        return;
      } else {
        document.getElementById('forgot-email-error').textContent = '';
      }
      forgotBtn.disabled = true;
      forgotBtn.querySelector('.btn-text').textContent = 'Sending...';
      forgotStatus.textContent = '';
      forgotStatus.className = 'status-line';
      try {
        await sendPasswordResetEmail(auth, email);
        forgotStatus.textContent = 'Reset link sent (check inbox / spam).';
        forgotStatus.className = 'status-line ok';
      } catch(err){
        forgotStatus.textContent = friendlyError(err);
        forgotStatus.className = 'status-line err';
      } finally {
        forgotBtn.disabled = false;
        forgotBtn.querySelector('.btn-text').textContent = 'Send Reset Link';
      }
    });

    onAuthStateChanged(auth, user=>{
      if(user && !forgotPanel.classList.contains('active')){
        setGlobalStatus('Already signed in. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 480);
      }
    });
  </script>
</body>
</html>