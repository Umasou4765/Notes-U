<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authenticate - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/app.css">
</head>
<body class="light">
  <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme">
    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>

  <div class="app-container" role="main">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 class="page-title" id="auth-title">Welcome Back</h1>
    <p class="lead" id="auth-description">Log in to access and manage your academic notes.</p>

    <!-- LOGIN FORM -->
    <form id="login-form" class="auth-form fade-in" autocomplete="off" novalidate>
      <div class="field">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" placeholder="you@example.com" required inputmode="email">
        <span class="error-inline" id="login-email-err"></span>
      </div>
      <div class="field">
        <label for="login-password">Password</label>
        <input id="login-password" type="password" placeholder="••••••••" required minlength="8">
        <span class="error-inline" id="login-pass-err"></span>
      </div>
      <div class="button-row" style="margin-top:10px;">
        <button type="submit" class="btn" id="login-btn">Log In</button>
      </div>
      <a class="switch-link" href="auth.html?mode=signup" id="to-signup">Don't have an account? Create one</a>
    </form>

    <!-- SIGNUP FORM -->
    <form id="signup-form" class="auth-form hidden" autocomplete="off" novalidate>
      <div class="field">
        <label for="signup-display-name">Display Name (Optional)</label>
        <input id="signup-display-name" type="text" placeholder="Your name">
        <span class="error-inline" id="signup-name-err"></span>
      </div>
      <div class="field">
        <label for="signup-email">Email</label>
        <input id="signup-email" type="email" placeholder="you@example.com" required inputmode="email">
        <span class="error-inline" id="signup-email-err"></span>
      </div>
      <div class="form-grid-two">
        <div class="field">
          <label for="signup-password">Password (min 8)</label>
            <input id="signup-password" type="password" minlength="8" required placeholder="••••••••">
            <span class="error-inline" id="signup-pass-err"></span>
        </div>
        <div class="field">
          <label for="signup-password-confirm">Confirm</label>
          <input id="signup-password-confirm" type="password" minlength="8" required placeholder="••••••••">
          <span class="error-inline" id="signup-passconf-err"></span>
        </div>
      </div>
      <div class="button-row" style="margin-top:6px;">
        <button type="submit" class="btn" id="signup-btn">Sign Up</button>
        <button type="button" class="btn secondary" id="cancel-signup">Cancel</button>
      </div>
      <a class="switch-link" href="auth.html?mode=login" id="to-login">Already have an account? Log in</a>
    </form>
  </div>

  <script type="module">
    import { signupWithEmail, loginWithEmail, onAuth } from './firebase-init.js';

    /* Theme */
    function applyTheme(dark){
      document.body.classList.toggle('dark',dark);
      document.body.classList.toggle('light',!dark);
      localStorage.setItem('theme',dark?'dark':'light');
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored==='dark') applyTheme(true);
      else if(stored==='light') applyTheme(false);
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
    })();
    const toggleBtn=document.getElementById('theme-toggle');
    let spin=0;
    toggleBtn.addEventListener('click', ()=>{
      const goDark=!document.body.classList.contains('dark');
      applyTheme(goDark);
      spin+=360; toggleBtn.style.transform=`rotate(${spin}deg)`; setTimeout(()=>toggleBtn.style.transform='',650);
    });

    /* Mode switching */
    const params = new URLSearchParams(location.search);
    let mode = params.get('mode')==='signup'?'signup':'login';
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const authTitle = document.getElementById('auth-title');
    const authDescription = document.getElementById('auth-description');

    function setMode(m){
      mode=m;
      if(m==='signup'){
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        authTitle.textContent='Create Your Account';
        authDescription.textContent='Sign up to start uploading and sharing your notes.';
      } else {
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        authTitle.textContent='Welcome Back';
        authDescription.textContent='Log in to access and manage your academic notes.';
      }
    }
    setMode(mode);

    /* Helpers */
    function showErr(id,msg){
      const el=document.getElementById(id);
      if(!el) return;
      el.textContent=msg||'';
      el.style.display=msg?'block':'none';
    }

    /* LOGIN */
    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-password').value;
      showErr('login-email-err',''); showErr('login-pass-err','');
      if(!email){ showErr('login-email-err','Email required'); return; }
      if(!pass){ showErr('login-pass-err','Password required'); return; }
      const btn = document.getElementById('login-btn');
      btn.disabled=true; btn.textContent='Logging in...';
      try {
        await loginWithEmail(email, pass);
        location.href='home.html';
      } catch(err){
        alert(err.message || 'Login failed');
      } finally {
        btn.disabled=false; btn.textContent='Log In';
      }
    });

    /* SIGNUP */
    signupForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const name = document.getElementById('signup-display-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const pass = document.getElementById('signup-password').value;
      const pass2 = document.getElementById('signup-password-confirm').value;
      showErr('signup-email-err',''); showErr('signup-pass-err',''); showErr('signup-passconf-err','');
      if(!email) { showErr('signup-email-err','Email required'); return; }
      if(pass.length<8) { showErr('signup-pass-err','Minimum 8 characters'); return; }
      if(pass!==pass2) { showErr('signup-passconf-err','Passwords do not match'); return; }
      const btn = document.getElementById('signup-btn');
      btn.disabled=true; btn.textContent='Creating...';
      try {
        await signupWithEmail(email, pass, name || undefined);
        alert('Account created. You can now log in.');
        setMode('login');
        history.replaceState({},'', 'auth.html?mode=login');
      } catch(err){
        alert(err.message || 'Signup failed');
      } finally {
        btn.disabled=false; btn.textContent='Sign Up';
      }
    });

    document.getElementById('cancel-signup').addEventListener('click', ()=>{
      setMode('login');
      history.replaceState({},'', 'auth.html?mode=login');
    });

    onAuth(user=>{
      if(user && mode==='login'){
        // Already logged in; optionally redirect
        // location.href='home.html';
      }
    });
  </script>
</body>
</html>