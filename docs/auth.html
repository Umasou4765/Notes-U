<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Auth - Notes-U</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="color-scheme" content="light dark">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/app.css">
</head>
<body class="auth-page light">
  <!-- Theme Toggle (same markup / behavior style as index) -->
  <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme">
    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8">
      <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
    </svg>
    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/>
      <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34 4.93 4.93m12.02 0-1.41 1.41M6.34 17.66l-1.41 1.41"/>
    </svg>
  </button>

  <main class="auth-container" aria-labelledby="authHeading">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 id="authHeading" class="auth-title">Welcome Back</h1>
    <p id="authLead" class="auth-lead">Log in to access your academic notes.</p>

    <div id="globalStatus" class="auth-status" aria-live="polite"></div>

    <div class="auth-forms" id="formsShell">
      <!-- LOGIN -->
      <form id="loginForm" class="auth-form active" novalidate autocomplete="off">
        <div class="field">
          <label for="login-email">Email</label>
          <div class="input-wrap">
            <input id="login-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@example.com" maxlength="120">
          </div>
          <div class="errors" id="login-email-error" aria-live="polite"></div>
        </div>

        <div class="field last-field">
          <label for="login-password">Password</label>
          <div class="input-wrap">
            <input id="login-password" type="password" required minlength="8" autocomplete="current-password" placeholder="••••••••">
            <button type="button" class="toggle-pass" data-target="login-password" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="login-password-error" aria-live="polite"></div>
          <a href="#" id="forgotLink" class="forgot-link">Forgot password?</a>
        </div>

        <button type="submit" class="auth-btn" id="loginBtn"><span class="btn-text">Log In</span></button>
      </form>

      <!-- SIGNUP (compact: no display name, meter removed to keep box short) -->
      <form id="signupForm" class="auth-form" novalidate autocomplete="off" hidden>
        <div class="field">
          <label for="signup-email">Email</label>
          <div class="input-wrap">
            <input id="signup-email" type="email" inputmode="email" autocomplete="email" required placeholder="you@university.edu" maxlength="120">
          </div>
          <div class="errors" id="signup-email-error" aria-live="polite"></div>
        </div>

        <div class="field">
          <label for="signup-password">Password</label>
          <div class="input-wrap">
            <input id="signup-password" type="password" required minlength="8" autocomplete="new-password" placeholder="At least 8 characters">
            <button type="button" class="toggle-pass" data-target="signup-password" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="signup-password-error" aria-live="polite"></div>
        </div>

        <div class="field last-field">
          <label for="signup-confirm">Confirm Password</label>
          <div class="input-wrap">
            <input id="signup-confirm" type="password" required autocomplete="new-password" placeholder="Re-enter password">
            <button type="button" class="toggle-pass" data-target="signup-confirm" aria-label="Toggle password visibility">Show</button>
          </div>
          <div class="errors" id="signup-confirm-error" aria-live="polite"></div>
        </div>

        <button type="submit" class="auth-btn" id="signupBtn"><span class="btn-text">Create Account</span></button>
      </form>
    </div>

    <div class="switch-links" aria-live="polite">
      <a href="auth.html?signup" id="linkToSignup" style="display:block;">Don't have an account? Sign up</a>
      <a href="auth.html?login" id="linkToLogin" style="display:none;">Already have an account? Log in</a>
    </div>

    <!-- Forgot password (hidden, does not enlarge initial height) -->
    <section id="forgotPanel" class="forgot-panel" aria-labelledby="forgotHeading" hidden>
      <h2 id="forgotHeading">Reset Password</h2>
      <form id="forgotForm" novalidate>
        <div class="field">
          <label for="forgot-email">Email</label>
          <div class="input-wrap">
            <input id="forgot-email" type="email" required placeholder="you@example.com">
          </div>
          <div class="errors" id="forgot-email-error" aria-live="polite"></div>
        </div>
        <button type="submit" class="auth-btn small" id="forgotBtn"><span class="btn-text">Send Link</span></button>
        <div id="forgotStatus" class="auth-status small" aria-live="polite"></div>
        <div class="forgot-back-wrap">
          <a href="#" id="closeForgot" class="forgot-link">Back</a>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { signupWithEmail, loginWithEmail, friendlyError, auth } from './firebase-init.js';
    import { onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* Theme (reuse index logic) */
    function applyTheme(dark){
      document.body.classList.toggle('dark', dark);
      document.body.classList.toggle('light', !dark);
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored === 'dark') applyTheme(true);
      else if(stored === 'light') applyTheme(false);
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches);
      });
    })();
    document.getElementById('theme-toggle').addEventListener('click', ()=>{
      applyTheme(!document.body.classList.contains('dark'));
    }, { passive:true });

    /* Elements */
    const loginForm   = document.getElementById('loginForm');
    const signupForm  = document.getElementById('signupForm');
    const linkToSignup= document.getElementById('linkToSignup');
    const linkToLogin = document.getElementById('linkToLogin');
    const authHeading = document.getElementById('authHeading');
    const authLead    = document.getElementById('authLead');
    const globalStatus= document.getElementById('globalStatus');
    const loginBtn    = document.getElementById('loginBtn');
    const signupBtn   = document.getElementById('signupBtn');
    const forgotPanel = document.getElementById('forgotPanel');
    const forgotLink  = document.getElementById('forgotLink');
    const closeForgot = document.getElementById('closeForgot');
    const forgotForm  = document.getElementById('forgotForm');
    const forgotBtn   = document.getElementById('forgotBtn');
    const forgotStatus= document.getElementById('forgotStatus');

    function detectMode(){
      const qs = location.search;
      if(/\?signup\b/i.test(qs)) return 'signup';
      if(/\?login\b/i.test(qs)) return 'login';
      const legacy = new URLSearchParams(qs).get('mode');
      return legacy === 'signup' ? 'signup' : 'login';
    }
    let mode = detectMode();

    function setStatus(msg='', kind=''){
      globalStatus.textContent = msg;
      globalStatus.className = 'auth-status' + (kind? ' '+kind:'');
    }

    function showErr(id,msg){
      const el = document.getElementById(id);
      if(el){
        el.textContent = msg || '';
        el.classList.toggle('show', !!msg);
      }
    }
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    function applyMode(m){
      mode = m;
      const isSignup = m === 'signup';
      signupForm.hidden = !isSignup;
      loginForm.hidden  = isSignup;
      signupForm.classList.toggle('active', isSignup);
      loginForm.classList.toggle('active', !isSignup);
      linkToSignup.style.display = isSignup ? 'none':'block';
      linkToLogin.style.display  = isSignup ? 'block':'none';
      authHeading.textContent = isSignup ? 'Create Account' : 'Welcome Back';
      authLead.textContent    = isSignup ? 'Sign up to start sharing your notes.' : 'Log in to access your academic notes.';
      history.replaceState({},'', 'auth.html?'+m);
      setStatus();
    }
    applyMode(mode);

    linkToSignup.addEventListener('click', e=>{ e.preventDefault(); applyMode('signup'); });
    linkToLogin.addEventListener('click', e=>{ e.preventDefault(); applyMode('login');  });

    /* Password visibility */
    document.addEventListener('click', e=>{
      const btn = e.target.closest('.toggle-pass');
      if(!btn) return;
      const target = document.getElementById(btn.dataset.target);
      if(!target) return;
      if(target.type === 'password'){
        target.type='text'; btn.textContent='Hide';
      } else {
        target.type='password'; btn.textContent='Show';
      }
      target.focus({ preventScroll:true });
    });

    /* Login */
    loginForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setStatus();
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      let ok = true;
      if(!validEmail(email)){ showErr('login-email-error','Valid email required.'); ok=false; } else showErr('login-email-error','');
      if(!pass){ showErr('login-password-error','Password required.'); ok=false; } else showErr('login-password-error','');
      if(!ok) return;
      loginBtn.disabled = true;
      loginBtn.querySelector('.btn-text').textContent='Logging In...';
      try {
        await loginWithEmail(email, pass);
        setStatus('Login successful. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 400);
      } catch(err){
        setStatus(friendlyError(err),'err');
        loginBtn.disabled=false;
        loginBtn.querySelector('.btn-text').textContent='Log In';
      }
    });

    /* Signup */
    signupForm.addEventListener('submit', async e=>{
      e.preventDefault();
      setStatus();
      const email = document.getElementById('signup-email').value.trim();
      const pass  = document.getElementById('signup-password').value;
      const conf  = document.getElementById('signup-confirm').value;
      let ok = true;
      if(!validEmail(email)){ showErr('signup-email-error','Enter a valid email.'); ok=false; } else showErr('signup-email-error','');
      if(pass.length < 8){ showErr('signup-password-error','Min 8 characters.'); ok=false; } else showErr('signup-password-error','');
      if(conf !== pass){ showErr('signup-confirm-error','Passwords do not match.'); ok=false; } else showErr('signup-confirm-error','');
      if(!ok) return;
      signupBtn.disabled=true;
      signupBtn.querySelector('.btn-text').textContent='Creating...';
      try {
        await signupWithEmail(email, pass, null);
        setStatus('Account created! Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 500);
      } catch(err){
        setStatus(friendlyError(err),'err');
        signupBtn.disabled=false;
        signupBtn.querySelector('.btn-text').textContent='Create Account';
      }
    });

    /* Forgot password */
    forgotLink.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden=false;
      forgotPanel.classList.add('active');
      document.getElementById('forgot-email').focus();
    });
    closeForgot.addEventListener('click', e=>{
      e.preventDefault();
      forgotPanel.hidden=true;
      forgotPanel.classList.remove('active');
      forgotStatus.textContent='';
    });
    forgotForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const email = document.getElementById('forgot-email').value.trim();
      if(!validEmail(email)){
        document.getElementById('forgot-email-error').textContent='Valid email required.';
        return;
      } else {
        document.getElementById('forgot-email-error').textContent='';
      }
      forgotBtn.disabled=true;
      forgotBtn.querySelector('.btn-text').textContent='Sending...';
      forgotStatus.textContent='';
      forgotStatus.className='auth-status';
      try {
        await sendPasswordResetEmail(auth, email);
        forgotStatus.textContent='Reset link sent (check inbox / spam).';
        forgotStatus.classList.add('ok');
      } catch(err){
        forgotStatus.textContent=friendlyError(err);
        forgotStatus.classList.add('err');
      } finally {
        forgotBtn.disabled=false;
        forgotBtn.querySelector('.btn-text').textContent='Send Link';
      }
    });

    /* Auto redirect if already signed in */
    onAuthStateChanged(auth, user=>{
      if(user){
        setStatus('Already signed in. Redirecting...','ok');
        setTimeout(()=> location.href='home.html', 350);
      }
    });

  </script>
</body>
</html>
