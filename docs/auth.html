<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth - Notes-U</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light:#f8f8f8; --text-light:#333; --text2-light:#666;
      --bg-dark:#121212; --text-dark:#eee; --text2-dark:#aaa;
      --card-light:#fff; --card-dark:#1d1d1d;
      --border-light:rgba(0,0,0,0.12); --border-dark:rgba(255,255,255,0.12);
      --accent:#0d6efd; --accent-hover:#0b5ed7;
      --error:#d33;
      --focus-ring:0 0 0 3px rgba(13,110,253,.35);
    }
    * { box-sizing:border-box; }
    body {
      font-family:'Inter',system-ui,Arial,sans-serif;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:var(--bg-light); color:var(--text-light); transition:background .3s,color .3s;
      -webkit-font-smoothing:antialiased;
      padding:20px;
    }
    body.dark { background:var(--bg-dark); color:var(--text-dark); }
    .container {
      width:100%; max-width:460px; background:var(--card-light); padding:44px 40px 40px;
      border-radius:20px; box-shadow:0 10px 34px -6px rgba(0,0,0,.12);
      position:relative;
    }
    body.dark .container { background:var(--card-dark); box-shadow:0 10px 34px -6px rgba(0,0,0,.55); }
    .logo {
      font-size:2.6rem; font-weight:700; display:flex; align-items:center; justify-content:center;
      width:78px; height:78px; margin:0 auto 20px; border:2px solid currentColor; border-radius:16px;
      user-select:none;
    }
    h1 { font-size:1.9rem; margin:0 0 8px; text-align:center; }
    p.lead { margin:0 0 28px; font-size:.95rem; color:var(--text2-light); text-align:center; }
    body.dark p.lead { color:var(--text2-dark); }

   
    .forms-shell {
      position:relative;
      min-height:390px; 
      transition:min-height .25s;
    }
    .auth-form {
      display:none;
      animation:fade .35s ease;
    }
    .auth-form.active { display:block; }
    @keyframes fade {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:none; }
    }

    label { display:block; font-weight:600; margin:0 0 6px; font-size:.82rem; letter-spacing:.3px; }
    .field { margin-bottom:18px; }
    input {
      width:100%; padding:14px 15px; font-size:1rem;
      border:1px solid var(--border-light); border-radius:10px;
      background:#fff; color:inherit; line-height:1.25;
      transition:border-color .25s, background .25s, box-shadow .25s;
    }
    body.dark input { background:#222; border-color:var(--border-dark); color:var(--text-dark); }
    input:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow:var(--focus-ring);
    }
    .submit-button {
      width:100%; padding:15px 20px; margin-top:4px;
      border:none; border-radius:10px; font-size:1rem; font-weight:600;
      cursor:pointer; background:var(--accent); color:#fff; transition:background .2s, transform .25s;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .submit-button:hover { background:var(--accent-hover); }
    .submit-button:active { transform:scale(.97); }
    .submit-button:disabled { opacity:.6; cursor:not-allowed; transform:none; }

    .switch-links {
      margin-top:20px; text-align:center; font-size:.85rem; display:flex; flex-direction:column; gap:4px;
    }
    .switch-links a {
      color:var(--accent); text-decoration:none; font-weight:500;
    }
    .switch-links a:hover { text-decoration:underline; }

    .error-inline { color:var(--error); font-size:.72rem; margin-top:6px; display:none; font-weight:500; line-height:1.2; }

    /* Helper note */
    .helper-note {
      font-size:.65rem; margin-top:6px; color:var(--text2-light); letter-spacing:.3px;
    }
    body.dark .helper-note { color:var(--text2-dark); }

    /* Accessibility focus for switch links */
    a:focus-visible { outline:2px solid var(--accent); outline-offset:2px; border-radius:4px; }

    @media (max-width:560px){
      .container { padding:40px 28px 36px; border-radius:18px; }
      .forms-shell { min-height:430px; }
      h1 { font-size:1.7rem; }
      .logo { width:70px; height:70px; font-size:2.2rem; margin-bottom:16px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="auth-title">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 id="auth-title"></h1>
    <p class="lead" id="auth-description"></p>

    <div class="forms-shell" id="formsShell">
      <!-- LOGIN -->
      <div id="login-form" class="auth-form" aria-labelledby="auth-title">
        <form autocomplete="off" novalidate>
          <div class="field">
            <label for="login-username">Username</label>
            <input id="login-username" type="text" required placeholder="Enter your username" inputmode="text" maxlength="32">
            <span class="error-inline" id="login-user-err"></span>
          </div>

            <div class="field" style="margin-bottom:10px;">
            <label for="login-access-code">Access Code</label>
            <input id="login-access-code" type="password" required placeholder="Enter your access code" minlength="8" autocomplete="current-password">
            <span class="error-inline" id="login-pass-err"></span>
            <div class="helper-note">Minimum 8 characters.</div>
          </div>

          <button type="submit" class="submit-button" id="login-btn">Log In</button>
        </form>
      </div>

      <!-- SIGNUP -->
      <div id="signup-form" class="auth-form" aria-labelledby="auth-title">
        <form autocomplete="off" novalidate>
          <div class="field">
            <label for="signup-username">Username</label>
            <input id="signup-username" type="text" required placeholder="Choose a username (a-z, 0-9, . _ -)" pattern="^[a-z0-9._-]{3,30}$" maxlength="30">
            <span class="error-inline" id="signup-user-err"></span>
          </div>

          <div class="field">
            <label for="signup-access-code">Create Access Code</label>
            <input id="signup-access-code" type="password" required placeholder="Min 8 characters" minlength="8" autocomplete="new-password">
            <span class="error-inline" id="signup-pass-err"></span>
          </div>

          <div class="field" style="margin-bottom:10px;">
            <label for="signup-confirm-access-code">Confirm Access Code</label>
            <input id="signup-confirm-access-code" type="password" required placeholder="Re-enter access code" minlength="8" autocomplete="new-password">
            <span class="error-inline" id="signup-confirm-err"></span>
          </div>

          <button type="submit" class="submit-button" id="signup-btn">Sign Up</button>
        </form>
      </div>
    </div>

    <div class="switch-links" aria-live="polite">
      <a href="auth.html?login" id="toLoginLink" class="switch-link" style="display:none;">Already have an account? Log In instead</a>
      <a href="auth.html?signup" id="toSignupLink" class="switch-link" style="display:none;">Don't have an account? Create one now</a>
    </div>
  </div>

  <script type="module">
    import { signupWithUsername, loginWithUsername, onAuth } from './firebase-init.js';

    /* ---------------- Theme ---------------- */
    function setTheme(isDark){
      document.body.classList.toggle('dark', !!isDark);
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored==='dark') setTheme(true);
      else if(stored==='light') setTheme(false);
      else setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) setTheme(e.matches);
      });
    })();

    /* ---------------- Mode Parsing ----------------*/
      
    function detectMode(){
      const qs = window.location.search;
      if(/\?signup\b/i.test(qs)) return 'signup';
      if(/\?login\b/i.test(qs)) return 'login';
      const params = new URLSearchParams(qs);
      const legacy = params.get('mode');
      return legacy === 'signup' ? 'signup' : 'login';
    }

    const loginFormWrap  = document.getElementById('login-form');
    const signupFormWrap = document.getElementById('signup-form');
    const authTitle = document.getElementById('auth-title');
    const authDesc  = document.getElementById('auth-description');
    const toLoginLink  = document.getElementById('toLoginLink');
    const toSignupLink = document.getElementById('toSignupLink');
    const formsShell   = document.getElementById('formsShell');

    function showErr(id,msg){
      const el = document.getElementById(id);
      if(el){
        el.textContent = msg || '';
        el.style.display = msg ? 'block':'none';
      }
    }

    function applyMode(mode){
      if(mode==='signup'){
        signupFormWrap.classList.add('active');
        loginFormWrap.classList.remove('active');
        authTitle.textContent='Create Your Account';
        authDesc.textContent='Sign up to start uploading and managing your notes.';
        toLoginLink.style.display='block';
        toSignupLink.style.display='none';
      } else {
        loginFormWrap.classList.add('active');
        signupFormWrap.classList.remove('active');
        authTitle.textContent='Welcome Back';
        authDesc.textContent='Log in to access and manage your academic notes.';
        toLoginLink.style.display='none';
        toSignupLink.style.display='block';
      }
     
      requestAnimationFrame(()=>{
        const activeHeight = document.querySelector('.auth-form.active').offsetHeight;
        const otherHeight  = document.querySelector('.auth-form:not(.active)').offsetHeight;
        const target = Math.max(activeHeight, otherHeight);
        formsShell.style.minHeight = target + 'px';
      });
    }

    let mode = detectMode();
    applyMode(mode);

    toLoginLink.addEventListener('click', e=>{
      e.preventDefault();
      mode='login';
      history.replaceState({},'', 'auth.html?login');
      applyMode(mode);
    });
    toSignupLink.addEventListener('click', e=>{
      e.preventDefault();
      mode='signup';
      history.replaceState({},'', 'auth.html?signup');
      applyMode(mode);
    });

    /* ---------------- Login Submit ---------------- */
    loginFormWrap.querySelector('form').addEventListener('submit', async e=>{
      e.preventDefault();
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-access-code').value;

      showErr('login-user-err','');
      showErr('login-pass-err','');

      if(!u){ showErr('login-user-err','Username required'); return; }
      if(!p){ showErr('login-pass-err','Access code required'); return; }

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Logging in...';
      try {
        await loginWithUsername(u,p);
        location.href = 'home.html';
      } catch(err){
        alert(err.message || 'Login failed');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Log In';
      }
    });

    /* ---------------- Signup Submit ---------------- */
    signupFormWrap.querySelector('form').addEventListener('submit', async e=>{
      e.preventDefault();
      const u = document.getElementById('signup-username').value.trim();
      const p = document.getElementById('signup-access-code').value;
      const c = document.getElementById('signup-confirm-access-code').value;

      showErr('signup-user-err','');
      showErr('signup-pass-err','');
      showErr('signup-confirm-err','');

      if(!u){ showErr('signup-user-err','Username required'); return; }
      if(!/^[a-z0-9._-]{3,30}$/.test(u)){
        showErr('signup-user-err','Invalid format (3-30 chars: a-z, 0-9, . _ -)');
        return;
      }
      if(p.length < 8){ showErr('signup-pass-err','Minimum 8 characters'); return; }
      if(p !== c){ showErr('signup-confirm-err','Codes do not match'); return; }

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      try {
        await signupWithUsername(u,p);
        alert('Account created. Please log in.');
        mode = 'login';
        history.replaceState({},'', 'auth.html?login');
        applyMode(mode);
      } catch(err){
        alert(err.message || 'Signup failed');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign Up';
      }
    });

    /* ---------------- Already Logged In (Optional Redirect) ---------------- */
    onAuth(user=>{
      if(user && mode==='login'){
        
      }
    });
    
    window.addEventListener('resize', ()=>{
      if(document.querySelector('.auth-form.active')){
        formsShell.style.minHeight = document.querySelector('.auth-form.active').offsetHeight + 'px';
      }
    });
  </script>
</body>
</html>
