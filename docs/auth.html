<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Authenticate - Notes-U</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/variables.css">
<link rel="stylesheet" href="../css/base.css">
<link rel="stylesheet" href="../css/app.css">
<style>
.auth-shell {
  max-width: 480px;
  margin: 60px auto 90px;
  padding: var(--space-8) var(--space-8) var(--space-6);
  border:1px solid var(--color-border);
  border-radius: var(--radius-lg);
  background: linear-gradient(145deg,var(--color-surface),var(--color-surface-alt) 140%);
  box-shadow: var(--shadow);
  display:flex;
  flex-direction:column;
  position:relative;
  overflow:hidden;
  animation: fadeIn .6s var(--ease);
}

.auth-shell::before {
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 25% 18%, rgba(255,255,255,0.45), transparent 60%),
    radial-gradient(circle at 78% 82%, rgba(255,255,255,0.30), transparent 68%);
  opacity:.4;
  pointer-events:none;
  mix-blend-mode:overlay;
}
body.dark .auth-shell::before {
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,0.08), transparent 60%),
    radial-gradient(circle at 70% 78%, rgba(255,255,255,0.05), transparent 70%);
  opacity:.75;
}

.auth-logo {
  font-size: 2.6rem;
  font-weight:700;
  width:86px;
  height:86px;
  border:2.5px solid currentColor;
  border-radius:26px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 26px;
  background: linear-gradient(140deg, rgba(255,255,255,0.6), rgba(255,255,255,0.12));
  transition: transform var(--transition), background var(--transition);
}
body.dark .auth-logo {
  background: linear-gradient(140deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
}
.auth-logo:hover { transform: rotate(-3deg) scale(1.05); }

.auth-title {
  margin:0 0 10px;
  font-size:1.95rem;
  letter-spacing:-.5px;
  text-align:center;
  font-weight:700;
}
.auth-lead {
  margin:0 0 24px;
  font-size:.95rem;
  line-height:1.5;
  text-align:center;
  color: var(--color-text-soft);
}

.switch-links {
  margin-top: 20px;
  text-align:center;
  font-size:.72rem;
  letter-spacing:.35px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.switch-links a { font-weight:600; }

.global-status {
  font-size:.7rem;
  letter-spacing:.45px;
  text-align:center;
  min-height:1em;
  margin:0 0 14px;
  color: var(--color-text-soft);
}
.global-status.ok { color: var(--color-success); }
.global-status.err { color: var(--color-danger); }

.toggle-pass {
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  border:none;
  background:transparent;
  font-size:.6rem;
  letter-spacing:.55px;
  font-weight:600;
  cursor:pointer;
  color: var(--color-accent);
  padding:4px 6px;
  border-radius: var(--radius-xs);
  text-transform:uppercase;
}
.toggle-pass:hover { text-decoration:underline; }

.forgot-link {
  font-size:.62rem;
  font-weight:600;
  text-decoration:none;
  color: var(--color-accent);
  margin-top:6px;
}
.forgot-link:hover { text-decoration:underline; }

.forgot-panel {
  margin-top: 18px;
  background: var(--color-surface-alt);
  border:1px solid var(--color-border);
  border-radius: var(--radius);
  padding: var(--space-5) var(--space-5) var(--space-4);
  display:none;
  animation: fadeIn .4s var(--ease);
}
.forgot-panel.active { display:block; }

.status-line {
  font-size:.65rem;
  letter-spacing:.4px;
  margin-top:10px;
  min-height:1em;
}
.status-line.ok { color: var(--color-success); }
.status-line.err { color: var(--color-danger); }

.theme-toggle {
  position:fixed;
  top:18px;
  right:18px;
  width:54px;
  height:54px;
  border-radius:18px;
  border:1px solid var(--color-border);
  background: linear-gradient(145deg,var(--color-surface),var(--color-surface-alt) 130%);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow: var(--shadow-sm);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition);
}
.theme-toggle:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
.theme-toggle:active { transform: translateY(-1px) scale(.95); }
.theme-toggle svg {
  width:30px; height:30px;
  stroke-linecap:round;
  stroke-linejoin:round;
  transition: opacity var(--transition), transform var(--transition);
}
.theme-toggle .sun { opacity:0; transform: rotate(-45deg) scale(.6); }
body.dark .theme-toggle .sun { opacity:1; transform: rotate(0deg) scale(1); }
body.dark .theme-toggle .moon { opacity:0; transform: rotate(55deg) scale(.55); }

@media (max-width:600px){
  .auth-shell { margin: 36px 16px 70px; padding: var(--space-6) var(--space-6) var(--space-5); }
  .auth-title { font-size:1.75rem; }
}
</style>
</head>
<body class="light theming-prep">
<button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
  <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9">
    <path d="M21 12.8A9 9 0 0112.8 3a7 7 0 100 18A9 9 0 0021 12.8z"/>
  </svg>
  <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9">
    <circle cx="12" cy="12" r="5"/>
    <path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.07l-1.41-1.41M6.34 6.34L4.93 4.93m12.02 0l-1.41 1.41M6.34 17.66l-1.41 1.41"/>
  </svg>
</button>

<main class="auth-shell" role="main" aria-labelledby="authHeading">
  <div class="auth-logo" aria-label="Notes-U Logo">U</div>
  <h1 class="auth-title" id="authHeading">Welcome Back</h1>
  <p class="auth-lead" id="authLead">Log in to access and manage your academic notes.</p>
  <div id="globalStatus" class="global-status" aria-live="polite"></div>

  <!-- LOGIN -->
  <form id="loginForm" class="auth-form" novalidate autocomplete="off" aria-describedby="globalStatus">
    <div class="field">
      <label for="login-email">Email</label>
      <div class="input-wrap" style="position:relative;">
        <input id="login-email" type="email" required autocomplete="email" placeholder="you@example.com" />
      </div>
      <div class="form-error" id="login-email-error"></div>
    </div>
    <div class="field" style="margin-bottom:10px;">
      <label for="login-password">Password</label>
      <div class="input-wrap" style="position:relative;">
        <input id="login-password" type="password" required autocomplete="current-password" placeholder="••••••••" />
        <button type="button" class="toggle-pass" data-target="login-password">Show</button>
      </div>
      <div class="form-error" id="login-password-error"></div>
      <a class="forgot-link" href="#" id="forgotLink">Forgot password?</a>
    </div>
    <button type="submit" class="btn" id="loginBtn"><span class="btn-text">Log In</span></button>
  </form>

  <!-- SIGNUP -->
  <form id="signupForm" class="auth-form" novalidate autocomplete="off" hidden>
    <div class="field">
      <label for="signup-email">Email</label>
      <div class="input-wrap" style="position:relative;">
        <input id="signup-email" type="email" required autocomplete="email" placeholder="you@university.edu" />
      </div>
      <div class="form-error" id="signup-email-error"></div>
    </div>
    <div class="field">
      <label for="signup-password">Password</label>
      <div class="input-wrap" style="position:relative;">
        <input id="signup-password" type="password" required autocomplete="new-password" minlength="8" placeholder="At least 8 characters" />
        <button type="button" class="toggle-pass" data-target="signup-password">Show</button>
      </div>
      <div class="form-error" id="signup-password-error"></div>
    </div>
    <div class="field" style="margin-bottom:10px;">
      <label for="signup-confirm">Confirm Password</label>
      <div class="input-wrap" style="position:relative;">
        <input id="signup-confirm" type="password" required autocomplete="new-password" placeholder="Re-enter password" />
        <button type="button" class="toggle-pass" data-target="signup-confirm">Show</button>
      </div>
      <div class="form-error" id="signup-confirm-error"></div>
    </div>
    <button type="submit" class="btn" id="signupBtn"><span class="btn-text">Create Account</span></button>
  </form>

  <!-- Forgot password -->
  <section id="forgotPanel" class="forgot-panel" aria-labelledby="forgotHeading" hidden>
    <h2 id="forgotHeading" style="margin:0 0 8px;font-size:1rem;">Reset Password</h2>
    <p style="margin:0 0 14px;font-size:.72rem;line-height:1.4;color:var(--color-text-soft);">
      Enter your email and we will send a reset link if the account exists.
    </p>
    <form id="forgotForm" novalidate>
      <div class="field" style="margin-bottom:6px;">
        <label for="forgot-email">Email</label>
        <div style="position:relative;">
          <input id="forgot-email" type="email" required placeholder="you@example.com">
        </div>
        <div class="form-error" id="forgot-email-error"></div>
      </div>
      <button type="submit" class="btn" id="forgotBtn">
        <span class="btn-text">Send Reset Link</span>
      </button>
      <div class="status-line" id="forgotStatus" aria-live="polite"></div>
      <div style="margin-top:10px;text-align:center;">
        <a href="#" id="closeForgot" class="forgot-link">Back to login</a>
      </div>
    </form>
  </section>

  <div class="switch-links" aria-live="polite">
    <a href="auth.html?signup" id="linkToSignup">Don't have an account? Create one</a>
    <a href="auth.html?login" id="linkToLogin" style="display:none;">Already have an account? Log in</a>
  </div>
</main>

<script type="module">
import { signupWithEmail, loginWithEmail, friendlyError, auth } from './firebase-init.js';
import { onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

function applyTheme(theme){
  document.body.classList.remove('light','dark');
  document.body.classList.add(theme);
  localStorage.setItem('theme', theme);
}
function initTheme(){
  const stored = localStorage.getItem('theme');
  applyTheme(stored || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
  document.body.classList.remove('theming-prep');
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
    if(!localStorage.getItem('theme')) applyTheme(e.matches?'dark':'light');
  });
}
initTheme();

document.getElementById('themeToggle').addEventListener('click', ()=>{
  applyTheme(document.body.classList.contains('dark') ? 'light':'dark');
});

/* Elements */
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const forgotPanel = document.getElementById('forgotPanel');
const forgotForm = document.getElementById('forgotForm');
const linkToSignup = document.getElementById('linkToSignup');
const linkToLogin = document.getElementById('linkToLogin');
const forgotLink = document.getElementById('forgotLink');
const closeForgot = document.getElementById('closeForgot');
const authHeading = document.getElementById('authHeading');
const authLead = document.getElementById('authLead');
const globalStatus = document.getElementById('globalStatus');
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const forgotBtn = document.getElementById('forgotBtn');
const forgotStatus = document.getElementById('forgotStatus');

function detectMode(){
  const qs = window.location.search;
  if(/\?signup\b/i.test(qs)) return 'signup';
  if(/\?login\b/i.test(qs)) return 'login';
  const p = new URLSearchParams(qs).get('mode');
  return p === 'signup' ? 'signup' : 'login';
}
let mode = detectMode();

function setGlobalStatus(msg='', kind=''){
  globalStatus.textContent = msg;
  globalStatus.className = 'global-status' + (kind ? ' ' + kind : '');
}
function showErr(id,msg){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = msg || '';
}
function applyMode(m){
  mode = m;
  const isSignup = m==='signup';
  loginForm.hidden = isSignup;
  signupForm.hidden = !isSignup;
  loginForm.classList.toggle('fade-in', !isSignup);
  signupForm.classList.toggle('fade-in', isSignup);
  linkToSignup.style.display = isSignup ? 'none':'block';
  linkToLogin.style.display = isSignup ? 'block':'none';
  forgotPanel.hidden = true;
  forgotPanel.classList.remove('active');
  if(isSignup){
    authHeading.textContent = 'Create Your Account';
    authLead.textContent = 'Sign up with your email to begin sharing and managing notes.';
  } else {
    authHeading.textContent = 'Welcome Back';
    authLead.textContent = 'Log in to access and manage your academic notes.';
  }
  setGlobalStatus();
}
applyMode(mode);
linkToSignup.addEventListener('click', e=>{e.preventDefault(); applyMode('signup');});
linkToLogin.addEventListener('click', e=>{e.preventDefault(); applyMode('login');});

document.addEventListener('click', e=>{
  const btn = e.target.closest('.toggle-pass');
  if(!btn) return;
  const input = document.getElementById(btn.dataset.target);
  if(!input) return;
  if(input.type === 'password'){ input.type='text'; btn.textContent='Hide'; }
  else { input.type='password'; btn.textContent='Show'; }
  input.focus({preventScroll:true});
});

function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

/* Login */
loginForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const pw = document.getElementById('login-password').value;
  let ok = true;
  if(!validEmail(email)){ showErr('login-email-error','Valid email required.'); ok=false; } else showErr('login-email-error','');
  if(!pw){ showErr('login-password-error','Password required.'); ok=false; } else showErr('login-password-error','');
  if(!ok) return;
  loginBtn.disabled = true;
  loginBtn.querySelector('.btn-text').textContent = 'Logging In...';
  setGlobalStatus();
  try {
    await loginWithEmail(email,pw);
    setGlobalStatus('Login successful. Redirecting...','ok');
    setTimeout(()=> location.replace('home.html'), 450);
  } catch(err){
    setGlobalStatus(friendlyError(err),'err');
    loginBtn.disabled = false;
    loginBtn.querySelector('.btn-text').textContent = 'Log In';
  }
});

/* Signup */
signupForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const email = document.getElementById('signup-email').value.trim();
  const pw = document.getElementById('signup-password').value;
  const conf = document.getElementById('signup-confirm').value;
  let ok = true;
  if(!validEmail(email)){ showErr('signup-email-error','Enter a valid email.'); ok=false; } else showErr('signup-email-error','');
  if(pw.length<8){ showErr('signup-password-error','At least 8 characters.'); ok=false; } else showErr('signup-password-error','');
  if(conf!==pw){ showErr('signup-confirm-error','Passwords do not match.'); ok=false; } else showErr('signup-confirm-error','');
  if(!ok) return;
  signupBtn.disabled = true;
  signupBtn.querySelector('.btn-text').textContent = 'Creating...';
  setGlobalStatus();
  try {
    await signupWithEmail(email,pw);
    setGlobalStatus('Account created! Redirecting...','ok');
    setTimeout(()=> location.replace('home.html'), 550);
  } catch(err){
    setGlobalStatus(friendlyError(err),'err');
    signupBtn.disabled = false;
    signupBtn.querySelector('.btn-text').textContent = 'Create Account';
  }
});

/* Forgot password */
forgotLink.addEventListener('click', e=>{
  e.preventDefault();
  forgotPanel.hidden = false;
  forgotPanel.classList.add('active');
  document.getElementById('forgot-email').focus();
});
closeForgot.addEventListener('click', e=>{
  e.preventDefault();
  forgotPanel.hidden = true;
  forgotPanel.classList.remove('active');
  forgotStatus.textContent='';
  forgotStatus.className='status-line';
});
forgotForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const email = document.getElementById('forgot-email').value.trim();
  if(!validEmail(email)){
    document.getElementById('forgot-email-error').textContent = 'Valid email required.';
    return;
  } else {
    document.getElementById('forgot-email-error').textContent = '';
  }
  forgotBtn.disabled = true;
  forgotBtn.querySelector('.btn-text').textContent = 'Sending...';
  forgotStatus.textContent='';
  forgotStatus.className='status-line';
  try {
    await sendPasswordResetEmail(auth, email);
    forgotStatus.textContent='Reset link sent (check inbox / spam).';
    forgotStatus.className='status-line ok';
  } catch(err){
    forgotStatus.textContent = friendlyError(err);
    forgotStatus.className='status-line err';
  } finally {
    forgotBtn.disabled=false;
    forgotBtn.querySelector('.btn-text').textContent='Send Reset Link';
  }
});

/* Redirect if authenticated already */
onAuthStateChanged(auth, user=>{
  if(user) location.replace('home.html');
});
</script>
</body>
</html>