<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="color-scheme" content="light dark">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth - Notes-U</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light:#f8f8f8; --text-light:#333; --text2-light:#666;
      --bg-dark:#121212; --text-dark:#eee; --text2-dark:#aaa;
      --card-light:#fff; --card-dark:#1d1d1d;
      --border-light:rgba(0,0,0,0.12); --border-dark:rgba(255,255,255,0.12);
      --accent:#0d6efd; --accent-hover:#0b5ed7;
      --error:#d33;
    }
    body {
      font-family:'Inter',system-ui,Arial,sans-serif;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:var(--bg-light); color:var(--text-light); transition:background .3s,color .3s;
    }
    body.dark { background:var(--bg-dark); color:var(--text-dark); }
    .container {
      width:100%; max-width:440px; background:var(--card-light); padding:40px 34px;
      border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.08); box-sizing:border-box;
    }
    body.dark .container { background:var(--card-dark); box-shadow:0 8px 30px rgba(0,0,0,.4); }
    .logo {
      font-size:2.6rem; font-weight:700; display:flex; align-items:center; justify-content:center;
      width:72px; height:72px; margin:0 auto 20px; border:2px solid currentColor; border-radius:14px;
    }
    h1 { font-size:1.8rem; margin:0 0 6px; }
    p.lead { margin:0 0 28px; font-size:.95rem; color:var(--text2-light); }
    body.dark p.lead { color:var(--text2-dark); }
    label { display:block; font-weight:500; margin:0 0 6px; }
    input {
      width:100%; padding:12px 14px; font-size:1rem; border:1px solid var(--border-light);
      border-radius:8px; background:#fff; box-sizing:border-box;
    }
    body.dark input { background:#222; border-color:var(--border-dark); color:var(--text-dark); }
    input:focus { outline:2px solid var(--accent); outline-offset:2px; }
    .submit-button {
      width:100%; padding:14px 18px; margin-top:8px;
      border:none; border-radius:8px; font-size:1rem; font-weight:600;
      cursor:pointer; background:var(--accent); color:#fff; transition:background .2s;
    }
    .submit-button:hover { background:var(--accent-hover); }
    .switch-link {
      display:block; text-align:center; margin-top:20px; text-decoration:none;
      font-size:.9rem; color:var(--accent);
    }
    .switch-link:hover { text-decoration:underline; }
    .auth-form { display:none; }
    .auth-form.active { display:block; }
    .error-inline { color:var(--error); font-size:.8rem; margin-top:4px; display:none; }
    @media (max-width:560px){
      .container { margin:16px; padding:32px 26px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="logo" aria-label="Notes-U Logo">U</div>
    <h1 id="auth-title"></h1>
    <p class="lead" id="auth-description"></p>

    <div id="login-form" class="auth-form" aria-labelledby="auth-title">
      <form autocomplete="off" novalidate>
        <label for="login-username">Username</label>
        <input id="login-username" type="text" required placeholder="Enter your username" inputmode="text">
        <span class="error-inline" id="login-user-err"></span>

        <label for="login-access-code" style="margin-top:16px;">Access Code</label>
        <input id="login-access-code" type="password" required placeholder="Enter your access code">
        <span class="error-inline" id="login-pass-err"></span>

        <button type="submit" class="submit-button" id="login-btn">Log In</button>
      </form>
      <a href="auth.html?mode=signup" class="switch-link">Don't have an account? Create one now</a>
    </div>

    <div id="signup-form" class="auth-form" aria-labelledby="auth-title">
      <form autocomplete="off" novalidate>
        <label for="signup-username">Username</label>
        <input id="signup-username" type="text" required placeholder="Choose a username (a-z, 0-9, . _ -)">
        <span class="error-inline" id="signup-user-err"></span>

        <label for="signup-access-code" style="margin-top:16px;">Create Access Code</label>
        <input id="signup-access-code" type="password" required placeholder="Min 8 characters">
        <span class="error-inline" id="signup-pass-err"></span>

        <label for="signup-confirm-access-code" style="margin-top:16px;">Confirm Access Code</label>
        <input id="signup-confirm-access-code" type="password" required placeholder="Re-enter access code">
        <span class="error-inline" id="signup-confirm-err"></span>

        <button type="submit" class="submit-button" id="signup-btn">Sign Up</button>
      </form>
      <a href="auth.html?mode=login" class="switch-link">Already have an account? Log In instead</a>
    </div>
  </div>

  <script type="module">
    import { signupWithUsername, loginWithUsername, onAuth } from './firebase-init.js';

    // Theme (light: default unless user pref stored)
    function setTheme(isDark){
      document.body.classList.toggle('dark', !!isDark);
    }
    (function initTheme(){
      const stored = localStorage.getItem('theme');
      if(stored==='dark') setTheme(true);
      else if(stored==='light') setTheme(false);
      else setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
        if(!localStorage.getItem('theme')) setTheme(e.matches);
      });
    })();

    const params = new URLSearchParams(location.search);
    const mode = params.get('mode') === 'signup' ? 'signup' : 'login';

    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const authTitle = document.getElementById('auth-title');
    const authDesc = document.getElementById('auth-description');

    function applyMode(m){
      if(m==='signup'){
        signupForm.classList.add('active');
        loginForm.classList.remove('active');
        authTitle.textContent='Create Your Account';
        authDesc.textContent='Sign up to start uploading and managing your notes.';
      } else {
        loginForm.classList.add('active');
        signupForm.classList.remove('active');
        authTitle.textContent='Welcome Back';
        authDesc.textContent='Log in to access and manage your academic notes.';
      }
    }
    applyMode(mode);

    // Helpers
    function showErr(id,msg){
      const el = document.getElementById(id);
      if(el){ el.textContent = msg || ''; el.style.display = msg ? 'block':'none'; }
    }

    // Login
    loginForm.querySelector('form').addEventListener('submit', async e=>{
      e.preventDefault();
      const u = document.getElementById('login-username').value.trim();
      const p = document.getElementById('login-access-code').value;
      showErr('login-user-err','');
      showErr('login-pass-err','');
      if(!u){ showErr('login-user-err','Username required'); return; }
      if(!p){ showErr('login-pass-err','Access code required'); return; }
      const btn = document.getElementById('login-btn');
      btn.disabled=true; btn.textContent='Logging in...';
      try {
        await loginWithUsername(u,p);
        location.href='home.html';
      } catch(err){
        alert(err.message || 'Login failed');
      } finally {
        btn.disabled=false; btn.textContent='Log In';
      }
    });

    // Signup
    signupForm.querySelector('form').addEventListener('submit', async e=>{
      e.preventDefault();
      const u = document.getElementById('signup-username').value.trim();
      const p = document.getElementById('signup-access-code').value;
      const c = document.getElementById('signup-confirm-access-code').value;
      showErr('signup-user-err','');
      showErr('signup-pass-err','');
      showErr('signup-confirm-err','');

      if(!u){ showErr('signup-user-err','Username required'); return; }
      if(p.length<8){ showErr('signup-pass-err','Minimum 8 characters'); return; }
      if(p!==c){ showErr('signup-confirm-err','Codes do not match'); return; }

      const btn = document.getElementById('signup-btn');
      btn.disabled=true; btn.textContent='Creating...';
      try {
        await signupWithUsername(u,p);
        alert('Account created. Please log in.');
        location.href='auth.html?mode=login';
      } catch(err){
        alert(err.message || 'Signup failed');
      } finally {
        btn.disabled=false; btn.textContent='Sign Up';
      }
    });

    // If already logged in you may auto-redirect:
    onAuth(user=>{
      if(user && mode==='login'){
        // location.href='home.html';
      }
    });

  </script>
</body>
</html>