rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return request.auth.uid == userId; }

    function isValidNote() {
      let data = request.resource.data;
      // Only validate required fields; avoid checking total field count to keep rules flexible
      return data.title is string
        && data.title.size() > 0
        && data.subject_code is string
        && data.file_url is string
        && data.uid == request.auth.uid;
    }

    match /users/{userId} {
      allow read, write: if isSignedIn() && isOwner(userId);
    }

    match /notes/{noteId} {
      // Anyone signed-in can read shared notes
      allow read: if isSignedIn();

      // Only owners can update or delete
      allow update, delete: if isSignedIn() && resource.data.uid == request.auth.uid;

      // Create must follow the schema
      allow create: if isSignedIn() && isValidNote();
    }

    match /subjects/{subjectId} {
      allow read: if true;
      allow write: if false;
    }
  }
}